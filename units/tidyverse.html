<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data Wrangling (Tidyverse and data.table)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-2eb2de9d08919211f8a1d749abb3db00.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../assets/styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../units/intro.html">Modules (a partial set)</a></li><li class="breadcrumb-item"><a href="../units/tidyverse.html">Data Wrangling</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Voleon R Bootcamp</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/paciorek/r-voleon-2025" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home / Schedule</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../prep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preparation</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Modules (a partial set)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Introduction (Module “0”)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Structures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/calculation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calculation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Programming</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/tidyverse.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Data Wrangling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Plotting (ggplot)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Analysis/Useful Packages</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#data-frame-manipulation-using-dplyr" id="toc-data-frame-manipulation-using-dplyr" class="nav-link" data-scroll-target="#data-frame-manipulation-using-dplyr">Data frame manipulation using <code>dplyr</code></a>
  <ul class="collapse">
  <li><a href="#selecting-columns-dplyrselect" id="toc-selecting-columns-dplyrselect" class="nav-link" data-scroll-target="#selecting-columns-dplyrselect">Selecting columns: <code>dplyr::select</code></a></li>
  <li><a href="#piping-with-dplyr" id="toc-piping-with-dplyr" class="nav-link" data-scroll-target="#piping-with-dplyr">Piping with <code>dplyr</code></a></li>
  <li><a href="#enter-the-pipe" id="toc-enter-the-pipe" class="nav-link" data-scroll-target="#enter-the-pipe">Enter the pipe…</a></li>
  <li><a href="#pipe-example" id="toc-pipe-example" class="nav-link" data-scroll-target="#pipe-example">Pipe example</a></li>
  <li><a href="#filtering-rows-dplyrfilter" id="toc-filtering-rows-dplyrfilter" class="nav-link" data-scroll-target="#filtering-rows-dplyrfilter">Filtering rows: <code>dplyr::filter</code></a></li>
  <li><a href="#dplyr-calculations-across-groups-split-apply-combine" id="toc-dplyr-calculations-across-groups-split-apply-combine" class="nav-link" data-scroll-target="#dplyr-calculations-across-groups-split-apply-combine"><code>dplyr</code> calculations across groups: split-apply-combine</a></li>
  <li><a href="#stratifying-dplyrgroup_by" id="toc-stratifying-dplyrgroup_by" class="nav-link" data-scroll-target="#stratifying-dplyrgroup_by">Stratifying: <code>dplyr::group_by</code></a></li>
  <li><a href="#reduction-operations-dplyrsummarize" id="toc-reduction-operations-dplyrsummarize" class="nav-link" data-scroll-target="#reduction-operations-dplyrsummarize">Reduction operations: <code>dplyr::summarize</code></a></li>
  <li><a href="#adding-columns-dplyrmutate" id="toc-adding-columns-dplyrmutate" class="nav-link" data-scroll-target="#adding-columns-dplyrmutate">Adding columns: <code>dplyr::mutate</code></a></li>
  <li><a href="#mutate-vs.-summarize" id="toc-mutate-vs.-summarize" class="nav-link" data-scroll-target="#mutate-vs.-summarize"><code>mutate</code> vs.&nbsp;<code>summarize</code></a></li>
  <li><a href="#sorting-dplyrarrange" id="toc-sorting-dplyrarrange" class="nav-link" data-scroll-target="#sorting-dplyrarrange">Sorting: <code>dplyr::arrange</code></a></li>
  <li><a href="#dplyr-take-aways" id="toc-dplyr-take-aways" class="nav-link" data-scroll-target="#dplyr-take-aways"><code>dplyr</code> take-aways</a></li>
  <li><a href="#dplyr-and-non-standard-evaluation" id="toc-dplyr-and-non-standard-evaluation" class="nav-link" data-scroll-target="#dplyr-and-non-standard-evaluation">dplyr and “non-standard evaluation”</a></li>
  </ul></li>
  <li><a href="#tidying-data" id="toc-tidying-data" class="nav-link" data-scroll-target="#tidying-data">Tidying data</a>
  <ul class="collapse">
  <li><a href="#wide-vs.-long-formats" id="toc-wide-vs.-long-formats" class="nav-link" data-scroll-target="#wide-vs.-long-formats">Wide vs.&nbsp;long formats</a></li>
  <li><a href="#tidying-the-gapminder-data" id="toc-tidying-the-gapminder-data" class="nav-link" data-scroll-target="#tidying-the-gapminder-data">Tidying the Gapminder data</a></li>
  <li><a href="#converting-to-long-format-tidyrpivot_longer" id="toc-converting-to-long-format-tidyrpivot_longer" class="nav-link" data-scroll-target="#converting-to-long-format-tidyrpivot_longer">Converting to long format: <code>tidyr::pivot_longer</code></a></li>
  <li><a href="#specifying-column-names-tidyrselect" id="toc-specifying-column-names-tidyrselect" class="nav-link" data-scroll-target="#specifying-column-names-tidyrselect">Specifying column names: <code>tidyr::select</code></a></li>
  <li><a href="#cleaning-column-names-tidyrseparate" id="toc-cleaning-column-names-tidyrseparate" class="nav-link" data-scroll-target="#cleaning-column-names-tidyrseparate">Cleaning column names: <code>tidyr::separate</code></a></li>
  <li><a href="#converting-to-wide-format-tidyrpivot_wider" id="toc-converting-to-wide-format-tidyrpivot_wider" class="nav-link" data-scroll-target="#converting-to-wide-format-tidyrpivot_wider">Converting to wide format: <code>tidyr::pivot_wider</code></a></li>
  <li><a href="#extra-resources" id="toc-extra-resources" class="nav-link" data-scroll-target="#extra-resources">Extra Resources</a></li>
  </ul></li>
  <li><a href="#data.table-intro" id="toc-data.table-intro" class="nav-link" data-scroll-target="#data.table-intro">data.table: intro</a>
  <ul class="collapse">
  <li><a href="#data.table-syntax" id="toc-data.table-syntax" class="nav-link" data-scroll-target="#data.table-syntax">data.table syntax</a></li>
  <li><a href="#using-dplyr-syntax-with-data.table" id="toc-using-dplyr-syntax-with-data.table" class="nav-link" data-scroll-target="#using-dplyr-syntax-with-data.table">Using dplyr syntax with data.table</a></li>
  <li><a href="#working-with-data-on-disk" id="toc-working-with-data-on-disk" class="nav-link" data-scroll-target="#working-with-data-on-disk">Working with data on disk</a></li>
  </ul></li>
  <li><a href="#databases" id="toc-databases" class="nav-link" data-scroll-target="#databases">Databases</a></li>
  <li><a href="#database-example" id="toc-database-example" class="nav-link" data-scroll-target="#database-example">Database example</a></li>
  <li><a href="#breakout" id="toc-breakout" class="nav-link" data-scroll-target="#breakout">Breakout</a>
  <ul class="collapse">
  <li><a href="#dplyr" id="toc-dplyr" class="nav-link" data-scroll-target="#dplyr"><code>dplyr</code></a></li>
  <li><a href="#tidyr" id="toc-tidyr" class="nav-link" data-scroll-target="#tidyr"><code>tidyr</code></a></li>
  <li><a href="#data.table" id="toc-data.table" class="nav-link" data-scroll-target="#data.table"><code>data.table</code></a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../units/intro.html">Modules (a partial set)</a></li><li class="breadcrumb-item"><a href="../units/tidyverse.html">Data Wrangling</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Data Wrangling (Tidyverse and data.table)</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level1">
<h1>Overview</h1>
<p>A lot of analysis time in many cases is spent on manipulating tabular data. The tidyverse provides a nice suite of packages for doing this.</p>
<p>The <a href="https://www.tidyverse.org/"><code>tidyverse</code></a> is a suite of packages designed specifically to help with both these steps; some of which we will be introducing in this module. These are by no means the only packages out there for data wrangling but they are popular for their readable, straightforward syntax and sensible default behaviors.</p>
<p>An alternative for working quickly with very large datasets is the <code>data.table</code> package. It’s fast and a good choice. While the core syntax is not as nice, one can also use dplyr syntax with data.table objects.</p>
</section>
<section id="data-frame-manipulation-using-dplyr" class="level1">
<h1>Data frame manipulation using <code>dplyr</code></h1>
<p>Luckily, the <a href="https://cran.r-project.org/web/packages/dplyr/dplyr.pdf"><code>dplyr</code></a> package provides a number of very useful functions for manipulating data frames. These functions will save you time and hassle by reducing repetition, and will help to make your code more human-readable (trust me: your future self and others might thank you!)</p>
<p>Here we’re going to cover 6 of the most commonly used functions as well as using pipes (<code>%&gt;%</code>) to combine them.</p>
<ol type="1">
<li><code>select()</code></li>
<li><code>filter()</code></li>
<li><code>group_by()</code></li>
<li><code>summarize()</code></li>
<li><code>mutate()</code></li>
<li><code>arrange()</code></li>
</ol>
<section id="selecting-columns-dplyrselect" class="level2">
<h2 class="anchored" data-anchor-id="selecting-columns-dplyrselect">Selecting columns: <code>dplyr::select</code></h2>
<p>Imagine that we just received the gapminder dataset, but are only interested in a few variables in it. The <code>select()</code> function can help us to keep only the columns corresponding to variables we select.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>year_country_gdp_dplyr <span class="ot">&lt;-</span> <span class="fu">select</span>(gapminder, year, country, gdpPercap)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(year_country_gdp_dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
   year country     gdpPercap
  &lt;int&gt; &lt;fct&gt;           &lt;dbl&gt;
1  1952 Afghanistan      779.
2  1957 Afghanistan      821.
3  1962 Afghanistan      853.
4  1967 Afghanistan      836.
5  1972 Afghanistan      740.
6  1977 Afghanistan      786.</code></pre>
</div>
</div>
<p><img src="img/dplyr-fig1.png" class="img-fluid"></p>
<p>We see the new dataframe only contains the year, country and gdpPercap. This is equivalent to the base R subsetting operator:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>year_country_gdp_base <span class="ot">&lt;-</span> gapminder[ , <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"country"</span>, <span class="st">"gdpPercap"</span>)]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(year_country_gdp_base)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
   year country     gdpPercap
  &lt;int&gt; &lt;fct&gt;           &lt;dbl&gt;
1  1952 Afghanistan      779.
2  1957 Afghanistan      821.
3  1962 Afghanistan      853.
4  1967 Afghanistan      836.
5  1972 Afghanistan      740.
6  1977 Afghanistan      786.</code></pre>
</div>
</div>
<p>But, as we will see, <code>dplyr</code> makes for much more readable, efficient code because of its <em>pipe</em> operator.</p>
</section>
<section id="piping-with-dplyr" class="level2">
<h2 class="anchored" data-anchor-id="piping-with-dplyr">Piping with <code>dplyr</code></h2>
<p>Above, we used what’s called “normal” grammar, but the strengths of <code>dplyr</code> lie in combining several functions using <em>pipes</em>.</p>
<p>In typical base R code, a simple operation might be written like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NOT run</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>cupcakes <span class="ot">&lt;-</span> <span class="fu">bake</span>(<span class="fu">pour</span>(<span class="fu">mix</span>(ingredients)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A computer has no trouble understanding this and your cupcakes will be made just fine but a person has to read right to left to understand the order of operations - the opposite of how most western languages are read - making it harder to understand what is being done!</p>
<p>To be more readable without pipes, we might break up this code into intermediate objects…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NOT run</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>batter <span class="ot">&lt;-</span> <span class="fu">mix</span>(ingredients)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>muffin_tin <span class="ot">&lt;-</span> <span class="fu">pour</span>(batter)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>cupcakes <span class="ot">&lt;-</span> <span class="fu">bake</span>(muffin_tin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>but this can clutter our environment with a lot of variables that aren’t very useful to us, and often are named very similar things (e.g.&nbsp;step, step1, step2…) which can lead to confusion and bugs.</p>
</section>
<section id="enter-the-pipe" class="level2">
<h2 class="anchored" data-anchor-id="enter-the-pipe">Enter the pipe…</h2>
<p>The <em>pipe</em> makes it easier to read code because it lays out the operations left to right so each line can be read like a line of a recipe for the perfect data frame!</p>
<p>Pipes take the input on the left side of the <code>|&gt;</code> symbol and pass it in as the first argument to the function on the right side.</p>
<p>With pipes, our cupcake example might be written like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>cupcakes <span class="ot">&lt;-</span> ingredients <span class="sc">|&gt;</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mix</span>() <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pour</span>() <span class="sc">|&gt;</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pipe-example" class="level2">
<h2 class="anchored" data-anchor-id="pipe-example">Pipe example</h2>
<p>Let’s repeat what we did above with the gapminder dataset using pipes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>year_country_gdp <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span> <span class="fu">select</span>(year, country, gdpPercap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, we summon the gapminder data frame and pass it on to the next step using the pipe symbol <code>|&gt;</code>. The second step is the <code>select()</code> function. In this case we don’t specify which data object we use in the call to <code>select()</code> since we’ve piped it in.</p>
<p>Note that lack of quotations around the column names. This is called “non-standard evaluation” and is used a lot in the tidyverse (including in ggplot).</p>
</section>
<section id="filtering-rows-dplyrfilter" class="level2">
<h2 class="anchored" data-anchor-id="filtering-rows-dplyrfilter">Filtering rows: <code>dplyr::filter</code></h2>
<p>Now let’s say we’re only interested in African countries. We can combine <code>select</code> and <code>filter</code> to select only the observations where <code>continent</code> is <code>Africa</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>year_country_gdp_africa <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(continent <span class="sc">==</span> <span class="st">"Africa"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(year,country,gdpPercap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As with last time, first we pass the gapminder data frame to the <code>filter()</code> function, then we pass the filtered version of the gapminder data frame to the <code>select()</code> function.</p>
<p><strong>Note:</strong> The order of operations is important in this case. If we used ‘select’ first, filter would not be able to find the variable <code>continent</code> since we would have removed it in the previous step.</p>
</section>
<section id="dplyr-calculations-across-groups-split-apply-combine" class="level2">
<h2 class="anchored" data-anchor-id="dplyr-calculations-across-groups-split-apply-combine"><code>dplyr</code> calculations across groups: split-apply-combine</h2>
<p>A common task you’ll encounter when working with data is running calculations on different groups within the data. For instance, what if we wanted to calculate the mean GDP per capita for each continent?</p>
<p>This general task is known as “split-apply-combine”:</p>
<p><img src="img/splitapply.png" class="img-fluid"></p>
<p>We want to <em>split</em> our data into groups (in this case continents), <em>apply</em> some calculations on each group, then <em>combine</em> the results together afterwards.</p>
</section>
<section id="stratifying-dplyrgroup_by" class="level2">
<h2 class="anchored" data-anchor-id="stratifying-dplyrgroup_by">Stratifying: <code>dplyr::group_by</code></h2>
<p>We’ve already seen how <code>filter()</code> can help us select observations that meet certain criteria (in the above: <code>continent == "Europe"</code>). More helpful, however, is the <code>group_by()</code> function, which will essentially use every unique criteria that we could have used in <code>filter()</code>.</p>
<p>A <code>grouped_df</code> can be thought of as a <code>list</code> where each item in the <code>list</code> is a <code>data.frame</code> which contains only the rows that correspond to a particular value of one or more grouping variables (<code>continent</code> in our example).</p>
<p><img src="img/dplyr-fig2.png" class="img-fluid"></p>
</section>
<section id="reduction-operations-dplyrsummarize" class="level2">
<h2 class="anchored" data-anchor-id="reduction-operations-dplyrsummarize">Reduction operations: <code>dplyr::summarize</code></h2>
<p><code>group_by()</code> on its own is not particularly interesting; instead it’s generally used with <code>summarize()</code>.</p>
<p>This will allow use to create new variable(s) by applying transformations to variables in each of the continent-specific data frames.</p>
<p>In other words, using the <code>group_by()</code> function, we split our original data frame into multiple pieces, which we then apply summary functions to (e.g., <code>mean()</code> or <code>sd()</code>) within <code>summarize()</code>. The output is a new data frame reduced in size, with one row per group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>gdp_bycontinents <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gdp_bycontinents)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  continent mean_gdpPercap
  &lt;fct&gt;              &lt;dbl&gt;
1 Africa             2194.
2 Americas           7136.
3 Asia               7902.
4 Europe            14469.
5 Oceania           18622.</code></pre>
</div>
</div>
<p><img src="img/dplyr-fig3.png" class="img-fluid"></p>
<p>That allowed us to calculate the mean gdpPercap for each continent. But it gets even better – the function <code>group_by()</code> allows us to group by multiple variables. Let’s group by <code>year</code> and <code>continent</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>gdp_bycontinents_byyear <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'continent'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gdp_bycontinents_byyear)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
# Groups:   continent [1]
  continent  year mean_gdpPercap
  &lt;fct&gt;     &lt;int&gt;          &lt;dbl&gt;
1 Africa     1952          1253.
2 Africa     1957          1385.
3 Africa     1962          1598.
4 Africa     1967          2050.
5 Africa     1972          2340.
6 Africa     1977          2586.</code></pre>
</div>
</div>
<p>You’re not limited to defining one new variable in <code>summarize()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>gdp_pop_bycontinents_byyear <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdpPercap =</span> <span class="fu">sd</span>(gdpPercap),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_pop =</span> <span class="fu">mean</span>(pop),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_pop =</span> <span class="fu">sd</span>(pop))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'continent'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gdp_pop_bycontinents_byyear)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
# Groups:   continent [1]
  continent  year mean_gdpPercap sd_gdpPercap mean_pop    sd_pop
  &lt;fct&gt;     &lt;int&gt;          &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 Africa     1952          1253.         983. 4570010.  6317450.
2 Africa     1957          1385.        1135. 5093033.  7076042.
3 Africa     1962          1598.        1462. 5702247.  7957545.
4 Africa     1967          2050.        2848. 6447875.  8985505.
5 Africa     1972          2340.        3287. 7305376. 10130833.
6 Africa     1977          2586.        4142. 8328097. 11585184.</code></pre>
</div>
</div>
</section>
<section id="adding-columns-dplyrmutate" class="level2">
<h2 class="anchored" data-anchor-id="adding-columns-dplyrmutate">Adding columns: <code>dplyr::mutate</code></h2>
<p>What if we wanted to add these values to our original data frame instead of creating a new object? For this, we can use the <code>mutate()</code> function, which is similar to <code>summarize()</code> except it creates new variables in the same data frame that you pass into it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>gap_with_extra_vars <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap),</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdpPercap =</span> <span class="fu">sd</span>(gdpPercap),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_pop =</span> <span class="fu">mean</span>(pop),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_pop =</span> <span class="fu">sd</span>(pop))</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_with_extra_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 10
# Groups:   continent, year [6]
  country   continent  year lifeExp    pop gdpPercap mean_gdpPercap sd_gdpPercap
  &lt;fct&gt;     &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;  &lt;int&gt;     &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;
1 Afghanis… Asia       1952    28.8 8.43e6      779.          5195.       18635.
2 Afghanis… Asia       1957    30.3 9.24e6      821.          5788.       19507.
3 Afghanis… Asia       1962    32.0 1.03e7      853.          5729.       16416.
4 Afghanis… Asia       1967    34.0 1.15e7      836.          5971.       14063.
5 Afghanis… Asia       1972    36.1 1.31e7      740.          8187.       19088.
6 Afghanis… Asia       1977    38.4 1.49e7      786.          7791.       11816.
# ℹ 2 more variables: mean_pop &lt;dbl&gt;, sd_pop &lt;dbl&gt;</code></pre>
</div>
</div>
<p>We can use also use <code>mutate()</code> to create new variables prior to (or even after) summarizing information. Note that <code>mutate()</code> does not need to operate on grouped data and it can do element-wise transformations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>gdp_pop_bycontinents_byyear <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gdp_billion =</span> gdpPercap<span class="sc">*</span>pop<span class="sc">/</span><span class="dv">10</span><span class="sc">^</span><span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdpPercap =</span> <span class="fu">sd</span>(gdpPercap),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_pop =</span> <span class="fu">mean</span>(pop),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_pop =</span> <span class="fu">sd</span>(pop),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_gdp_billion =</span> <span class="fu">mean</span>(gdp_billion),</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdp_billion =</span> <span class="fu">sd</span>(gdp_billion))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'continent'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gdp_pop_bycontinents_byyear)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
# Groups:   continent [1]
  continent  year mean_gdpPercap sd_gdpPercap mean_pop   sd_pop mean_gdp_billion
  &lt;fct&gt;     &lt;int&gt;          &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;            &lt;dbl&gt;
1 Africa     1952          1253.         983. 4570010.   6.32e6             5.99
2 Africa     1957          1385.        1135. 5093033.   7.08e6             7.36
3 Africa     1962          1598.        1462. 5702247.   7.96e6             8.78
4 Africa     1967          2050.        2848. 6447875.   8.99e6            11.4 
5 Africa     1972          2340.        3287. 7305376.   1.01e7            15.1 
6 Africa     1977          2586.        4142. 8328097.   1.16e7            18.7 
# ℹ 1 more variable: sd_gdp_billion &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="mutate-vs.-summarize" class="level2">
<h2 class="anchored" data-anchor-id="mutate-vs.-summarize"><code>mutate</code> vs.&nbsp;<code>summarize</code></h2>
<p>It can be confusing to decide whether to use <code>mutate</code> or <code>summarize</code>. The key distinction is whether you want the output to have one row for each group or one row for each row in the original data frame:</p>
<ul>
<li><code>mutate</code>: creates new columns with as many rows as the original data frame</li>
<li><code>summarize</code>: creates a data frame with as many rows as groups</li>
</ul>
<p>Note that if you use an aggregation function such as <code>mean()</code> within <code>mutate()</code> without using <code>groupby()</code>, you’ll simply do the summary over all the rows of the input data frame.</p>
<p>And if you use an aggregation function such as <code>mean()</code> within <code>summarize()</code> without using <code>groupby()</code>, you’ll simply create an output data frame with one row (i.e., the whole input data frame is a single group).</p>
</section>
<section id="sorting-dplyrarrange" class="level2">
<h2 class="anchored" data-anchor-id="sorting-dplyrarrange">Sorting: <code>dplyr::arrange</code></h2>
<p>As a last step, let’s say we want to sort the rows in our data frame according to values in a certain column. We can use the <code>arrange()</code> function to do this. For instance, let’s organize our rows by <code>year</code> (recent first), and then by <code>continent</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>gap_with_extra_vars <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdpPercap =</span> <span class="fu">sd</span>(gdpPercap),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_pop =</span> <span class="fu">mean</span>(pop),</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_pop =</span> <span class="fu">sd</span>(pop)) <span class="sc">|&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(year), continent) <span class="co"># `desc()` = descending order</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_with_extra_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 10
# Groups:   continent, year [1]
  country   continent  year lifeExp    pop gdpPercap mean_gdpPercap sd_gdpPercap
  &lt;fct&gt;     &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;  &lt;int&gt;     &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;
1 Algeria   Africa     2007    72.3 3.33e7     6223.          3089.        3618.
2 Angola    Africa     2007    42.7 1.24e7     4797.          3089.        3618.
3 Benin     Africa     2007    56.7 8.08e6     1441.          3089.        3618.
4 Botswana  Africa     2007    50.7 1.64e6    12570.          3089.        3618.
5 Burkina … Africa     2007    52.3 1.43e7     1217.          3089.        3618.
6 Burundi   Africa     2007    49.6 8.39e6      430.          3089.        3618.
# ℹ 2 more variables: mean_pop &lt;dbl&gt;, sd_pop &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="dplyr-take-aways" class="level2">
<h2 class="anchored" data-anchor-id="dplyr-take-aways"><code>dplyr</code> take-aways</h2>
<ul>
<li>Human readable: the function names describe the action being done</li>
<li>Piping: chain functions in a step-by-step way, rather than nesting</li>
</ul>
</section>
<section id="dplyr-and-non-standard-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="dplyr-and-non-standard-evaluation">dplyr and “non-standard evaluation”</h2>
<p>You may run across the term “non-standard evaluation”. The use of data frame variables without quotes around them is an example of this.</p>
<p>Why is this strange?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">|&gt;</span> <span class="fu">select</span>(continent, year) <span class="sc">|&gt;</span> <span class="fu">tail</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compare it to:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>gapminder[ , <span class="fu">c</span>(<span class="st">'continent'</span>, <span class="st">'year'</span>)]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>gapminder[ , <span class="st">'continent'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because <code>continent</code> and <code>year</code> are not variables our current environment! dplyr does some manipulation of language objects behind the scenes to save us from typing the quotes.</p>
<p>This is fine if you have a data analysis workflow but if you want to write a function that, for example, selects an arbitrary set of columns, you’ll run into trouble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="do">## here's a helper function that computes the mean of a variable, stratifying by a grouping variable</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>grouped_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(data, group_var, summary_var) {</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">|&gt;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group_var) <span class="sc">|&gt;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(summary_var))</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">|&gt;</span> <span class="fu">grouped_mean</span>(continent, lifeExp)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">|&gt;</span> <span class="fu">grouped_mean</span>(<span class="st">'continent'</span>, <span class="st">'lifeExp'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>See the <code>rlang</code> (or <code>wrapr</code>) package for how one can deal with this problem in this context of using functions.</p>
</section>
</section>
<section id="tidying-data" class="level1">
<h1>Tidying data</h1>
<p>Even before we conduct analysis or calculations, we need to put our data into the correct format. The goal here is to rearrange a messy dataset into one that is <strong>tidy</strong>.</p>
<p>The two most important properties of tidy data are:</p>
<ol type="1">
<li>Each column is a variable.</li>
<li>Each row is an observation.</li>
</ol>
<p>Tidy data is easier to work with, because you have a consistent way of referring to variables (as column names) and observations (as row indices). It then becomes easy to manipulate, visualize, and model.</p>
<p>For more on the concept of <em>tidy</em> data, you can read <a href="http://vita.had.co.nz/papers/tidy-data.html">Hadley Wickham’s paper</a>.</p>
<section id="wide-vs.-long-formats" class="level2">
<h2 class="anchored" data-anchor-id="wide-vs.-long-formats">Wide vs.&nbsp;long formats</h2>
<p>Tabular datasets can be arranged in many ways. For instance, consider the data below. Each data set displays information on heart rate observed in individuals across 3 different time periods. But the data are organized differently in each table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>wide <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Wilbur"</span>, <span class="st">"Petunia"</span>, <span class="st">"Gregory"</span>),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">time1 =</span> <span class="fu">c</span>(<span class="dv">67</span>, <span class="dv">80</span>, <span class="dv">64</span>),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">time2 =</span> <span class="fu">c</span>(<span class="dv">56</span>, <span class="dv">90</span>, <span class="dv">50</span>),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">time3 =</span> <span class="fu">c</span>(<span class="dv">70</span>, <span class="dv">67</span>, <span class="dv">101</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>wide</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     name time1 time2 time3
1  Wilbur    67    56    70
2 Petunia    80    90    67
3 Gregory    64    50   101</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>long <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Wilbur"</span>, <span class="st">"Petunia"</span>, <span class="st">"Gregory"</span>, <span class="st">"Wilbur"</span>, <span class="st">"Petunia"</span>, <span class="st">"Gregory"</span>, <span class="st">"Wilbur"</span>, <span class="st">"Petunia"</span>, <span class="st">"Gregory"</span>),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">heartrate =</span> <span class="fu">c</span>(<span class="dv">67</span>, <span class="dv">80</span>, <span class="dv">64</span>, <span class="dv">56</span>, <span class="dv">90</span>, <span class="dv">50</span>, <span class="dv">70</span>, <span class="dv">67</span>, <span class="dv">10</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>long</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     name time heartrate
1  Wilbur    1        67
2 Petunia    1        80
3 Gregory    1        64
4  Wilbur    2        56
5 Petunia    2        90
6 Gregory    2        50
7  Wilbur    3        70
8 Petunia    3        67
9 Gregory    3        10</code></pre>
</div>
</div>
<p>We often refer to these different structures as “long” vs.&nbsp;“wide” formats. In the “long” format, you usually have 1 column for the observed variable and the other columns are ID variables.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Which of the ‘wide’ and ‘long’ objects do you prefer in terms of how the heartrate ‘data’ are formatted?</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Answer">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The first data frame (the “wide” one) would not be considered <em>tidy</em> because values (i.e., heartrate) are spread across multiple columns.</p>
</div>
</div>
</div>
<p>For the “wide” format each row is often a site/subject/patient and you have multiple observation variables containing the same type of data. These can be either repeated observations over time, or observation of multiple variables (or a mix of both). In the above case, we had the same kind of data (heart rate) entered across 3 different columns, corresponding to three different time periods.</p>
<p><img src="img/tidyr-fig1.png" class="img-fluid"></p>
<p>You may find data input may be simpler and some programs/functions may prefer the “wide” format. However, many of R’s functions (particularly in the tidyverse) have been designed assuming you have “long” format data.</p>
</section>
<section id="tidying-the-gapminder-data" class="level2">
<h2 class="anchored" data-anchor-id="tidying-the-gapminder-data">Tidying the Gapminder data</h2>
<p>Lets look at the structure of our original gapminder data frame:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gapminder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  country     continent  year lifeExp      pop gdpPercap
  &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
1 Afghanistan Asia       1952    28.8  8425333      779.
2 Afghanistan Asia       1957    30.3  9240934      821.
3 Afghanistan Asia       1962    32.0 10267083      853.
4 Afghanistan Asia       1967    34.0 11537966      836.
5 Afghanistan Asia       1972    36.1 13079460      740.
6 Afghanistan Asia       1977    38.4 14880372      786.</code></pre>
</div>
</div>
<p><strong>Question</strong>: Is this data frame <strong>wide</strong> or <strong>long</strong>?</p>
<p><strong>Answer</strong>: This data frame is somewhere in between the purely ‘long’ and ‘wide’ formats. We have 3 “ID variables” (<code>continent</code>, <code>country</code>, <code>year</code>) and 3 “Observation variables” (<code>pop</code>, <code>lifeExp</code>, <code>gdpPercap</code>).</p>
<p>Despite not having ALL observations in 1 column, this intermediate format makes sense given that all 3 observation variables have different units. As we have seen, many of the functions in R are often vector based, and you usually do not want to do mathematical operations on values with different units.</p>
<p>On the other hand, there are some instances in which a purely long or wide format is ideal (e.g.&nbsp;plotting). Likewise, sometimes you’ll get data on your desk that is poorly organized, and you’ll need to <strong>reshape</strong> it.</p>
</section>
<section id="converting-to-long-format-tidyrpivot_longer" class="level2">
<h2 class="anchored" data-anchor-id="converting-to-long-format-tidyrpivot_longer">Converting to long format: <code>tidyr::pivot_longer</code></h2>
<p>The <code>tidyr</code> package will help you efficiently transform your data regardless of original format.</p>
<p>Until now, we’ve been using the nicely formatted original gapminder data set. This data set is not quite wide and not quite long – it’s something in the middle, but “real” data (i.e., our own research data) will never be so well organized. Here let’s start with the wide format version of the gapminder data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>gap_wide <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">".."</span>, <span class="st">"data"</span>, <span class="st">"gapminder_wide.csv"</span>))</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_wide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  continent      country gdpPercap_1952 gdpPercap_1957 gdpPercap_1962
1    Africa      Algeria      2449.0082      3013.9760      2550.8169
2    Africa       Angola      3520.6103      3827.9405      4269.2767
3    Africa        Benin      1062.7522       959.6011       949.4991
4    Africa     Botswana       851.2411       918.2325       983.6540
5    Africa Burkina Faso       543.2552       617.1835       722.5120
6    Africa      Burundi       339.2965       379.5646       355.2032
  gdpPercap_1967 gdpPercap_1972 gdpPercap_1977 gdpPercap_1982 gdpPercap_1987
1      3246.9918      4182.6638      4910.4168      5745.1602      5681.3585
2      5522.7764      5473.2880      3008.6474      2756.9537      2430.2083
3      1035.8314      1085.7969      1029.1613      1277.8976      1225.8560
4      1214.7093      2263.6111      3214.8578      4551.1421      6205.8839
5       794.8266       854.7360       743.3870       807.1986       912.0631
6       412.9775       464.0995       556.1033       559.6032       621.8188
  gdpPercap_1992 gdpPercap_1997 gdpPercap_2002 gdpPercap_2007 lifeExp_1952
1      5023.2166      4797.2951      5288.0404      6223.3675       43.077
2      2627.8457      2277.1409      2773.2873      4797.2313       30.015
3      1191.2077      1232.9753      1372.8779      1441.2849       38.223
4      7954.1116      8647.1423     11003.6051     12569.8518       47.622
5       931.7528       946.2950      1037.6452      1217.0330       31.975
6       631.6999       463.1151       446.4035       430.0707       39.031
  lifeExp_1957 lifeExp_1962 lifeExp_1967 lifeExp_1972 lifeExp_1977 lifeExp_1982
1       45.685       48.303       51.407       54.518       58.014       61.368
2       31.999       34.000       35.985       37.928       39.483       39.942
3       40.358       42.618       44.885       47.014       49.190       50.904
4       49.618       51.520       53.298       56.024       59.319       61.484
5       34.906       37.814       40.697       43.591       46.137       48.122
6       40.533       42.045       43.548       44.057       45.910       47.471
  lifeExp_1987 lifeExp_1992 lifeExp_1997 lifeExp_2002 lifeExp_2007 pop_1952
1       65.799       67.744       69.152       70.994       72.301  9279525
2       39.906       40.647       40.963       41.003       42.731  4232095
3       52.337       53.919       54.777       54.406       56.728  1738315
4       63.622       62.745       52.556       46.634       50.728   442308
5       49.557       50.260       50.324       50.650       52.295  4469979
6       48.211       44.736       45.326       47.360       49.580  2445618
  pop_1957 pop_1962 pop_1967 pop_1972 pop_1977 pop_1982 pop_1987 pop_1992
1 10270856 11000948 12760499 14760787 17152804 20033753 23254956 26298373
2  4561361  4826015  5247469  5894858  6162675  7016384  7874230  8735988
3  1925173  2151895  2427334  2761407  3168267  3641603  4243788  4981671
4   474639   512764   553541   619351   781472   970347  1151184  1342614
5  4713416  4919632  5127935  5433886  5889574  6634596  7586551  8878303
6  2667518  2961915  3330989  3529983  3834415  4580410  5126023  5809236
  pop_1997 pop_2002 pop_2007
1 29072015 31287142 33333216
2  9875024 10866106 12420476
3  6066080  7026113  8078314
4  1536536  1630347  1639131
5 10352843 12251209 14326203
6  6121610  7021078  8390505</code></pre>
</div>
</div>
<p>The first step towards getting our nice intermediate data format is to first convert from the wide to the long format. The function <code>pivot_longer()</code> will ‘gather’ the observation variables into a single variable. This is sometimes called “melting” your data, because it melts the table from wide to long. Those data will be melted into two variables: one for the variable names, and the other for the variable values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>gap_long <span class="ot">&lt;-</span> gap_wide <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(gdpPercap_1952<span class="sc">:</span>pop_2007)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  continent country name           value
  &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 Africa    Algeria gdpPercap_1952 2449.
2 Africa    Algeria gdpPercap_1957 3014.
3 Africa    Algeria gdpPercap_1962 2551.
4 Africa    Algeria gdpPercap_1967 3247.
5 Africa    Algeria gdpPercap_1972 4183.
6 Africa    Algeria gdpPercap_1977 4910.</code></pre>
</div>
</div>
<p>Formerly one used the function <code>gather</code> to do this, but many people found it not to be intuitive to use.</p>
</section>
<section id="specifying-column-names-tidyrselect" class="level2">
<h2 class="anchored" data-anchor-id="specifying-column-names-tidyrselect">Specifying column names: <code>tidyr::select</code></h2>
<p>If there are a lot of columns or they’re named in a consistent pattern, we might not want to select them using the column numbers. It’d be easier to use some information contained in the names themselves. We can select variables using:</p>
<ul>
<li>variable indices</li>
<li>variable names (without quotes)</li>
<li><code>x:z</code> to select all variables between x and z</li>
<li><code>-y</code> to <em>exclude</em> y</li>
<li><code>starts_with(x, ignore.case = TRUE)</code>: all names that starts with <code>x</code></li>
<li><code>ends_with(x, ignore.case = TRUE)</code>: all names that ends with <code>x</code></li>
<li><code>contains(x, ignore.case = TRUE)</code>: all names that contain <code>x</code></li>
</ul>
<p>See the <code>select()</code> function in <code>dplyr</code> for more options.</p>
<p>For instance, here we do the same gather operation with (1) the <code>starts_with</code> function, and (2) the <code>-</code> operator:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with the starts_with() function</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>gap_long <span class="ot">&lt;-</span> gap_wide <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">'pop'</span>), <span class="fu">starts_with</span>(<span class="st">'lifeExp'</span>), <span class="fu">starts_with</span>(<span class="st">'gdpPercap'</span>)))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  continent country name        value
  &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt;
1 Africa    Algeria pop_1952  9279525
2 Africa    Algeria pop_1957 10270856
3 Africa    Algeria pop_1962 11000948
4 Africa    Algeria pop_1967 12760499
5 Africa    Algeria pop_1972 14760787
6 Africa    Algeria pop_1977 17152804</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with the - operator</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>gap_long <span class="ot">&lt;-</span> gap_wide <span class="sc">|&gt;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="sc">-</span>continent, <span class="sc">-</span>country))</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  continent country name           value
  &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 Africa    Algeria gdpPercap_1952 2449.
2 Africa    Algeria gdpPercap_1957 3014.
3 Africa    Algeria gdpPercap_1962 2551.
4 Africa    Algeria gdpPercap_1967 3247.
5 Africa    Algeria gdpPercap_1972 4183.
6 Africa    Algeria gdpPercap_1977 4910.</code></pre>
</div>
</div>
<p>However you choose to do it, notice that the output collapses all of the measure variables into two columns: one containing new ID variable, the other containing the observation value for that row.</p>
</section>
<section id="cleaning-column-names-tidyrseparate" class="level2">
<h2 class="anchored" data-anchor-id="cleaning-column-names-tidyrseparate">Cleaning column names: <code>tidyr::separate</code></h2>
<p>You’ll notice that in our long dataset, <code>name</code> actually contains 2 pieces of information, the observation type (<code>pop</code>, <code>lifeExp</code>, or <code>gdpPercap</code>) and the <code>year</code>.</p>
<p>We can use the <code>separate()</code> function to split the character strings into multiple variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>gap_long_sep <span class="ot">&lt;-</span> gap_long <span class="sc">|&gt;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">'obs_type'</span>,<span class="st">'year'</span>), <span class="at">sep =</span> <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_long_sep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  continent country obs_type   year value
  &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt;
1 Africa    Algeria gdpPercap  1952 2449.
2 Africa    Algeria gdpPercap  1957 3014.
3 Africa    Algeria gdpPercap  1962 2551.
4 Africa    Algeria gdpPercap  1967 3247.
5 Africa    Algeria gdpPercap  1972 4183.
6 Africa    Algeria gdpPercap  1977 4910.</code></pre>
</div>
</div>
<p>If you didn’t use <code>tidyr</code> to do this, you’d have to use the <code>strsplit</code> function and use multiple lines of code to replace the column in <code>gap_long</code> with two new columns. This solution is much cleaner.</p>
</section>
<section id="converting-to-wide-format-tidyrpivot_wider" class="level2">
<h2 class="anchored" data-anchor-id="converting-to-wide-format-tidyrpivot_wider">Converting to wide format: <code>tidyr::pivot_wider</code></h2>
<p>The opposite of <code>pivot_longer()</code> is <code>pivot_wider()</code>. It spreads our observation variables back out to make a wider table. We can use this function to spread our <code>gap_long()</code> to the original “medium” format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>gap_medium <span class="ot">&lt;-</span> gap_long_sep <span class="sc">|&gt;</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> obs_type, <span class="at">values_from =</span> value)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_medium)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  continent country  year gdpPercap lifeExp      pop
  &lt;chr&gt;     &lt;chr&gt;   &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
1 Africa    Algeria  1952     2449.    43.1  9279525
2 Africa    Algeria  1957     3014.    45.7 10270856
3 Africa    Algeria  1962     2551.    48.3 11000948
4 Africa    Algeria  1967     3247.    51.4 12760499
5 Africa    Algeria  1972     4183.    54.5 14760787
6 Africa    Algeria  1977     4910.    58.0 17152804</code></pre>
</div>
</div>
<p>Formerly one used the function <code>spread</code> to do this, but many people found it not to be intuitive to use.</p>
<p>All we need is some quick fixes to make this dataset identical to the original <code>gapminder</code> dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gapminder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  country     continent  year lifeExp      pop gdpPercap
  &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
1 Afghanistan Asia       1952    28.8  8425333      779.
2 Afghanistan Asia       1957    30.3  9240934      821.
3 Afghanistan Asia       1962    32.0 10267083      853.
4 Afghanistan Asia       1967    34.0 11537966      836.
5 Afghanistan Asia       1972    36.1 13079460      740.
6 Afghanistan Asia       1977    38.4 14880372      786.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rearrange columns</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>gap_medium <span class="ot">&lt;-</span> gap_medium[,<span class="fu">names</span>(gapminder)]</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_medium)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  country continent  year lifeExp      pop gdpPercap
  &lt;chr&gt;   &lt;chr&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 Algeria Africa     1952    43.1  9279525     2449.
2 Algeria Africa     1957    45.7 10270856     3014.
3 Algeria Africa     1962    48.3 11000948     2551.
4 Algeria Africa     1967    51.4 12760499     3247.
5 Algeria Africa     1972    54.5 14760787     4183.
6 Algeria Africa     1977    58.0 17152804     4910.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># arrange by country, continent, and year</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>gap_medium <span class="ot">&lt;-</span> gap_medium <span class="sc">|&gt;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(country, continent, year)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_medium)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  country     continent  year lifeExp      pop gdpPercap
  &lt;chr&gt;       &lt;chr&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 Afghanistan Asia       1952    28.8  8425333      779.
2 Afghanistan Asia       1957    30.3  9240934      821.
3 Afghanistan Asia       1962    32.0 10267083      853.
4 Afghanistan Asia       1967    34.0 11537966      836.
5 Afghanistan Asia       1972    36.1 13079460      740.
6 Afghanistan Asia       1977    38.4 14880372      786.</code></pre>
</div>
</div>
</section>
<section id="extra-resources" class="level2">
<h2 class="anchored" data-anchor-id="extra-resources">Extra Resources</h2>
<p><code>dplyr</code> and <code>tidyr</code> have many more functions to help you wrangle and manipulate your data. See the <a href="https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf">Data Wrangling Cheat Sheet</a> for more.</p>
<p>Here are <a href="https://www.r-bloggers.com/2022/07/eight-r-tidyverse-tips-for-everyday-data-engineering/?utm_source=phpList&amp;utm_medium=email&amp;utm_campaign=R-bloggers-daily&amp;utm_content=HTML">some additional functions/verbs</a> for use with dplyr:</p>
<p>There are some other useful packages in the <a href="http://www.tidyverse.org">tidyverse</a>:</p>
<ul>
<li><code>ggplot2</code> for plotting (We’ll cover this in Unit 5)</li>
<li><code>readr</code> and <code>haven</code> for reading in data</li>
<li><code>purrr</code> for working with lists and operations similar to the <code>lapply</code> family introduced in Module 4.</li>
<li><code>stringr</code>, <code>lubridate</code>, <code>forcats</code> for manipulating strings, dates, and factors, respectively</li>
<li>many many more! Take a peak at the <a href="https://github.com/tidyverse">tidyverse github page</a>…</li>
</ul>
</section>
</section>
<section id="data.table-intro" class="level1">
<h1>data.table: intro</h1>
<p>The <em>data.table</em> package provides a lot of functionality for fast manipulation of datasets in memory. data.table can do the standard SQL/dplyr operations such as indexing, merges/joins, assignment, grouping, etc. Plus data.table objects are data frames (i.e., they inherit from data frames) so they are compatible with R code that uses data frames.</p>
<p>If you’ve got enough memory, data.table can be effective with pretty large datasets (e.g., 10s of gigabytes).</p>
<p>Let’s read in a moderate size CSV with airline departure delay information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table, <span class="at">quietly =</span> <span class="cn">TRUE</span>, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(air <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>))) <span class="co"># 0.1 sec.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.629   0.016   0.283 </code></pre>
</div>
</div>
<p>We’ll compare the time for reading to <code>read.csv</code> and <code>readr::read_csv</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>col_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>,</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>               <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"character"</span>, <span class="st">"integer"</span>, <span class="st">"character"</span>,</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">"character"</span>, <span class="st">"character"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">"character"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>               <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(air <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>)))  <span class="co"># 5.6 sec.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  3.851   0.124   3.988 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(air <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>),</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">colClasses =</span> col_types))   <span class="co"># 1.5 sec.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  1.586   0.020   1.606 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(air <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>),</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">col_types =</span> <span class="st">"iiiiiiiiciciiiiicciiiiciiiiii"</span>))  <span class="co"># 0.9 sec.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  3.378   0.171   1.103 </code></pre>
</div>
</div>
<p>It doesn’t make much difference for that small-ish (50 MB) file, but <code>fread</code> should be fast for much larger files, including reading from zipped files or online files.</p>
<section id="data.table-syntax" class="level2">
<h2 class="anchored" data-anchor-id="data.table-syntax">data.table syntax</h2>
<p>Here’s some syntax examples:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter rows:</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>air[Dest <span class="sc">==</span> <span class="st">"BOS"</span> <span class="sc">&amp;</span> DepDelay <span class="sc">&gt;</span> <span class="dv">100</span>]</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Select columns:</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>air[ , <span class="fu">c</span>(<span class="st">"Dest"</span>, <span class="st">"DepDelay"</span>)]</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Mutate (create new columns):</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>air[ , DepDelayHr <span class="sc">:</span><span class="er">=</span> DepDelay <span class="sc">/</span> <span class="dv">60</span>]</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>air[ , .(<span class="at">meanDelayByDest =</span> <span class="fu">mean</span>(DepDelay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), by <span class="ot">=</span> Dest]</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Chaining operations (ugly!):</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>air[ , DepDelayHr <span class="sc">:</span><span class="er">=</span> DepDelay <span class="sc">/</span> <span class="dv">60</span>][ , .(<span class="at">meanDelayByDest =</span> <span class="fu">mean</span>(DepDelayHr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), by <span class="ot">=</span> Dest]</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Join:</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>air[another_dt, on <span class="ot">=</span> <span class="st">"keycolumn"</span>]</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort:</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>air[<span class="fu">order</span>(Dest, <span class="sc">-</span>DepDelay)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An important area for efficiency is to use an index, which can improve lookup speed dramatically. For this small dataset, everyting is fast already, so it’s not a good example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>air <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Subset without an index</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sub <span class="ot">&lt;-</span> air[Dest <span class="sc">==</span> <span class="st">"BOS"</span>])  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.031   0.000   0.015 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Now set index and subset</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">setindex</span>(air, Dest))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.014   0.000   0.004 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(sub2 <span class="ot">&lt;-</span> air[Dest <span class="sc">==</span> <span class="st">"BOS"</span>]) <span class="co"># essentially instantaneous</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.009   0.000   0.005 </code></pre>
</div>
</div>
<p>data.table has a lot of functionality and can be used to do a variety of sophisticated queries and manipulations (including aggregation operations), but it has its own somewhat involved syntax and concepts. The above just scratches the surface of what you can do with it.</p>
</section>
<section id="using-dplyr-syntax-with-data.table" class="level2">
<h2 class="anchored" data-anchor-id="using-dplyr-syntax-with-data.table">Using dplyr syntax with data.table</h2>
<p>Rather than learning the data.table syntax, one can also use dplyr syntax with data.table objects.</p>
<p>We can use dplyr syntax directly with data table objects, but the efficiency may not be what you want.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>air <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>))</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(result <span class="ot">&lt;-</span> air[ , .(<span class="at">meanDelayByDest =</span> <span class="fu">mean</span>(DepDelay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">by =</span> Dest])  <span class="co"># 0.008 sec.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.039   0.000   0.013 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(result <span class="ot">&lt;-</span> air <span class="sc">|&gt;</span> <span class="fu">group_by</span>(Dest) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">meanDepDelay =</span> <span class="fu">mean</span>(DepDelay)))   <span class="co"># 0.019 sec.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.019   0.000   0.018 </code></pre>
</div>
</div>
<p>Instead, one can also use <code>dtplyr</code> to set use a data table as a back end for dplyr manipulations. Using <code>lazy_dt</code> allows dtplyr to do some optimization as it generates the translation from dplyr syntax to data table syntax, though this simple example doesn’t illustrate the usefulness of that (and using <code>system.time</code> for fine differentiation of timing is not generally a good idea).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dtplyr)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>lazy_air <span class="ot">&lt;-</span> <span class="fu">lazy_dt</span>(air)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(result <span class="ot">&lt;-</span> lazy_air <span class="sc">|&gt;</span> <span class="fu">group_by</span>(Dest) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">meanDepDelay =</span> <span class="fu">mean</span>(DepDelay))) <span class="co"># 0.007</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.006   0.000   0.005 </code></pre>
</div>
</div>
<p>Finally the <code>tidytable</code> package (not shown) also allows you to use dplyr syntax as well as other tidyverse syntax, such as <code>tidyr</code> functions.</p>
</section>
<section id="working-with-data-on-disk" class="level2">
<h2 class="anchored" data-anchor-id="working-with-data-on-disk">Working with data on disk</h2>
<p>In some cases you may not have enough memory to use tools that bring all the data into memory in R.</p>
<p>Some alternatives include:</p>
<ul>
<li>DuckDB (or SQLite) databases, accessed from R</li>
<li>Using Apache Arrow via the <code>arrow</code> package</li>
</ul>
<p>Or you may need to move to another language, such as using Dask in Python, or database/data lake functionality provided by clould providers.</p>
</section>
</section>
<section id="databases" class="level1">
<h1>Databases</h1>
<p>These days, most people interact with databases from a language like R or Python.</p>
<p>R has the capability to read and write from a variety of relational database management systems (DBMS). Basically a database is a collection of rectangular format datasets (tables). Some of these tables have fields in common so it makes sense to merge (i.e., join) information from multiple tables. E.g., you might have a database with a table of student information, a table of teacher information and a table of school information.</p>
<p>The <em>DBI</em> package provides a front-end for manipulating databases from a variety of DBMS (MySQL, DuckDB, SQLite, Oracle, among others).</p>
<p>DuckDB is a nice alternative to SQLite for a simple database (just a single file) that is fast to use for data analysis work (it uses columnar storage).</p>
<p>Basically, you tell the package what DBMS is being used on the back-end, link to the actual database, and then you can use the standard functions in the package regardless of the back-end.</p>
</section>
<section id="database-example" class="level1">
<h1>Database example</h1>
<p>You can get an example database of information about Stack Overflow questions and answers from <a href="http://www.stat.berkeley.edu/share/paciorek/stackoverflow-2016.duckdb">http://www.stat.berkeley.edu/share/paciorek/stackoverflow-2016.duckdb</a>. Stack Overflow is a website where programmers and software users can pose questions and get answers to technical problems.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(duckdb)  <span class="co"># DBI is a dependency</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>dbfile <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">".."</span>, <span class="st">"data"</span>, <span class="st">"stackoverflow-2021.duckdb"</span>)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>(), <span class="at">dbname =</span> dbfile)  <span class="co"># This will vary depending on the back-end database</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="do">## stackoverflow-2016.db is an DuckDB database</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="do">## The syntax below works regardless of the back-end database.</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="do">## metadata</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListTables</span>(db)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListFields</span>(db, <span class="st">"questions"</span>)</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="do">## A simple filter operation:</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>popular <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(db, <span class="st">"select * from questions </span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="st">   where viewcount &gt; 10000"</span>)</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="do">## A join followed by a filter operation:</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>popularR <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(db, <span class="st">"select * from questions join questions_tags</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="st">   on questions.questionid = questions_tags.questionid</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="st">   where viewcount &gt; 10000 and</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="st">   tag = 'r'"</span>)</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(db)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="breakout" class="level1">
<h1>Breakout</h1>
<section id="dplyr" class="level3">
<h3 class="anchored" data-anchor-id="dplyr"><code>dplyr</code></h3>
<ol type="1">
<li><p>Use <code>dplyr</code> to create a data frame containing the median <code>lifeExp</code> for each continent</p></li>
<li><p>Use <code>dplyr</code> to add a column to the gapminder dataset that contains the total population of the continent of each observation in a given year. For example, if the first observation is Afghanistan in 1952, the new column would contain the population of Asia in 1952.</p></li>
<li><p>Use <code>dplyr</code> to add a column called <code>gdpPercap_diff</code> that contains the difference between the observation’s <code>gdpPercap</code> and the mean <code>gdpPercap</code> of the continent in that year. Arrange the data frame by the column you just created, in descending order (so that the relatively richest country/years are listed first)</p></li>
</ol>
</section>
<section id="tidyr" class="level3">
<h3 class="anchored" data-anchor-id="tidyr"><code>tidyr</code></h3>
<ol start="4" type="1">
<li>Subset the results from question #3 to select only the <code>country</code>, <code>year</code>, and <code>gdpPercap_diff</code> columns. Use tidyr put it in wide format so that countries are rows and years are columns.</li>
</ol>
<p>Hint: you’ll probably see a message about a missing grouping variable. If you don’t want continent included, you can pass the output of problem 3 through <code>ungroup()</code> to get rid of the continent information.</p>
</section>
<section id="data.table" class="level3">
<h3 class="anchored" data-anchor-id="data.table"><code>data.table</code></h3>
<ol start="5" type="1">
<li>Compare timing of some operations on the airline dataset when using <code>dtplyr</code> with <code>lazy_air</code> versus directly applying dplyr syntax to the <code>air</code> <code>data.table</code>.</li>
</ol>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/paciorek\.github\.io\/r-voleon-2025");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb81" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Data Wrangling (Tidyverse and data.table)"</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co">    css: ../assets/styles.css</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-block-bg: true</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-block-border-left: "#31BAE9"</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: auto</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, chunksetup}</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a><span class="in">#| include: false</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a><span class="in"># include any code here you don't want to show up in the document,</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a><span class="in"># e.g. package and dataset loading</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyr)</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a><span class="in">library(gapminder)</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a><span class="fu"># Overview</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>A lot of analysis time in many cases is spent on manipulating tabular data. The tidyverse provides a nice suite of packages for doing this.</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>The <span class="co">[</span><span class="ot">`tidyverse`</span><span class="co">](https://www.tidyverse.org/)</span> is a suite of packages designed </span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>specifically to help with both these steps; some of which we will be introducing in this module. These are by no means the only packages out there for data wrangling but they are  popular for their readable, straightforward syntax and sensible default behaviors.</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>An alternative for working quickly with very large datasets is the <span class="in">`data.table`</span> package. It's fast and a good choice. While the core syntax is not as nice, one can also use dplyr syntax with data.table objects.</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data frame manipulation using `dplyr`</span></span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>Luckily, the <span class="co">[</span><span class="ot">`dplyr`</span><span class="co">](https://cran.r-project.org/web/packages/dplyr/dplyr.pdf)</span> package provides a number of very useful functions for manipulating data frames. </span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>These functions will save you time and hassle by reducing repetition, and will help to make your code more human-readable (trust me: your future self and others might thank you!)</span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>Here we're going to cover 6 of the most commonly used functions as well as using pipes (<span class="in">`%&gt;%`</span>) to combine them.</span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`select()`</span></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span><span class="in">`filter()`</span></span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span><span class="in">`group_by()`</span></span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span><span class="in">`summarize()`</span></span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span><span class="in">`mutate()`</span></span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span><span class="in">`arrange()`</span></span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a><span class="fu">## Selecting columns: `dplyr::select`</span></span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>Imagine that we just received the gapminder dataset, but are only interested in a few variables in it. The <span class="in">`select()`</span> function can help us to keep only the columns corresponding to variables we select.</span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>year_country_gdp_dplyr <span class="ot">&lt;-</span> <span class="fu">select</span>(gapminder, year, country, gdpPercap)</span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(year_country_gdp_dplyr)</span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a><span class="al">![](img/dplyr-fig1.png)</span></span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a>We see the new dataframe only contains the year, country and gdpPercap. This is equivalent to the base R subsetting operator:</span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>year_country_gdp_base <span class="ot">&lt;-</span> gapminder[ , <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"country"</span>, <span class="st">"gdpPercap"</span>)]</span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(year_country_gdp_base)</span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-73"><a href="#cb81-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-74"><a href="#cb81-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a>But, as we will see, <span class="in">`dplyr`</span> makes for much more readable, efficient code because of its *pipe* operator.</span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a><span class="fu">## Piping with `dplyr`</span></span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-79"><a href="#cb81-79" aria-hidden="true" tabindex="-1"></a>Above, we used what's called "normal" grammar, but the strengths of <span class="in">`dplyr`</span> lie </span>
<span id="cb81-80"><a href="#cb81-80" aria-hidden="true" tabindex="-1"></a>in combining several functions using *pipes*.</span>
<span id="cb81-81"><a href="#cb81-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-82"><a href="#cb81-82" aria-hidden="true" tabindex="-1"></a>In typical base R code, a simple operation might be written like: </span>
<span id="cb81-83"><a href="#cb81-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-84"><a href="#cb81-84" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=F}</span></span>
<span id="cb81-85"><a href="#cb81-85" aria-hidden="true" tabindex="-1"></a><span class="in"># NOT run</span></span>
<span id="cb81-86"><a href="#cb81-86" aria-hidden="true" tabindex="-1"></a><span class="in">cupcakes &lt;- bake(pour(mix(ingredients)))</span></span>
<span id="cb81-87"><a href="#cb81-87" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-88"><a href="#cb81-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-89"><a href="#cb81-89" aria-hidden="true" tabindex="-1"></a>A computer has no trouble understanding this and your cupcakes will be made just</span>
<span id="cb81-90"><a href="#cb81-90" aria-hidden="true" tabindex="-1"></a>fine but a person has to read right to left to understand the order of operations </span>
<span id="cb81-91"><a href="#cb81-91" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>the opposite of how most western languages are read - making it harder to </span>
<span id="cb81-92"><a href="#cb81-92" aria-hidden="true" tabindex="-1"></a>understand what is being done! </span>
<span id="cb81-93"><a href="#cb81-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-94"><a href="#cb81-94" aria-hidden="true" tabindex="-1"></a>To be more readable without pipes, we might break up this code into intermediate objects... </span>
<span id="cb81-95"><a href="#cb81-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-98"><a href="#cb81-98" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-99"><a href="#cb81-99" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb81-100"><a href="#cb81-100" aria-hidden="true" tabindex="-1"></a><span class="co"># NOT run</span></span>
<span id="cb81-101"><a href="#cb81-101" aria-hidden="true" tabindex="-1"></a>batter <span class="ot">&lt;-</span> <span class="fu">mix</span>(ingredients)</span>
<span id="cb81-102"><a href="#cb81-102" aria-hidden="true" tabindex="-1"></a>muffin_tin <span class="ot">&lt;-</span> <span class="fu">pour</span>(batter)</span>
<span id="cb81-103"><a href="#cb81-103" aria-hidden="true" tabindex="-1"></a>cupcakes <span class="ot">&lt;-</span> <span class="fu">bake</span>(muffin_tin)</span>
<span id="cb81-104"><a href="#cb81-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-105"><a href="#cb81-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-106"><a href="#cb81-106" aria-hidden="true" tabindex="-1"></a>but this can clutter our environment with a lot of variables that aren't very </span>
<span id="cb81-107"><a href="#cb81-107" aria-hidden="true" tabindex="-1"></a>useful to us, and often are named very similar things (e.g. step, step1, step2...)</span>
<span id="cb81-108"><a href="#cb81-108" aria-hidden="true" tabindex="-1"></a>which can lead to confusion and bugs.</span>
<span id="cb81-109"><a href="#cb81-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-110"><a href="#cb81-110" aria-hidden="true" tabindex="-1"></a><span class="fu">## Enter the pipe... </span></span>
<span id="cb81-111"><a href="#cb81-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-112"><a href="#cb81-112" aria-hidden="true" tabindex="-1"></a>The *pipe* makes it easier to read code because it lays out the operations left to right </span>
<span id="cb81-113"><a href="#cb81-113" aria-hidden="true" tabindex="-1"></a>so each line can be read like a line of a recipe for the perfect data frame! </span>
<span id="cb81-114"><a href="#cb81-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-115"><a href="#cb81-115" aria-hidden="true" tabindex="-1"></a>Pipes take the input on the left side of the <span class="in">`|&gt;`</span> symbol and pass it in as the </span>
<span id="cb81-116"><a href="#cb81-116" aria-hidden="true" tabindex="-1"></a>first argument to the function on the right side.</span>
<span id="cb81-117"><a href="#cb81-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-118"><a href="#cb81-118" aria-hidden="true" tabindex="-1"></a>With pipes, our cupcake example might be written like:</span>
<span id="cb81-119"><a href="#cb81-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-122"><a href="#cb81-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-123"><a href="#cb81-123" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb81-124"><a href="#cb81-124" aria-hidden="true" tabindex="-1"></a>cupcakes <span class="ot">&lt;-</span> ingredients <span class="sc">|&gt;</span> </span>
<span id="cb81-125"><a href="#cb81-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mix</span>() <span class="sc">|&gt;</span> </span>
<span id="cb81-126"><a href="#cb81-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pour</span>() <span class="sc">|&gt;</span> </span>
<span id="cb81-127"><a href="#cb81-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>()</span>
<span id="cb81-128"><a href="#cb81-128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-129"><a href="#cb81-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-130"><a href="#cb81-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-131"><a href="#cb81-131" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pipe example</span></span>
<span id="cb81-132"><a href="#cb81-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-133"><a href="#cb81-133" aria-hidden="true" tabindex="-1"></a>Let's repeat what </span>
<span id="cb81-134"><a href="#cb81-134" aria-hidden="true" tabindex="-1"></a>we did above with the gapminder dataset using pipes:</span>
<span id="cb81-135"><a href="#cb81-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-138"><a href="#cb81-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-139"><a href="#cb81-139" aria-hidden="true" tabindex="-1"></a>year_country_gdp <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span> <span class="fu">select</span>(year, country, gdpPercap)</span>
<span id="cb81-140"><a href="#cb81-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-141"><a href="#cb81-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-142"><a href="#cb81-142" aria-hidden="true" tabindex="-1"></a>First, we summon the gapminder data frame and pass it on to the next step using the pipe symbol <span class="in">`|&gt;`</span>.</span>
<span id="cb81-143"><a href="#cb81-143" aria-hidden="true" tabindex="-1"></a>The second step is the <span class="in">`select()`</span> function.</span>
<span id="cb81-144"><a href="#cb81-144" aria-hidden="true" tabindex="-1"></a>In this case we don't specify which data object we use in the call to <span class="in">`select()`</span> since we've piped it in.</span>
<span id="cb81-145"><a href="#cb81-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-146"><a href="#cb81-146" aria-hidden="true" tabindex="-1"></a>Note that lack of quotations around the column names. This is called "non-standard evaluation" and is used a lot in the tidyverse (including in ggplot).</span>
<span id="cb81-147"><a href="#cb81-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-148"><a href="#cb81-148" aria-hidden="true" tabindex="-1"></a><span class="fu">## Filtering rows: `dplyr::filter`</span></span>
<span id="cb81-149"><a href="#cb81-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-150"><a href="#cb81-150" aria-hidden="true" tabindex="-1"></a>Now let's say we're only interested in African countries. We can combine <span class="in">`select`</span> and <span class="in">`filter`</span> to select only the observations where <span class="in">`continent`</span> is <span class="in">`Africa`</span>.</span>
<span id="cb81-151"><a href="#cb81-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-154"><a href="#cb81-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-155"><a href="#cb81-155" aria-hidden="true" tabindex="-1"></a>year_country_gdp_africa <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb81-156"><a href="#cb81-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(continent <span class="sc">==</span> <span class="st">"Africa"</span>) <span class="sc">|&gt;</span></span>
<span id="cb81-157"><a href="#cb81-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(year,country,gdpPercap)</span>
<span id="cb81-158"><a href="#cb81-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-159"><a href="#cb81-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-160"><a href="#cb81-160" aria-hidden="true" tabindex="-1"></a>As with last time, first we pass the gapminder data frame to the <span class="in">`filter()`</span> function, then we pass the filtered version of the gapminder data frame to the <span class="in">`select()`</span> function.</span>
<span id="cb81-161"><a href="#cb81-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-162"><a href="#cb81-162" aria-hidden="true" tabindex="-1"></a>**Note:** The order of operations is important in this case. If we used 'select' first, filter would not be able to find the variable <span class="in">`continent`</span> since we would have removed it in the previous step.</span>
<span id="cb81-163"><a href="#cb81-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-164"><a href="#cb81-164" aria-hidden="true" tabindex="-1"></a><span class="fu">## `dplyr` calculations across groups: split-apply-combine</span></span>
<span id="cb81-165"><a href="#cb81-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-166"><a href="#cb81-166" aria-hidden="true" tabindex="-1"></a>A common task you'll encounter when working with data is running calculations on different groups within the data. For instance, what if we wanted to calculate the mean GDP per capita for each continent?</span>
<span id="cb81-167"><a href="#cb81-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-168"><a href="#cb81-168" aria-hidden="true" tabindex="-1"></a>This general task is known as "split-apply-combine":</span>
<span id="cb81-169"><a href="#cb81-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-170"><a href="#cb81-170" aria-hidden="true" tabindex="-1"></a><span class="al">![](img/splitapply.png)</span></span>
<span id="cb81-171"><a href="#cb81-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-172"><a href="#cb81-172" aria-hidden="true" tabindex="-1"></a>We want to *split* our data into groups (in this case continents), *apply* some calculations on each group, then  *combine* the results together afterwards.</span>
<span id="cb81-173"><a href="#cb81-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-174"><a href="#cb81-174" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stratifying: `dplyr::group_by`</span></span>
<span id="cb81-175"><a href="#cb81-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-176"><a href="#cb81-176" aria-hidden="true" tabindex="-1"></a>We've already seen how <span class="in">`filter()`</span> can help us select observations that meet certain criteria (in the above: <span class="in">`continent == "Europe"`</span>). More helpful, however, is the <span class="in">`group_by()`</span> function, which will essentially use every unique criteria that we could have used in <span class="in">`filter()`</span>.</span>
<span id="cb81-177"><a href="#cb81-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-178"><a href="#cb81-178" aria-hidden="true" tabindex="-1"></a>A <span class="in">`grouped_df`</span> can be thought of as a <span class="in">`list`</span> where each item in the <span class="in">`list`</span> is a <span class="in">`data.frame`</span> which contains only the rows that correspond to a particular value of one or more grouping variables (<span class="in">`continent`</span> in our example).</span>
<span id="cb81-179"><a href="#cb81-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-180"><a href="#cb81-180" aria-hidden="true" tabindex="-1"></a><span class="al">![](img/dplyr-fig2.png)</span></span>
<span id="cb81-181"><a href="#cb81-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-182"><a href="#cb81-182" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reduction operations: `dplyr::summarize`</span></span>
<span id="cb81-183"><a href="#cb81-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-184"><a href="#cb81-184" aria-hidden="true" tabindex="-1"></a><span class="in">`group_by()`</span> on its own is not particularly interesting; instead it's generally used with <span class="in">`summarize()`</span>.</span>
<span id="cb81-185"><a href="#cb81-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-186"><a href="#cb81-186" aria-hidden="true" tabindex="-1"></a>This will allow use to create new variable(s) by applying transformations to variables in each of the continent-specific data frames.</span>
<span id="cb81-187"><a href="#cb81-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-188"><a href="#cb81-188" aria-hidden="true" tabindex="-1"></a>In other words, using the <span class="in">`group_by()`</span> function, we split our original data frame into multiple pieces, which we then apply summary functions to (e.g., <span class="in">`mean()`</span> or <span class="in">`sd()`</span>) within <span class="in">`summarize()`</span>.</span>
<span id="cb81-189"><a href="#cb81-189" aria-hidden="true" tabindex="-1"></a>The output is a new data frame reduced in size, with one row per group.</span>
<span id="cb81-190"><a href="#cb81-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-193"><a href="#cb81-193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-194"><a href="#cb81-194" aria-hidden="true" tabindex="-1"></a>gdp_bycontinents <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb81-195"><a href="#cb81-195" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent) <span class="sc">|&gt;</span></span>
<span id="cb81-196"><a href="#cb81-196" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap))</span>
<span id="cb81-197"><a href="#cb81-197" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gdp_bycontinents)</span>
<span id="cb81-198"><a href="#cb81-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-199"><a href="#cb81-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-200"><a href="#cb81-200" aria-hidden="true" tabindex="-1"></a><span class="al">![](img/dplyr-fig3.png)</span></span>
<span id="cb81-201"><a href="#cb81-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-202"><a href="#cb81-202" aria-hidden="true" tabindex="-1"></a>That allowed us to calculate the mean gdpPercap for each continent. But it gets even better -- the function <span class="in">`group_by()`</span> allows us to group by multiple variables. Let's group by <span class="in">`year`</span> and <span class="in">`continent`</span>.</span>
<span id="cb81-203"><a href="#cb81-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-206"><a href="#cb81-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-207"><a href="#cb81-207" aria-hidden="true" tabindex="-1"></a>gdp_bycontinents_byyear <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb81-208"><a href="#cb81-208" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb81-209"><a href="#cb81-209" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap))</span>
<span id="cb81-210"><a href="#cb81-210" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gdp_bycontinents_byyear)</span>
<span id="cb81-211"><a href="#cb81-211" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-212"><a href="#cb81-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-213"><a href="#cb81-213" aria-hidden="true" tabindex="-1"></a>You're not limited to defining one new variable in <span class="in">`summarize()`</span>.</span>
<span id="cb81-214"><a href="#cb81-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-217"><a href="#cb81-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-218"><a href="#cb81-218" aria-hidden="true" tabindex="-1"></a>gdp_pop_bycontinents_byyear <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb81-219"><a href="#cb81-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb81-220"><a href="#cb81-220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap),</span>
<span id="cb81-221"><a href="#cb81-221" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdpPercap =</span> <span class="fu">sd</span>(gdpPercap),</span>
<span id="cb81-222"><a href="#cb81-222" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_pop =</span> <span class="fu">mean</span>(pop),</span>
<span id="cb81-223"><a href="#cb81-223" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_pop =</span> <span class="fu">sd</span>(pop))</span>
<span id="cb81-224"><a href="#cb81-224" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gdp_pop_bycontinents_byyear)</span>
<span id="cb81-225"><a href="#cb81-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-226"><a href="#cb81-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-227"><a href="#cb81-227" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adding columns: `dplyr::mutate`</span></span>
<span id="cb81-228"><a href="#cb81-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-229"><a href="#cb81-229" aria-hidden="true" tabindex="-1"></a>What if we wanted to add these values to our original data frame instead of creating a new object? For this, we can use the <span class="in">`mutate()`</span> function, which is similar to <span class="in">`summarize()`</span> except it creates new variables in the same data frame that you pass into it.</span>
<span id="cb81-230"><a href="#cb81-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-233"><a href="#cb81-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-234"><a href="#cb81-234" aria-hidden="true" tabindex="-1"></a>gap_with_extra_vars <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb81-235"><a href="#cb81-235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb81-236"><a href="#cb81-236" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap),</span>
<span id="cb81-237"><a href="#cb81-237" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdpPercap =</span> <span class="fu">sd</span>(gdpPercap),</span>
<span id="cb81-238"><a href="#cb81-238" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_pop =</span> <span class="fu">mean</span>(pop),</span>
<span id="cb81-239"><a href="#cb81-239" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_pop =</span> <span class="fu">sd</span>(pop))</span>
<span id="cb81-240"><a href="#cb81-240" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_with_extra_vars)</span>
<span id="cb81-241"><a href="#cb81-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-242"><a href="#cb81-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-243"><a href="#cb81-243" aria-hidden="true" tabindex="-1"></a>We can use also use <span class="in">`mutate()`</span> to create new variables prior to (or even after) summarizing information. Note that <span class="in">`mutate()`</span> does not need to operate on grouped data and it can do element-wise transformations.</span>
<span id="cb81-244"><a href="#cb81-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-247"><a href="#cb81-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-248"><a href="#cb81-248" aria-hidden="true" tabindex="-1"></a>gdp_pop_bycontinents_byyear <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb81-249"><a href="#cb81-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gdp_billion =</span> gdpPercap<span class="sc">*</span>pop<span class="sc">/</span><span class="dv">10</span><span class="sc">^</span><span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb81-250"><a href="#cb81-250" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb81-251"><a href="#cb81-251" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap),</span>
<span id="cb81-252"><a href="#cb81-252" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdpPercap =</span> <span class="fu">sd</span>(gdpPercap),</span>
<span id="cb81-253"><a href="#cb81-253" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_pop =</span> <span class="fu">mean</span>(pop),</span>
<span id="cb81-254"><a href="#cb81-254" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_pop =</span> <span class="fu">sd</span>(pop),</span>
<span id="cb81-255"><a href="#cb81-255" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_gdp_billion =</span> <span class="fu">mean</span>(gdp_billion),</span>
<span id="cb81-256"><a href="#cb81-256" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdp_billion =</span> <span class="fu">sd</span>(gdp_billion))</span>
<span id="cb81-257"><a href="#cb81-257" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gdp_pop_bycontinents_byyear)</span>
<span id="cb81-258"><a href="#cb81-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-259"><a href="#cb81-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-260"><a href="#cb81-260" aria-hidden="true" tabindex="-1"></a><span class="fu">## `mutate` vs. `summarize`</span></span>
<span id="cb81-261"><a href="#cb81-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-262"><a href="#cb81-262" aria-hidden="true" tabindex="-1"></a>It can be confusing to decide whether to use <span class="in">`mutate`</span> or <span class="in">`summarize`</span>. The key distinction is whether you want the output to have one row for each group or one row for each row in the original data frame:</span>
<span id="cb81-263"><a href="#cb81-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-264"><a href="#cb81-264" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`mutate`</span>: creates new columns with as many rows as the original data frame</span>
<span id="cb81-265"><a href="#cb81-265" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`summarize`</span>: creates a data frame with as many rows as groups</span>
<span id="cb81-266"><a href="#cb81-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-267"><a href="#cb81-267" aria-hidden="true" tabindex="-1"></a>Note that if you use an aggregation function such as <span class="in">`mean()`</span> within <span class="in">`mutate()`</span> without using <span class="in">`groupby()`</span>, you'll simply do the summary over all the rows of the input data frame.</span>
<span id="cb81-268"><a href="#cb81-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-269"><a href="#cb81-269" aria-hidden="true" tabindex="-1"></a>And if you use an aggregation function such as <span class="in">`mean()`</span> within <span class="in">`summarize()`</span> without using <span class="in">`groupby()`</span>, you'll simply create an output data frame with one row (i.e., the whole input data frame is a single group).</span>
<span id="cb81-270"><a href="#cb81-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-271"><a href="#cb81-271" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sorting: `dplyr::arrange`</span></span>
<span id="cb81-272"><a href="#cb81-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-273"><a href="#cb81-273" aria-hidden="true" tabindex="-1"></a>As a last step, let's say we want to sort the rows in our data frame according to values in a certain column. We can use the <span class="in">`arrange()`</span> function to do this. For instance, let's organize our rows by <span class="in">`year`</span> (recent first), and then by <span class="in">`continent`</span>.</span>
<span id="cb81-274"><a href="#cb81-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-277"><a href="#cb81-277" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-278"><a href="#cb81-278" aria-hidden="true" tabindex="-1"></a>gap_with_extra_vars <span class="ot">&lt;-</span> gapminder <span class="sc">|&gt;</span></span>
<span id="cb81-279"><a href="#cb81-279" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent, year) <span class="sc">|&gt;</span></span>
<span id="cb81-280"><a href="#cb81-280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mean_gdpPercap =</span> <span class="fu">mean</span>(gdpPercap),</span>
<span id="cb81-281"><a href="#cb81-281" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_gdpPercap =</span> <span class="fu">sd</span>(gdpPercap),</span>
<span id="cb81-282"><a href="#cb81-282" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_pop =</span> <span class="fu">mean</span>(pop),</span>
<span id="cb81-283"><a href="#cb81-283" aria-hidden="true" tabindex="-1"></a>              <span class="at">sd_pop =</span> <span class="fu">sd</span>(pop)) <span class="sc">|&gt;</span></span>
<span id="cb81-284"><a href="#cb81-284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(year), continent) <span class="co"># `desc()` = descending order</span></span>
<span id="cb81-285"><a href="#cb81-285" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_with_extra_vars)</span>
<span id="cb81-286"><a href="#cb81-286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-287"><a href="#cb81-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-288"><a href="#cb81-288" aria-hidden="true" tabindex="-1"></a><span class="fu">## `dplyr` take-aways</span></span>
<span id="cb81-289"><a href="#cb81-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-290"><a href="#cb81-290" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Human readable: the function names describe the action being done</span>
<span id="cb81-291"><a href="#cb81-291" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Piping: chain functions in a step-by-step way, rather than nesting</span>
<span id="cb81-292"><a href="#cb81-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-293"><a href="#cb81-293" aria-hidden="true" tabindex="-1"></a><span class="fu">## dplyr and "non-standard evaluation"</span></span>
<span id="cb81-294"><a href="#cb81-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-295"><a href="#cb81-295" aria-hidden="true" tabindex="-1"></a>You may run across the term "non-standard evaluation". </span>
<span id="cb81-296"><a href="#cb81-296" aria-hidden="true" tabindex="-1"></a>The use of data frame variables without quotes around them is an example of this.</span>
<span id="cb81-297"><a href="#cb81-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-298"><a href="#cb81-298" aria-hidden="true" tabindex="-1"></a>Why is this strange?</span>
<span id="cb81-299"><a href="#cb81-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-302"><a href="#cb81-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-303"><a href="#cb81-303" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb81-304"><a href="#cb81-304" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">|&gt;</span> <span class="fu">select</span>(continent, year) <span class="sc">|&gt;</span> <span class="fu">tail</span>()</span>
<span id="cb81-305"><a href="#cb81-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-306"><a href="#cb81-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-307"><a href="#cb81-307" aria-hidden="true" tabindex="-1"></a>Compare it to:</span>
<span id="cb81-308"><a href="#cb81-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-311"><a href="#cb81-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-312"><a href="#cb81-312" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb81-313"><a href="#cb81-313" aria-hidden="true" tabindex="-1"></a>gapminder[ , <span class="fu">c</span>(<span class="st">'continent'</span>, <span class="st">'year'</span>)]</span>
<span id="cb81-314"><a href="#cb81-314" aria-hidden="true" tabindex="-1"></a>gapminder[ , <span class="st">'continent'</span>]</span>
<span id="cb81-315"><a href="#cb81-315" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-316"><a href="#cb81-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-317"><a href="#cb81-317" aria-hidden="true" tabindex="-1"></a>Because <span class="in">`continent`</span> and <span class="in">`year`</span> are not variables our current environment! dplyr does some manipulation of language objects behind the scenes to save us from typing the quotes.</span>
<span id="cb81-318"><a href="#cb81-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-319"><a href="#cb81-319" aria-hidden="true" tabindex="-1"></a>This is fine if you have a data analysis workflow but if you want to write a function that, for example, selects an arbitrary set of columns, you'll run into trouble.</span>
<span id="cb81-320"><a href="#cb81-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-323"><a href="#cb81-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-324"><a href="#cb81-324" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb81-325"><a href="#cb81-325" aria-hidden="true" tabindex="-1"></a><span class="do">## here's a helper function that computes the mean of a variable, stratifying by a grouping variable</span></span>
<span id="cb81-326"><a href="#cb81-326" aria-hidden="true" tabindex="-1"></a>grouped_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(data, group_var, summary_var) {</span>
<span id="cb81-327"><a href="#cb81-327" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">|&gt;</span></span>
<span id="cb81-328"><a href="#cb81-328" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group_var) <span class="sc">|&gt;</span></span>
<span id="cb81-329"><a href="#cb81-329" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(summary_var))</span>
<span id="cb81-330"><a href="#cb81-330" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-331"><a href="#cb81-331" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">|&gt;</span> <span class="fu">grouped_mean</span>(continent, lifeExp)</span>
<span id="cb81-332"><a href="#cb81-332" aria-hidden="true" tabindex="-1"></a>gapminder <span class="sc">|&gt;</span> <span class="fu">grouped_mean</span>(<span class="st">'continent'</span>, <span class="st">'lifeExp'</span>)</span>
<span id="cb81-333"><a href="#cb81-333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-334"><a href="#cb81-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-335"><a href="#cb81-335" aria-hidden="true" tabindex="-1"></a>See the <span class="in">`rlang`</span> (or <span class="in">`wrapr`</span>) package for how one can deal with this problem in this context of using functions. </span>
<span id="cb81-336"><a href="#cb81-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-337"><a href="#cb81-337" aria-hidden="true" tabindex="-1"></a><span class="fu"># Tidying data</span></span>
<span id="cb81-338"><a href="#cb81-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-339"><a href="#cb81-339" aria-hidden="true" tabindex="-1"></a>Even before we conduct analysis or calculations, we need to put our data into the correct format. The goal here is to rearrange a messy dataset into one that is **tidy**.</span>
<span id="cb81-340"><a href="#cb81-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-341"><a href="#cb81-341" aria-hidden="true" tabindex="-1"></a>The two most important properties of tidy data are:</span>
<span id="cb81-342"><a href="#cb81-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-343"><a href="#cb81-343" aria-hidden="true" tabindex="-1"></a>1) Each column is a variable.</span>
<span id="cb81-344"><a href="#cb81-344" aria-hidden="true" tabindex="-1"></a>2) Each row is an observation.</span>
<span id="cb81-345"><a href="#cb81-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-346"><a href="#cb81-346" aria-hidden="true" tabindex="-1"></a>Tidy data is easier to work with, because you have a consistent way of referring to variables (as column names) and observations (as row indices). It then becomes easy to manipulate, visualize, and model.</span>
<span id="cb81-347"><a href="#cb81-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-348"><a href="#cb81-348" aria-hidden="true" tabindex="-1"></a>For more on the concept of *tidy* data, you can read <span class="co">[</span><span class="ot">Hadley Wickham's paper</span><span class="co">](http://vita.had.co.nz/papers/tidy-data.html)</span>.</span>
<span id="cb81-349"><a href="#cb81-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-350"><a href="#cb81-350" aria-hidden="true" tabindex="-1"></a><span class="fu">## Wide vs. long formats</span></span>
<span id="cb81-351"><a href="#cb81-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-352"><a href="#cb81-352" aria-hidden="true" tabindex="-1"></a>Tabular datasets can be arranged in many ways. For instance, consider the data below. Each data set displays information on heart rate observed in individuals across 3 different time periods. But the data are organized differently in each table.</span>
<span id="cb81-353"><a href="#cb81-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-356"><a href="#cb81-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-357"><a href="#cb81-357" aria-hidden="true" tabindex="-1"></a>wide <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb81-358"><a href="#cb81-358" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Wilbur"</span>, <span class="st">"Petunia"</span>, <span class="st">"Gregory"</span>),</span>
<span id="cb81-359"><a href="#cb81-359" aria-hidden="true" tabindex="-1"></a>  <span class="at">time1 =</span> <span class="fu">c</span>(<span class="dv">67</span>, <span class="dv">80</span>, <span class="dv">64</span>),</span>
<span id="cb81-360"><a href="#cb81-360" aria-hidden="true" tabindex="-1"></a>  <span class="at">time2 =</span> <span class="fu">c</span>(<span class="dv">56</span>, <span class="dv">90</span>, <span class="dv">50</span>),</span>
<span id="cb81-361"><a href="#cb81-361" aria-hidden="true" tabindex="-1"></a>  <span class="at">time3 =</span> <span class="fu">c</span>(<span class="dv">70</span>, <span class="dv">67</span>, <span class="dv">101</span>)</span>
<span id="cb81-362"><a href="#cb81-362" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-363"><a href="#cb81-363" aria-hidden="true" tabindex="-1"></a>wide</span>
<span id="cb81-364"><a href="#cb81-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-365"><a href="#cb81-365" aria-hidden="true" tabindex="-1"></a>long <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb81-366"><a href="#cb81-366" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Wilbur"</span>, <span class="st">"Petunia"</span>, <span class="st">"Gregory"</span>, <span class="st">"Wilbur"</span>, <span class="st">"Petunia"</span>, <span class="st">"Gregory"</span>, <span class="st">"Wilbur"</span>, <span class="st">"Petunia"</span>, <span class="st">"Gregory"</span>),</span>
<span id="cb81-367"><a href="#cb81-367" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb81-368"><a href="#cb81-368" aria-hidden="true" tabindex="-1"></a>  <span class="at">heartrate =</span> <span class="fu">c</span>(<span class="dv">67</span>, <span class="dv">80</span>, <span class="dv">64</span>, <span class="dv">56</span>, <span class="dv">90</span>, <span class="dv">50</span>, <span class="dv">70</span>, <span class="dv">67</span>, <span class="dv">10</span>)</span>
<span id="cb81-369"><a href="#cb81-369" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-370"><a href="#cb81-370" aria-hidden="true" tabindex="-1"></a>long</span>
<span id="cb81-371"><a href="#cb81-371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-372"><a href="#cb81-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-373"><a href="#cb81-373" aria-hidden="true" tabindex="-1"></a>We often refer to these different structures as "long" vs. "wide" formats. In the "long" format, you usually have 1 column for the observed variable and the other columns are ID variables.</span>
<span id="cb81-374"><a href="#cb81-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-375"><a href="#cb81-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-376"><a href="#cb81-376" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Question"}</span>
<span id="cb81-377"><a href="#cb81-377" aria-hidden="true" tabindex="-1"></a>Which of the 'wide' and 'long' objects do you prefer in terms of how the heartrate 'data' are formatted?</span>
<span id="cb81-378"><a href="#cb81-378" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb81-379"><a href="#cb81-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-380"><a href="#cb81-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-381"><a href="#cb81-381" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Answer" collapse="true"}</span>
<span id="cb81-382"><a href="#cb81-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-383"><a href="#cb81-383" aria-hidden="true" tabindex="-1"></a>The first data frame (the "wide" one) would not be considered *tidy* because values (i.e., heartrate) are spread across multiple columns.</span>
<span id="cb81-384"><a href="#cb81-384" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb81-385"><a href="#cb81-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-386"><a href="#cb81-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-387"><a href="#cb81-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-388"><a href="#cb81-388" aria-hidden="true" tabindex="-1"></a>For the "wide" format each row is often a site/subject/patient and you have multiple observation variables containing the same type of data. These can be either repeated observations over time, or observation of multiple variables (or a mix of both). In the above case, we had the same kind of data (heart rate) entered across 3 different columns, corresponding to three different time periods.</span>
<span id="cb81-389"><a href="#cb81-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-390"><a href="#cb81-390" aria-hidden="true" tabindex="-1"></a><span class="al">![](img/tidyr-fig1.png)</span></span>
<span id="cb81-391"><a href="#cb81-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-392"><a href="#cb81-392" aria-hidden="true" tabindex="-1"></a>You may find data input may be simpler and some programs/functions may prefer the "wide" format. However, many of R’s functions (particularly in the tidyverse) have been designed assuming you have "long" format data.</span>
<span id="cb81-393"><a href="#cb81-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-394"><a href="#cb81-394" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tidying the Gapminder data</span></span>
<span id="cb81-395"><a href="#cb81-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-396"><a href="#cb81-396" aria-hidden="true" tabindex="-1"></a>Lets look at the structure of our original gapminder data frame:</span>
<span id="cb81-397"><a href="#cb81-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-400"><a href="#cb81-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-401"><a href="#cb81-401" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gapminder)</span>
<span id="cb81-402"><a href="#cb81-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-403"><a href="#cb81-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-404"><a href="#cb81-404" aria-hidden="true" tabindex="-1"></a>**Question**: Is this data frame **wide** or **long**?</span>
<span id="cb81-405"><a href="#cb81-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-406"><a href="#cb81-406" aria-hidden="true" tabindex="-1"></a>**Answer**: This data frame is somewhere in between the purely 'long' and 'wide' formats. We have 3 "ID variables" (<span class="in">`continent`</span>, <span class="in">`country`</span>, <span class="in">`year`</span>) and 3 "Observation variables" (<span class="in">`pop`</span>, <span class="in">`lifeExp`</span>, <span class="in">`gdpPercap`</span>).</span>
<span id="cb81-407"><a href="#cb81-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-408"><a href="#cb81-408" aria-hidden="true" tabindex="-1"></a>Despite not having ALL observations in 1 column, this intermediate format makes sense given that all 3 observation variables have different units. As we have seen, many of the functions in R are often vector based, and you usually do not want to do mathematical operations on values with different units.</span>
<span id="cb81-409"><a href="#cb81-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-410"><a href="#cb81-410" aria-hidden="true" tabindex="-1"></a>On the other hand, there are some instances in which a purely long or wide format is ideal (e.g. plotting). Likewise, sometimes you'll get data on your desk that is poorly organized, and you'll need to **reshape** it.</span>
<span id="cb81-411"><a href="#cb81-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-412"><a href="#cb81-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-413"><a href="#cb81-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-414"><a href="#cb81-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-415"><a href="#cb81-415" aria-hidden="true" tabindex="-1"></a><span class="fu">## Converting to long format: `tidyr::pivot_longer`</span></span>
<span id="cb81-416"><a href="#cb81-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-417"><a href="#cb81-417" aria-hidden="true" tabindex="-1"></a>The <span class="in">`tidyr`</span> package will help you efficiently transform your data regardless of original format.</span>
<span id="cb81-418"><a href="#cb81-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-419"><a href="#cb81-419" aria-hidden="true" tabindex="-1"></a>Until now, we've been using the nicely formatted original gapminder data set. This data set is not quite wide and not quite long -- it's something in the middle, but "real" data (i.e., our own research data) will never be so well organized. Here let's start with the wide format version of the gapminder data set.</span>
<span id="cb81-420"><a href="#cb81-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-423"><a href="#cb81-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-424"><a href="#cb81-424" aria-hidden="true" tabindex="-1"></a>gap_wide <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">".."</span>, <span class="st">"data"</span>, <span class="st">"gapminder_wide.csv"</span>))</span>
<span id="cb81-425"><a href="#cb81-425" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_wide)</span>
<span id="cb81-426"><a href="#cb81-426" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-427"><a href="#cb81-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-428"><a href="#cb81-428" aria-hidden="true" tabindex="-1"></a>The first step towards getting our nice intermediate data format is to first convert from the wide to the long format.</span>
<span id="cb81-429"><a href="#cb81-429" aria-hidden="true" tabindex="-1"></a>The function <span class="in">`pivot_longer()`</span> will 'gather' the observation variables into a single variable. This is sometimes called "melting" your data, because it melts the table from wide to long. Those data will be melted into two variables: one for the variable names, and the other for the variable values.</span>
<span id="cb81-430"><a href="#cb81-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-433"><a href="#cb81-433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-434"><a href="#cb81-434" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb81-435"><a href="#cb81-435" aria-hidden="true" tabindex="-1"></a>gap_long <span class="ot">&lt;-</span> gap_wide <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(gdpPercap_1952<span class="sc">:</span>pop_2007)</span>
<span id="cb81-436"><a href="#cb81-436" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_long)</span>
<span id="cb81-437"><a href="#cb81-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-438"><a href="#cb81-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-439"><a href="#cb81-439" aria-hidden="true" tabindex="-1"></a>Formerly one used the function <span class="in">`gather`</span> to do this, but many people found it not to be intuitive to use.</span>
<span id="cb81-440"><a href="#cb81-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-441"><a href="#cb81-441" aria-hidden="true" tabindex="-1"></a><span class="fu">## Specifying column names: `tidyr::select`</span></span>
<span id="cb81-442"><a href="#cb81-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-443"><a href="#cb81-443" aria-hidden="true" tabindex="-1"></a>If there are a lot of columns or they're named in a consistent pattern, we might not want to select them using the column numbers.</span>
<span id="cb81-444"><a href="#cb81-444" aria-hidden="true" tabindex="-1"></a>It'd be easier to use some information contained in the names themselves.</span>
<span id="cb81-445"><a href="#cb81-445" aria-hidden="true" tabindex="-1"></a>We can select variables using:</span>
<span id="cb81-446"><a href="#cb81-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-447"><a href="#cb81-447" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>variable indices</span>
<span id="cb81-448"><a href="#cb81-448" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>variable names (without quotes)</span>
<span id="cb81-449"><a href="#cb81-449" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`x:z`</span> to select all variables between x and z</span>
<span id="cb81-450"><a href="#cb81-450" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`-y`</span> to *exclude* y</span>
<span id="cb81-451"><a href="#cb81-451" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`starts_with(x, ignore.case = TRUE)`</span>: all names that starts with <span class="in">`x`</span></span>
<span id="cb81-452"><a href="#cb81-452" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`ends_with(x, ignore.case = TRUE)`</span>: all names that ends with <span class="in">`x`</span></span>
<span id="cb81-453"><a href="#cb81-453" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`contains(x, ignore.case = TRUE)`</span>: all names that contain <span class="in">`x`</span></span>
<span id="cb81-454"><a href="#cb81-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-455"><a href="#cb81-455" aria-hidden="true" tabindex="-1"></a>See the <span class="in">`select()`</span> function in <span class="in">`dplyr`</span> for more options.</span>
<span id="cb81-456"><a href="#cb81-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-457"><a href="#cb81-457" aria-hidden="true" tabindex="-1"></a>For instance, here we do the same gather operation with (1) the <span class="in">`starts_with`</span> function, and (2) the <span class="in">`-`</span> operator:</span>
<span id="cb81-458"><a href="#cb81-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-461"><a href="#cb81-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-462"><a href="#cb81-462" aria-hidden="true" tabindex="-1"></a><span class="co"># with the starts_with() function</span></span>
<span id="cb81-463"><a href="#cb81-463" aria-hidden="true" tabindex="-1"></a>gap_long <span class="ot">&lt;-</span> gap_wide <span class="sc">|&gt;</span></span>
<span id="cb81-464"><a href="#cb81-464" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">'pop'</span>), <span class="fu">starts_with</span>(<span class="st">'lifeExp'</span>), <span class="fu">starts_with</span>(<span class="st">'gdpPercap'</span>)))</span>
<span id="cb81-465"><a href="#cb81-465" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_long)</span>
<span id="cb81-466"><a href="#cb81-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-467"><a href="#cb81-467" aria-hidden="true" tabindex="-1"></a><span class="co"># with the - operator</span></span>
<span id="cb81-468"><a href="#cb81-468" aria-hidden="true" tabindex="-1"></a>gap_long <span class="ot">&lt;-</span> gap_wide <span class="sc">|&gt;</span></span>
<span id="cb81-469"><a href="#cb81-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(<span class="sc">-</span>continent, <span class="sc">-</span>country))</span>
<span id="cb81-470"><a href="#cb81-470" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_long)</span>
<span id="cb81-471"><a href="#cb81-471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-472"><a href="#cb81-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-473"><a href="#cb81-473" aria-hidden="true" tabindex="-1"></a>However you choose to do it, notice that the output collapses all of the measure variables into two columns: one containing new ID variable, the other containing the observation value for that row.</span>
<span id="cb81-474"><a href="#cb81-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-475"><a href="#cb81-475" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cleaning column names:  `tidyr::separate`</span></span>
<span id="cb81-476"><a href="#cb81-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-477"><a href="#cb81-477" aria-hidden="true" tabindex="-1"></a>You'll notice that in our long dataset, <span class="in">`name`</span> actually contains 2 pieces of information, the observation type (<span class="in">`pop`</span>, <span class="in">`lifeExp`</span>, or <span class="in">`gdpPercap`</span>) and the <span class="in">`year`</span>.</span>
<span id="cb81-478"><a href="#cb81-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-479"><a href="#cb81-479" aria-hidden="true" tabindex="-1"></a>We can use the <span class="in">`separate()`</span> function to split the character strings into multiple variables:</span>
<span id="cb81-480"><a href="#cb81-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-483"><a href="#cb81-483" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-484"><a href="#cb81-484" aria-hidden="true" tabindex="-1"></a>gap_long_sep <span class="ot">&lt;-</span> gap_long <span class="sc">|&gt;</span></span>
<span id="cb81-485"><a href="#cb81-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">'obs_type'</span>,<span class="st">'year'</span>), <span class="at">sep =</span> <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb81-486"><a href="#cb81-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.integer</span>(year))</span>
<span id="cb81-487"><a href="#cb81-487" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_long_sep)</span>
<span id="cb81-488"><a href="#cb81-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-489"><a href="#cb81-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-490"><a href="#cb81-490" aria-hidden="true" tabindex="-1"></a>If you didn't use <span class="in">`tidyr`</span> to do this, you'd have to use the <span class="in">`strsplit`</span> function and use multiple lines of code to replace the column in <span class="in">`gap_long`</span> with two new columns. This solution is much cleaner.</span>
<span id="cb81-491"><a href="#cb81-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-492"><a href="#cb81-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-493"><a href="#cb81-493" aria-hidden="true" tabindex="-1"></a><span class="fu">## Converting to wide format: `tidyr::pivot_wider`</span></span>
<span id="cb81-494"><a href="#cb81-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-495"><a href="#cb81-495" aria-hidden="true" tabindex="-1"></a>The opposite of <span class="in">`pivot_longer()`</span> is <span class="in">`pivot_wider()`</span>. It spreads our observation variables back out to make a wider table. We can use this function to spread our <span class="in">`gap_long()`</span> to the original "medium" format.</span>
<span id="cb81-496"><a href="#cb81-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-499"><a href="#cb81-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-500"><a href="#cb81-500" aria-hidden="true" tabindex="-1"></a>gap_medium <span class="ot">&lt;-</span> gap_long_sep <span class="sc">|&gt;</span></span>
<span id="cb81-501"><a href="#cb81-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> obs_type, <span class="at">values_from =</span> value)</span>
<span id="cb81-502"><a href="#cb81-502" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_medium)</span>
<span id="cb81-503"><a href="#cb81-503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-504"><a href="#cb81-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-505"><a href="#cb81-505" aria-hidden="true" tabindex="-1"></a>Formerly one used the function <span class="in">`spread`</span> to do this, but many people found it not to be intuitive to use.</span>
<span id="cb81-506"><a href="#cb81-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-507"><a href="#cb81-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-508"><a href="#cb81-508" aria-hidden="true" tabindex="-1"></a>All we need is some quick fixes to make this dataset identical to the original <span class="in">`gapminder`</span> dataset:</span>
<span id="cb81-509"><a href="#cb81-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-512"><a href="#cb81-512" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-513"><a href="#cb81-513" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gapminder)</span>
<span id="cb81-514"><a href="#cb81-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-515"><a href="#cb81-515" aria-hidden="true" tabindex="-1"></a><span class="co"># rearrange columns</span></span>
<span id="cb81-516"><a href="#cb81-516" aria-hidden="true" tabindex="-1"></a>gap_medium <span class="ot">&lt;-</span> gap_medium[,<span class="fu">names</span>(gapminder)]</span>
<span id="cb81-517"><a href="#cb81-517" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_medium)</span>
<span id="cb81-518"><a href="#cb81-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-519"><a href="#cb81-519" aria-hidden="true" tabindex="-1"></a><span class="co"># arrange by country, continent, and year</span></span>
<span id="cb81-520"><a href="#cb81-520" aria-hidden="true" tabindex="-1"></a>gap_medium <span class="ot">&lt;-</span> gap_medium <span class="sc">|&gt;</span></span>
<span id="cb81-521"><a href="#cb81-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(country, continent, year)</span>
<span id="cb81-522"><a href="#cb81-522" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gap_medium)</span>
<span id="cb81-523"><a href="#cb81-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-524"><a href="#cb81-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-525"><a href="#cb81-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-526"><a href="#cb81-526" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extra Resources </span></span>
<span id="cb81-527"><a href="#cb81-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-528"><a href="#cb81-528" aria-hidden="true" tabindex="-1"></a><span class="in">`dplyr`</span> and <span class="in">`tidyr`</span> have many more functions to help you wrangle and manipulate </span>
<span id="cb81-529"><a href="#cb81-529" aria-hidden="true" tabindex="-1"></a>your data. See the  <span class="co">[</span><span class="ot">Data Wrangling Cheat Sheet</span><span class="co">](https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf)</span> for more.</span>
<span id="cb81-530"><a href="#cb81-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-531"><a href="#cb81-531" aria-hidden="true" tabindex="-1"></a>Here are <span class="co">[</span><span class="ot">some additional functions/verbs</span><span class="co">](https://www.r-bloggers.com/2022/07/eight-r-tidyverse-tips-for-everyday-data-engineering/?utm_source=phpList&amp;utm_medium=email&amp;utm_campaign=R-bloggers-daily&amp;utm_content=HTML)</span> for use with dplyr: </span>
<span id="cb81-532"><a href="#cb81-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-533"><a href="#cb81-533" aria-hidden="true" tabindex="-1"></a>There are some other useful packages in the <span class="co">[</span><span class="ot">tidyverse</span><span class="co">](http://www.tidyverse.org)</span>:</span>
<span id="cb81-534"><a href="#cb81-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-535"><a href="#cb81-535" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`ggplot2`</span> for plotting (We'll cover this in Unit 5)</span>
<span id="cb81-536"><a href="#cb81-536" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`readr`</span> and <span class="in">`haven`</span> for reading in data</span>
<span id="cb81-537"><a href="#cb81-537" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`purrr`</span> for working with lists and operations similar to the <span class="in">`lapply`</span> family introduced in Module 4. </span>
<span id="cb81-538"><a href="#cb81-538" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`stringr`</span>, <span class="in">`lubridate`</span>, <span class="in">`forcats`</span> for manipulating strings, dates, and factors, respectively</span>
<span id="cb81-539"><a href="#cb81-539" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>many many more! Take a peak at the <span class="co">[</span><span class="ot">tidyverse github page</span><span class="co">](https://github.com/tidyverse)</span>...</span>
<span id="cb81-540"><a href="#cb81-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-541"><a href="#cb81-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-542"><a href="#cb81-542" aria-hidden="true" tabindex="-1"></a><span class="fu"># data.table: intro</span></span>
<span id="cb81-543"><a href="#cb81-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-544"><a href="#cb81-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-545"><a href="#cb81-545" aria-hidden="true" tabindex="-1"></a>The *data.table* package provides a lot of functionality for fast manipulation of datasets in memory. data.table can do the standard SQL/dplyr operations such as indexing, merges/joins, assignment, grouping, etc. Plus data.table objects are data frames (i.e., they inherit from data frames) so they are compatible with R code that uses data frames.</span>
<span id="cb81-546"><a href="#cb81-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-547"><a href="#cb81-547" aria-hidden="true" tabindex="-1"></a>If you've got enough memory, data.table can be effective with pretty large datasets (e.g., 10s of gigabytes).</span>
<span id="cb81-548"><a href="#cb81-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-549"><a href="#cb81-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-550"><a href="#cb81-550" aria-hidden="true" tabindex="-1"></a>Let's read in a moderate size CSV with airline departure delay information.</span>
<span id="cb81-551"><a href="#cb81-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-554"><a href="#cb81-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-555"><a href="#cb81-555" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table, <span class="at">quietly =</span> <span class="cn">TRUE</span>, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb81-556"><a href="#cb81-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-557"><a href="#cb81-557" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(air <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>))) <span class="co"># 0.1 sec.</span></span>
<span id="cb81-558"><a href="#cb81-558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-559"><a href="#cb81-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-560"><a href="#cb81-560" aria-hidden="true" tabindex="-1"></a>We'll compare the time for reading to <span class="in">`read.csv`</span> and <span class="in">`readr::read_csv`</span>.</span>
<span id="cb81-561"><a href="#cb81-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-564"><a href="#cb81-564" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-565"><a href="#cb81-565" aria-hidden="true" tabindex="-1"></a>col_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>,</span>
<span id="cb81-566"><a href="#cb81-566" aria-hidden="true" tabindex="-1"></a>               <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"character"</span>, <span class="st">"integer"</span>, <span class="st">"character"</span>,</span>
<span id="cb81-567"><a href="#cb81-567" aria-hidden="true" tabindex="-1"></a>               <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>,</span>
<span id="cb81-568"><a href="#cb81-568" aria-hidden="true" tabindex="-1"></a>               <span class="st">"character"</span>, <span class="st">"character"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>,</span>
<span id="cb81-569"><a href="#cb81-569" aria-hidden="true" tabindex="-1"></a>               <span class="st">"character"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>,</span>
<span id="cb81-570"><a href="#cb81-570" aria-hidden="true" tabindex="-1"></a>               <span class="st">"integer"</span>, <span class="st">"integer"</span>, <span class="st">"integer"</span>)</span>
<span id="cb81-571"><a href="#cb81-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-572"><a href="#cb81-572" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(air <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>)))  <span class="co"># 5.6 sec.</span></span>
<span id="cb81-573"><a href="#cb81-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-574"><a href="#cb81-574" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(air <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>),</span>
<span id="cb81-575"><a href="#cb81-575" aria-hidden="true" tabindex="-1"></a>   <span class="at">colClasses =</span> col_types))   <span class="co"># 1.5 sec.</span></span>
<span id="cb81-576"><a href="#cb81-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-577"><a href="#cb81-577" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(air <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>),</span>
<span id="cb81-578"><a href="#cb81-578" aria-hidden="true" tabindex="-1"></a>   <span class="at">col_types =</span> <span class="st">"iiiiiiiiciciiiiicciiiiciiiiii"</span>))  <span class="co"># 0.9 sec.</span></span>
<span id="cb81-579"><a href="#cb81-579" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-580"><a href="#cb81-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-581"><a href="#cb81-581" aria-hidden="true" tabindex="-1"></a>It doesn't make much difference for that small-ish (50 MB) file, but <span class="in">`fread`</span> should be fast for much larger files, including reading from zipped files or online files.</span>
<span id="cb81-582"><a href="#cb81-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-583"><a href="#cb81-583" aria-hidden="true" tabindex="-1"></a><span class="fu">## data.table syntax</span></span>
<span id="cb81-584"><a href="#cb81-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-585"><a href="#cb81-585" aria-hidden="true" tabindex="-1"></a>Here's some syntax examples:</span>
<span id="cb81-586"><a href="#cb81-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-589"><a href="#cb81-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-590"><a href="#cb81-590" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb81-591"><a href="#cb81-591" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter rows:</span></span>
<span id="cb81-592"><a href="#cb81-592" aria-hidden="true" tabindex="-1"></a>air[Dest <span class="sc">==</span> <span class="st">"BOS"</span> <span class="sc">&amp;</span> DepDelay <span class="sc">&gt;</span> <span class="dv">100</span>]</span>
<span id="cb81-593"><a href="#cb81-593" aria-hidden="true" tabindex="-1"></a><span class="co"># Select columns:</span></span>
<span id="cb81-594"><a href="#cb81-594" aria-hidden="true" tabindex="-1"></a>air[ , <span class="fu">c</span>(<span class="st">"Dest"</span>, <span class="st">"DepDelay"</span>)]</span>
<span id="cb81-595"><a href="#cb81-595" aria-hidden="true" tabindex="-1"></a><span class="co"># Mutate (create new columns):</span></span>
<span id="cb81-596"><a href="#cb81-596" aria-hidden="true" tabindex="-1"></a>air[ , DepDelayHr <span class="sc">:</span><span class="er">=</span> DepDelay <span class="sc">/</span> <span class="dv">60</span>]</span>
<span id="cb81-597"><a href="#cb81-597" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize</span></span>
<span id="cb81-598"><a href="#cb81-598" aria-hidden="true" tabindex="-1"></a>air[ , .(<span class="at">meanDelayByDest =</span> <span class="fu">mean</span>(DepDelay, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), by <span class="ot">=</span> Dest]</span>
<span id="cb81-599"><a href="#cb81-599" aria-hidden="true" tabindex="-1"></a><span class="co"># Chaining operations (ugly!):</span></span>
<span id="cb81-600"><a href="#cb81-600" aria-hidden="true" tabindex="-1"></a>air[ , DepDelayHr <span class="sc">:</span><span class="er">=</span> DepDelay <span class="sc">/</span> <span class="dv">60</span>][ , .(<span class="at">meanDelayByDest =</span> <span class="fu">mean</span>(DepDelayHr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), by <span class="ot">=</span> Dest]</span>
<span id="cb81-601"><a href="#cb81-601" aria-hidden="true" tabindex="-1"></a><span class="co"># Join:</span></span>
<span id="cb81-602"><a href="#cb81-602" aria-hidden="true" tabindex="-1"></a>air[another_dt, on <span class="ot">=</span> <span class="st">"keycolumn"</span>]</span>
<span id="cb81-603"><a href="#cb81-603" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort:</span></span>
<span id="cb81-604"><a href="#cb81-604" aria-hidden="true" tabindex="-1"></a>air[<span class="fu">order</span>(Dest, <span class="sc">-</span>DepDelay)]</span>
<span id="cb81-605"><a href="#cb81-605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-606"><a href="#cb81-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-607"><a href="#cb81-607" aria-hidden="true" tabindex="-1"></a>An important area for efficiency is to use an index, which can improve lookup speed dramatically. For this small dataset, everyting is fast already, so it's not a good example.</span>
<span id="cb81-608"><a href="#cb81-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-609"><a href="#cb81-609" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, index}</span></span>
<span id="cb81-610"><a href="#cb81-610" aria-hidden="true" tabindex="-1"></a><span class="in">air &lt;- fread(file.path('..', 'data', 'airline.csv'))</span></span>
<span id="cb81-611"><a href="#cb81-611" aria-hidden="true" tabindex="-1"></a><span class="in">## Subset without an index</span></span>
<span id="cb81-612"><a href="#cb81-612" aria-hidden="true" tabindex="-1"></a><span class="in">system.time(sub &lt;- air[Dest == "BOS"])  </span></span>
<span id="cb81-613"><a href="#cb81-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-614"><a href="#cb81-614" aria-hidden="true" tabindex="-1"></a><span class="in">## Now set index and subset</span></span>
<span id="cb81-615"><a href="#cb81-615" aria-hidden="true" tabindex="-1"></a><span class="in">system.time(setindex(air, Dest))</span></span>
<span id="cb81-616"><a href="#cb81-616" aria-hidden="true" tabindex="-1"></a><span class="in">system.time(sub2 &lt;- air[Dest == "BOS"]) # essentially instantaneous</span></span>
<span id="cb81-617"><a href="#cb81-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-618"><a href="#cb81-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-619"><a href="#cb81-619" aria-hidden="true" tabindex="-1"></a>data.table has a lot of functionality and can be used to do a variety of sophisticated queries and manipulations (including aggregation operations), but it has its own somewhat involved syntax and concepts. The above just scratches the surface of what you can do with it. </span>
<span id="cb81-620"><a href="#cb81-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-621"><a href="#cb81-621" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using dplyr syntax with data.table </span></span>
<span id="cb81-622"><a href="#cb81-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-623"><a href="#cb81-623" aria-hidden="true" tabindex="-1"></a>Rather than learning the data.table syntax, one can also use dplyr syntax with data.table objects.</span>
<span id="cb81-624"><a href="#cb81-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-625"><a href="#cb81-625" aria-hidden="true" tabindex="-1"></a>We can use dplyr syntax directly with data table objects, but the efficiency may not be what you want.</span>
<span id="cb81-626"><a href="#cb81-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-627"><a href="#cb81-627" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, dtplusdplyr}</span></span>
<span id="cb81-628"><a href="#cb81-628" aria-hidden="true" tabindex="-1"></a><span class="in">air &lt;- fread(file.path('..', 'data', 'airline.csv'))</span></span>
<span id="cb81-629"><a href="#cb81-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-630"><a href="#cb81-630" aria-hidden="true" tabindex="-1"></a><span class="in">system.time(result &lt;- air[ , .(meanDelayByDest = mean(DepDelay, na.rm = TRUE)), by = Dest])  # 0.008 sec.</span></span>
<span id="cb81-631"><a href="#cb81-631" aria-hidden="true" tabindex="-1"></a><span class="in">system.time(result &lt;- air |&gt; group_by(Dest) |&gt; summarize(meanDepDelay = mean(DepDelay)))   # 0.019 sec.</span></span>
<span id="cb81-632"><a href="#cb81-632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-633"><a href="#cb81-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-634"><a href="#cb81-634" aria-hidden="true" tabindex="-1"></a>Instead, one can also use <span class="in">`dtplyr`</span> to set use a data table as a back end for dplyr manipulations. Using <span class="in">`lazy_dt`</span> allows dtplyr to do some optimization as it generates the translation from dplyr syntax to data table syntax, though this simple example doesn't illustrate the usefulness of that (and using <span class="in">`system.time`</span> for fine differentiation of timing is not generally a good idea). </span>
<span id="cb81-635"><a href="#cb81-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-636"><a href="#cb81-636" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, dtplyr}</span></span>
<span id="cb81-637"><a href="#cb81-637" aria-hidden="true" tabindex="-1"></a><span class="in">library(dtplyr)</span></span>
<span id="cb81-638"><a href="#cb81-638" aria-hidden="true" tabindex="-1"></a><span class="in">lazy_air &lt;- lazy_dt(air)</span></span>
<span id="cb81-639"><a href="#cb81-639" aria-hidden="true" tabindex="-1"></a><span class="in">system.time(result &lt;- lazy_air |&gt; group_by(Dest) |&gt; summarize(meanDepDelay = mean(DepDelay))) # 0.007</span></span>
<span id="cb81-640"><a href="#cb81-640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-641"><a href="#cb81-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-642"><a href="#cb81-642" aria-hidden="true" tabindex="-1"></a>Finally the <span class="in">`tidytable`</span> package (not shown) also allows you to use dplyr syntax as well as other tidyverse syntax, such as <span class="in">`tidyr`</span> functions. </span>
<span id="cb81-643"><a href="#cb81-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-644"><a href="#cb81-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-645"><a href="#cb81-645" aria-hidden="true" tabindex="-1"></a><span class="fu">## Working with data on disk</span></span>
<span id="cb81-646"><a href="#cb81-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-647"><a href="#cb81-647" aria-hidden="true" tabindex="-1"></a>In some cases you may not have enough memory to use tools that bring all the data into memory in R.</span>
<span id="cb81-648"><a href="#cb81-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-649"><a href="#cb81-649" aria-hidden="true" tabindex="-1"></a>Some alternatives include:</span>
<span id="cb81-650"><a href="#cb81-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-651"><a href="#cb81-651" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>DuckDB (or SQLite) databases, accessed from R</span>
<span id="cb81-652"><a href="#cb81-652" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Using Apache Arrow via the <span class="in">`arrow`</span> package</span>
<span id="cb81-653"><a href="#cb81-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-654"><a href="#cb81-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-655"><a href="#cb81-655" aria-hidden="true" tabindex="-1"></a>Or you may need to move to another language, such as using Dask in Python, or database/data lake functionality provided by clould providers.</span>
<span id="cb81-656"><a href="#cb81-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-657"><a href="#cb81-657" aria-hidden="true" tabindex="-1"></a><span class="fu"># Databases</span></span>
<span id="cb81-658"><a href="#cb81-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-659"><a href="#cb81-659" aria-hidden="true" tabindex="-1"></a>These days, most people interact with databases from a language like R or Python.</span>
<span id="cb81-660"><a href="#cb81-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-661"><a href="#cb81-661" aria-hidden="true" tabindex="-1"></a>R has the capability to read and write from a variety of relational database management systems (DBMS). Basically a database is a collection of rectangular format datasets (tables). Some of these tables have fields in common so it makes sense to merge (i.e., join) information from multiple tables. E.g., you might have a database with a table of student information, a table of teacher information and a table of school information. </span>
<span id="cb81-662"><a href="#cb81-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-663"><a href="#cb81-663" aria-hidden="true" tabindex="-1"></a>The *DBI* package provides a front-end for manipulating databases from a variety of DBMS (MySQL, DuckDB, SQLite, Oracle, among others).</span>
<span id="cb81-664"><a href="#cb81-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-665"><a href="#cb81-665" aria-hidden="true" tabindex="-1"></a>DuckDB is a nice alternative to SQLite for a simple database (just a single file) that is fast to use for data analysis work (it uses columnar storage).</span>
<span id="cb81-666"><a href="#cb81-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-667"><a href="#cb81-667" aria-hidden="true" tabindex="-1"></a>Basically, you tell the package what DBMS is being used on the back-end, link to the actual database, and then you can use the standard functions in the package regardless of the back-end. </span>
<span id="cb81-668"><a href="#cb81-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-669"><a href="#cb81-669" aria-hidden="true" tabindex="-1"></a><span class="fu"># Database example</span></span>
<span id="cb81-670"><a href="#cb81-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-671"><a href="#cb81-671" aria-hidden="true" tabindex="-1"></a>You can get an example database of information about Stack Overflow questions and answers from <span class="co">[</span><span class="ot">http://www.stat.berkeley.edu/share/paciorek/stackoverflow-2016.duckdb</span><span class="co">](http://www.stat.berkeley.edu/share/paciorek/stackoverflow-2016.duckdb)</span>. Stack Overflow is a website where programmers and software users can pose questions and get answers to technical problems.</span>
<span id="cb81-672"><a href="#cb81-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-673"><a href="#cb81-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-676"><a href="#cb81-676" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb81-677"><a href="#cb81-677" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb81-678"><a href="#cb81-678" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(duckdb)  <span class="co"># DBI is a dependency</span></span>
<span id="cb81-679"><a href="#cb81-679" aria-hidden="true" tabindex="-1"></a>dbfile <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">".."</span>, <span class="st">"data"</span>, <span class="st">"stackoverflow-2021.duckdb"</span>)</span>
<span id="cb81-680"><a href="#cb81-680" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>(), <span class="at">dbname =</span> dbfile)  <span class="co"># This will vary depending on the back-end database</span></span>
<span id="cb81-681"><a href="#cb81-681" aria-hidden="true" tabindex="-1"></a><span class="do">## stackoverflow-2016.db is an DuckDB database</span></span>
<span id="cb81-682"><a href="#cb81-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-683"><a href="#cb81-683" aria-hidden="true" tabindex="-1"></a><span class="do">## The syntax below works regardless of the back-end database.</span></span>
<span id="cb81-684"><a href="#cb81-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-685"><a href="#cb81-685" aria-hidden="true" tabindex="-1"></a><span class="do">## metadata</span></span>
<span id="cb81-686"><a href="#cb81-686" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListTables</span>(db)</span>
<span id="cb81-687"><a href="#cb81-687" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListFields</span>(db, <span class="st">"questions"</span>)</span>
<span id="cb81-688"><a href="#cb81-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-689"><a href="#cb81-689" aria-hidden="true" tabindex="-1"></a><span class="do">## A simple filter operation:</span></span>
<span id="cb81-690"><a href="#cb81-690" aria-hidden="true" tabindex="-1"></a>popular <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(db, <span class="st">"select * from questions </span></span>
<span id="cb81-691"><a href="#cb81-691" aria-hidden="true" tabindex="-1"></a><span class="st">   where viewcount &gt; 10000"</span>)</span>
<span id="cb81-692"><a href="#cb81-692" aria-hidden="true" tabindex="-1"></a><span class="do">## A join followed by a filter operation:</span></span>
<span id="cb81-693"><a href="#cb81-693" aria-hidden="true" tabindex="-1"></a>popularR <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(db, <span class="st">"select * from questions join questions_tags</span></span>
<span id="cb81-694"><a href="#cb81-694" aria-hidden="true" tabindex="-1"></a><span class="st">   on questions.questionid = questions_tags.questionid</span></span>
<span id="cb81-695"><a href="#cb81-695" aria-hidden="true" tabindex="-1"></a><span class="st">   where viewcount &gt; 10000 and</span></span>
<span id="cb81-696"><a href="#cb81-696" aria-hidden="true" tabindex="-1"></a><span class="st">   tag = 'r'"</span>)</span>
<span id="cb81-697"><a href="#cb81-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-698"><a href="#cb81-698" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(db)</span>
<span id="cb81-699"><a href="#cb81-699" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb81-700"><a href="#cb81-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-701"><a href="#cb81-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-702"><a href="#cb81-702" aria-hidden="true" tabindex="-1"></a><span class="fu"># Breakout</span></span>
<span id="cb81-703"><a href="#cb81-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-704"><a href="#cb81-704" aria-hidden="true" tabindex="-1"></a><span class="fu">### `dplyr`</span></span>
<span id="cb81-705"><a href="#cb81-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-706"><a href="#cb81-706" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use <span class="in">`dplyr`</span> to create a data frame containing the median <span class="in">`lifeExp`</span> for each continent</span>
<span id="cb81-707"><a href="#cb81-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-708"><a href="#cb81-708" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Use <span class="in">`dplyr`</span> to add a column to the gapminder dataset that contains the total population of the continent of each observation in a given year. For example, if the first observation is Afghanistan in 1952, the new column would contain the population of Asia in 1952.</span>
<span id="cb81-709"><a href="#cb81-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-710"><a href="#cb81-710" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Use <span class="in">`dplyr`</span> to add a column called <span class="in">`gdpPercap_diff`</span> that contains the difference between the observation's <span class="in">`gdpPercap`</span> and the mean <span class="in">`gdpPercap`</span> of the continent in that year. Arrange the data frame by the column you just created, in descending order (so that the relatively richest country/years are listed first)</span>
<span id="cb81-711"><a href="#cb81-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-712"><a href="#cb81-712" aria-hidden="true" tabindex="-1"></a><span class="fu">### `tidyr`</span></span>
<span id="cb81-713"><a href="#cb81-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-714"><a href="#cb81-714" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Subset the results from question #3 to select only the <span class="in">`country`</span>, <span class="in">`year`</span>, and <span class="in">`gdpPercap_diff`</span> columns. Use tidyr put it in wide format so that countries are rows and years are columns.</span>
<span id="cb81-715"><a href="#cb81-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-716"><a href="#cb81-716" aria-hidden="true" tabindex="-1"></a>Hint: you'll probably see a message about a missing grouping variable. If you don't want continent included, you can pass the output of problem 3 through <span class="in">`ungroup()`</span> to get rid of the continent information.</span>
<span id="cb81-717"><a href="#cb81-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-718"><a href="#cb81-718" aria-hidden="true" tabindex="-1"></a><span class="fu">### `data.table`</span></span>
<span id="cb81-719"><a href="#cb81-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-720"><a href="#cb81-720" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Compare timing of some operations on the airline dataset when using <span class="in">`dtplyr`</span> with <span class="in">`lazy_air`</span> versus directly applying dplyr syntax to the <span class="in">`air`</span> <span class="in">`data.table`</span>.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>