<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Calculations and Efficiency</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="calculation_files/libs/clipboard/clipboard.min.js"></script>
<script src="calculation_files/libs/quarto-html/quarto.js"></script>
<script src="calculation_files/libs/quarto-html/popper.min.js"></script>
<script src="calculation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="calculation_files/libs/quarto-html/anchor.min.js"></script>
<link href="calculation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="calculation_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="calculation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="calculation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="calculation_files/libs/bootstrap/bootstrap-694e49c76f91d91140b872e73c709757.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/styles.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#vectorized-calculations-and-comparisons" id="toc-vectorized-calculations-and-comparisons" class="nav-link active" data-scroll-target="#vectorized-calculations-and-comparisons">Vectorized calculations and comparisons</a></li>
  <li><a href="#recycling" id="toc-recycling" class="nav-link" data-scroll-target="#recycling">Recycling</a></li>
  <li><a href="#why-vectorize" id="toc-why-vectorize" class="nav-link" data-scroll-target="#why-vectorize">Why vectorize?</a></li>
  <li><a href="#vectorized-vectormatrix-calculations" id="toc-vectorized-vectormatrix-calculations" class="nav-link" data-scroll-target="#vectorized-vectormatrix-calculations">Vectorized vector/matrix calculations</a>
  <ul class="collapse">
  <li><a href="#vectorized-arithmetic" id="toc-vectorized-arithmetic" class="nav-link" data-scroll-target="#vectorized-arithmetic">Vectorized arithmetic</a></li>
  <li><a href="#linear-algebra-matrixvector-multiplication" id="toc-linear-algebra-matrixvector-multiplication" class="nav-link" data-scroll-target="#linear-algebra-matrixvector-multiplication">Linear algebra: Matrix/vector multiplication</a></li>
  <li><a href="#matrix-and-array-internals" id="toc-matrix-and-array-internals" class="nav-link" data-scroll-target="#matrix-and-array-internals">Matrix (and array) internals</a></li>
  </ul></li>
  <li><a href="#linear-algebra" id="toc-linear-algebra" class="nav-link" data-scroll-target="#linear-algebra">Linear algebra</a></li>
  <li><a href="#matrix-decompositions" id="toc-matrix-decompositions" class="nav-link" data-scroll-target="#matrix-decompositions">Matrix decompositions</a></li>
  <li><a href="#pre-allocation" id="toc-pre-allocation" class="nav-link" data-scroll-target="#pre-allocation">Pre-allocation</a></li>
  <li><a href="#the-answer-is-to-pre-allocate-memory" id="toc-the-answer-is-to-pre-allocate-memory" class="nav-link" data-scroll-target="#the-answer-is-to-pre-allocate-memory">The answer is to pre-allocate memory</a></li>
  <li><a href="#apply" id="toc-apply" class="nav-link" data-scroll-target="#apply">apply</a></li>
  <li><a href="#lapply-and-sapply" id="toc-lapply-and-sapply" class="nav-link" data-scroll-target="#lapply-and-sapply"><code>lapply()</code> and <code>sapply()</code></a></li>
  <li><a href="#lapply-and-sapply-with-vectors" id="toc-lapply-and-sapply-with-vectors" class="nav-link" data-scroll-target="#lapply-and-sapply-with-vectors"><code>lapply()</code> and <code>sapply()</code> with vectors</a></li>
  <li><a href="#whenwhy-are-loops-in-r-slow" id="toc-whenwhy-are-loops-in-r-slow" class="nav-link" data-scroll-target="#whenwhy-are-loops-in-r-slow">When/why are loops in R slow?</a></li>
  <li><a href="#when-are-loops-not-slow" id="toc-when-are-loops-not-slow" class="nav-link" data-scroll-target="#when-are-loops-not-slow">When are loops not slow?</a></li>
  <li><a href="#some-efficiency-tips-not-r-specific" id="toc-some-efficiency-tips-not-r-specific" class="nav-link" data-scroll-target="#some-efficiency-tips-not-r-specific">Some efficiency tips (not R-specific)</a></li>
  <li><a href="#timing-your-code" id="toc-timing-your-code" class="nav-link" data-scroll-target="#timing-your-code">Timing your code</a></li>
  <li><a href="#microbenchmark" id="toc-microbenchmark" class="nav-link" data-scroll-target="#microbenchmark">Microbenchmark</a></li>
  <li><a href="#memory-use" id="toc-memory-use" class="nav-link" data-scroll-target="#memory-use">Memory use</a></li>
  <li><a href="#garbage-collection" id="toc-garbage-collection" class="nav-link" data-scroll-target="#garbage-collection">Garbage collection</a></li>
  <li><a href="#copy-on-modify" id="toc-copy-on-modify" class="nav-link" data-scroll-target="#copy-on-modify">Copy-on-modify</a></li>
  <li><a href="#memory-and-lists" id="toc-memory-and-lists" class="nav-link" data-scroll-target="#memory-and-lists">Memory and lists</a>
  <ul class="collapse">
  <li><a href="#basics" id="toc-basics" class="nav-link" data-scroll-target="#basics">Basics</a></li>
  <li><a href="#using-the-ideas" id="toc-using-the-ideas" class="nav-link" data-scroll-target="#using-the-ideas">Using the ideas</a></li>
  <li><a href="#advanced" id="toc-advanced" class="nav-link" data-scroll-target="#advanced">Advanced</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Calculations and Efficiency</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="vectorized-calculations-and-comparisons" class="level1">
<h1>Vectorized calculations and comparisons</h1>
<p>At the core of R is the idea of doing calculations on entire vectors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Vectorized arithmetic</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>gdpTotal <span class="ot">&lt;-</span> gapminder<span class="sc">$</span>gdpPercap <span class="sc">*</span> gapminder<span class="sc">$</span>pop</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>gapminder2007 <span class="ot">&lt;-</span> gapminder[gapminder<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2007</span>, ]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Vectorized comparisons</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>wealthy <span class="ot">&lt;-</span> gapminder2007<span class="sc">$</span>gdpPercap <span class="sc">&gt;=</span> <span class="dv">30000</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>poorOrWealthy <span class="ot">&lt;-</span> gapminder2007<span class="sc">$</span>gdpPercap <span class="sc">&gt;=</span> <span class="dv">100000</span> <span class="sc">|</span> gapminder2007<span class="sc">$</span>gdpPercap <span class="sc">&lt;</span> <span class="dv">1000</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>asiaWealthy <span class="ot">&lt;-</span> gapminder2007<span class="sc">$</span>gdpPercap <span class="sc">&gt;=</span> <span class="dv">100000</span> <span class="sc">&amp;</span>  gapminder<span class="sc">$</span>continent <span class="sc">==</span> <span class="st">"Asia"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>vec1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>vec2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>vec1 <span class="sc">&gt;</span> vec2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE FALSE  TRUE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Vectorized boolean operations</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>vec1 <span class="sc">==</span> vec2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE FALSE FALSE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>vec1 <span class="sc">!=</span> vec2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE TRUE TRUE TRUE TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">## careful: </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>vec1 <span class="ot">=</span> vec2</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(vec1, vec2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
<section id="recycling" class="level1">
<h1>Recycling</h1>
<p>An important related concept is that of recycling</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>vec10 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">10</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>vec3 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">3</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>vec5 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">5</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>vec10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 6 4 3 8 9 3 2 3 8 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>vec3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9 5 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>vec5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 3 4 6 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>vec10 <span class="sc">+</span> vec5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  8  7  7 14 14  5  5  7 14 10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>vec10 <span class="sc">+</span> vec3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in vec10 + vec3: longer object length is not a multiple of shorter
object length</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 15  9  8 17 14  8 11  8 13 14</code></pre>
</div>
</div>
<p>What choices were made by the R developers?</p>
</section>
<section id="why-vectorize" class="level1">
<h1>Why vectorize?</h1>
<p>Imagine how this code would look if written using a loop, or three separate loops.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>chi2vals <span class="ot">&lt;-</span> vals<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>chi2_df1000 <span class="ot">&lt;-</span> <span class="fu">sum</span>(chi2vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Advantages:</p>
<ul>
<li>much faster than looping</li>
<li>easier to code</li>
<li>easier to read and understand the code</li>
</ul>
<p>Vectorized code is generally fast because the underlying loop is executed in compiled C code rather than by the R interpreter.</p>
<p>We’ve already seen that lots of functions (and operators) in R are vectorized (i.e., they can take a single value or a vector as an input argument).</p>
</section>
<section id="vectorized-vectormatrix-calculations" class="level1">
<h1>Vectorized vector/matrix calculations</h1>
<section id="vectorized-arithmetic" class="level2">
<h2 class="anchored" data-anchor-id="vectorized-arithmetic">Vectorized arithmetic</h2>
<p>Recall that <code>+</code>, <code>-</code>,<code>*</code>, <code>/</code> do vectorized calculations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="dv">3</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">seq</span>(<span class="dv">4</span>,<span class="dv">36</span>, <span class="at">by =</span> <span class="dv">4</span>), <span class="dv">3</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>A<span class="sc">*</span><span class="dv">7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    7   28   49
[2,]   14   35   56
[3,]   21   42   63</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>A <span class="sc">+</span> B</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    5   20   35
[2,]   10   25   40
[3,]   15   30   45</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>A <span class="sc">+</span> B[ , <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    5    8   11
[2,]   10   13   16
[3,]   15   18   21</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>A <span class="sc">*</span> B</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    4   64  196
[2,]   16  100  256
[3,]   36  144  324</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>A <span class="sc">*</span> B[ , <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    4   16   28
[2,]   16   40   64
[3,]   36   72  108</code></pre>
</div>
</div>
</section>
<section id="linear-algebra-matrixvector-multiplication" class="level2">
<h2 class="anchored" data-anchor-id="linear-algebra-matrixvector-multiplication">Linear algebra: Matrix/vector multiplication</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>A <span class="sc">%*%</span> B[ , <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]
[1,]  120
[2,]  144
[3,]  168</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>A <span class="sc">%*%</span> B</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]  120  264  408
[2,]  144  324  504
[3,]  168  384  600</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">t</span>(A)<span class="sc">%*%</span>A, <span class="fu">crossprod</span>(A))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Now let’s do a bit of manipulation and see if you can infer how R represents matrices internally.</p>
</section>
<section id="matrix-and-array-internals" class="level2">
<h2 class="anchored" data-anchor-id="matrix-and-array-internals">Matrix (and array) internals</h2>
<div class="callout callout-style-default callout-tip callout-titled" title="Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider our matrix ‘mat’:</p>
<pre><code>mat &lt;- matrix(1:16, nrow = 4, ncol = 4)
     [,1] [,2] [,3] [,4]
[1,]    1    5    9   13
[2,]    2    6   10   14
[3,]    3    7   11   15
[4,]    4    8   12   16</code></pre>
<p>Suppose I run this code: <code>mat[4]</code>.</p>
<p>What do you think will be returned?</p>
<ol type="1">
<li>13</li>
<li>4</li>
<li>13, 14, 15, 16</li>
<li>4, 8, 12, 16</li>
<li>an error</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Answer">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Matrices are stored column-major</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>mat[<span class="dv">4</span>]</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(mat) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>mat</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">is.matrix</span>(mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is like Fortran, MATLAB and Julia but not like C or Python(numpy).</p>
</div>
</div>
</div>
</section>
</section>
<section id="linear-algebra" class="level1">
<h1>Linear algebra</h1>
<p>R can do essentially any linear algebra you need. It uses system-level packages called BLAS (basic linear algebra subroutines) and LAPACK (linear algebra package). Note that these calculations will be essentially as fast as if you wrote C code because R just calls C and Fortran routines to do the calculations.</p>
<p>The BLAS that comes with R is fairly slow. It’s possible to use a <a href="https://statistics.berkeley.edu/computing/faqs/linear-algebra-and-parallelized-linear-algebra-using-blas">faster BLAS, as well as one that uses multiple cores automatically</a>. This can in some cases give you an order of magnitude speedup if your work involves a lot of matrix manipulations/linear algebra.</p>
</section>
<section id="matrix-decompositions" class="level1">
<h1>Matrix decompositions</h1>
<p>Here are some examples of common matrix decompositions: Cholesky decomposition, eigenvalues/eigenvectors, and SVD. These all use BLAS+LAPACK.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="do">## next 3 lines generate a positive definite matrix</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fields)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: spam</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Spam version 2.11-1 (2025-01-20) is loaded.
Type 'help( Spam)' or 'demo( spam)' for a short introduction 
and overview of this package.
Help for individual functions is also obtained by adding the
suffix '.spam' to the function name, e.g. 'help( chol.spam)'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'spam'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    backsolve, forwardsolve</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: viridisLite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Try help(fields) to get started.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">rdist</span>(times) <span class="sc">/</span> <span class="fl">0.2</span>) <span class="co"># a correlation matrix</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="do">######################################################</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">eigen</span>(R)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(e<span class="sc">$</span>values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  0.02525338 32.85537225</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>e<span class="sc">$</span>vectors[ , <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] 0.05195413 0.05448567 0.05698864 0.05946173 0.06190363 0.06431308
  [7] 0.06668879 0.06902954 0.07133409 0.07360123 0.07582978 0.07801856
 [13] 0.08016643 0.08227226 0.08433494 0.08635341 0.08832659 0.09025345
 [19] 0.09213298 0.09396420 0.09574615 0.09747789 0.09915851 0.10078713
 [25] 0.10236291 0.10388500 0.10535262 0.10676499 0.10812137 0.10942106
 [31] 0.11066337 0.11184765 0.11297327 0.11403965 0.11504623 0.11599249
 [37] 0.11687791 0.11770205 0.11846447 0.11916476 0.11980256 0.12037754
 [43] 0.12088940 0.12133786 0.12172270 0.12204370 0.12230071 0.12249358
 [49] 0.12262222 0.12268655 0.12268655 0.12262222 0.12249358 0.12230071
 [55] 0.12204370 0.12172270 0.12133786 0.12088940 0.12037754 0.11980256
 [61] 0.11916476 0.11846447 0.11770205 0.11687791 0.11599249 0.11504623
 [67] 0.11403965 0.11297327 0.11184765 0.11066337 0.10942106 0.10812137
 [73] 0.10676499 0.10535262 0.10388500 0.10236291 0.10078713 0.09915851
 [79] 0.09747789 0.09574615 0.09396420 0.09213298 0.09025345 0.08832659
 [85] 0.08635341 0.08433494 0.08227226 0.08016643 0.07801856 0.07582978
 [91] 0.07360123 0.07133409 0.06902954 0.06668879 0.06431308 0.06190363
 [97] 0.05946173 0.05698864 0.05448567 0.05195413</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>sv <span class="ot">&lt;-</span> <span class="fu">svd</span>(R)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="fu">chol</span>(R)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>devs <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">100</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>Rinvb <span class="ot">&lt;-</span> <span class="fu">solve</span>(R, devs)  <span class="co"># R^{-1} b</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>Rinv <span class="ot">&lt;-</span> <span class="fu">solve</span>(R) <span class="co"># R^{-1} -- try to avoid this (slower and less numerically stable)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pre-allocation" class="level1">
<h1>Pre-allocation</h1>
<p>This is slow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>      vals <span class="ot">&lt;-</span> <span class="fu">c</span>(vals, i)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  2.931   0.057   2.988 </code></pre>
</div>
</div>
<p>The same holds for using <code>rbind()</code>, <code>cbind()</code>, or adding to a list, one element at a time.</p>
<p><strong>Question</strong>: Thoughts on why this are so slow? Think about what R might be doing behind the scenes in terms of storage in memory.</p>
<p><strong>Note</strong>: This is one area where Python and some other languages handle the situation in a more sophisticated way.</p>
</section>
<section id="the-answer-is-to-pre-allocate-memory" class="level1">
<h1>The answer is to pre-allocate memory</h1>
<p>This is not so slow. (Please ignore the fact that this is a silly way to do this in R.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>      vals[i] <span class="ot">&lt;-</span> i</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.005   0.000   0.004 </code></pre>
</div>
</div>
<p>Here’s how to pre-allocate an empty list:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">list</span>(); <span class="fu">length</span>(vals) <span class="ot">&lt;-</span> n</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
NULL

[[2]]
NULL

[[3]]
NULL

[[4]]
NULL

[[5]]
NULL

[[6]]
NULL</code></pre>
</div>
</div>
</section>
<section id="apply" class="level1">
<h1>apply</h1>
<p>Some functions aren’t vectorized, or you may want to use a function on every row or column of a matrix/data frame, every element of a list, etc.</p>
<p>For this we use the <code>apply()</code> family of functions to make our code more readable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">100</span><span class="sc">*</span><span class="dv">1000</span>), <span class="at">nr =</span> <span class="dv">100</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>row_min <span class="ot">&lt;-</span> <span class="fu">apply</span>(mat, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> min)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>col_max <span class="ot">&lt;-</span> <span class="fu">apply</span>(mat, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> max)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are actually some even faster specialized functions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>row_mean <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(mat)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>col_sum <span class="ot">&lt;-</span> <span class="fu">colSums</span>(mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="lapply-and-sapply" class="level1">
<h1><code>lapply()</code> and <code>sapply()</code></h1>
<p>These are “map” operations that apply a function to each element of a list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>myList <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">rnorm</span>(<span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="dv">5</span>))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(myList, min)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] -0.4616358

[[2]]
[1] -0.2413962

[[3]]
[1] -2.782321</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(myList, min)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.4616358 -0.2413962 -2.7823212</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Why use lapply and sapply?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why use lapply and sapply?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The *array functions won’t generally be faster than loops. They’re generally used in order to have cleaner, more readable code.</p>
</div>
</div>
<p>Note that we don’t generally want to use <code>apply()</code> on a data frame.</p>
</section>
<section id="lapply-and-sapply-with-vectors" class="level1">
<h1><code>lapply()</code> and <code>sapply()</code> with vectors</h1>
<p>You can use <code>lapply()</code> and <code>sapply()</code> on regular vectors, such as vectors of indices, which can come in handy. This is a bit silly but it illustrates the idea:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>myfun <span class="ot">&lt;-</span> <span class="cf">function</span>(i) {</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">max</span>(<span class="fu">rnorm</span>(<span class="dv">100</span>))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>}   </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, myfun)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 2.099672

[[2]]
[1] 2.85537

[[3]]
[1] 1.842716

[[4]]
[1] 2.53953

[[5]]
[1] 2.472965

[[6]]
[1] 2.376027</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Or, 'in-line' the function:</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]   1   4   9  16  25  36  49  64  81 100</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Which of these give exactly this result: <code>pi</code>, <code>2*pi</code>, <code>3*pi</code>, …?</p>
<ol type="1">
<li>(1:n)*pi</li>
<li>out &lt;- rep(0, n); for(x in 1:n) out &lt;- x*pi</li>
<li>sapply(1:n, function(x) x*pi)</li>
<li>out &lt;- rep(0, n); for(x in 1:n) out[i] &lt;- x*pi</li>
<li>lapply(1:n, function(x) x*pi)</li>
<li>sapply(1:n, “*“, pi)</li>
<li>1:n*pi</li>
</ol>
</div>
</div>
</section>
<section id="whenwhy-are-loops-in-r-slow" class="level1">
<h1>When/why are loops in R slow?</h1>
<p>Consider this code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>x<span class="sc">*</span><span class="dv">7</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">'hi'</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>x<span class="sc">*</span><span class="dv">7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>￼ Because of dynamic typing, when the interpreter sees <code>x*7</code> it needs to check if <code>x</code> is something that can be multiplied by 7, including dealing with the fact that <code>x</code> could be a vector with many numbers in it. In addition it needs to (using scoping rules) look up the value of <code>x</code>. (Consider that <code>x</code> might not even exist at the point that <code>x*7</code> is called.) Only then can the multiplication happen.</p>
<p>Let’s consider writing a loop:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) x <span class="ot">&lt;-</span> <span class="st">'hi'</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="fu">rm</span>(x)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  x[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(x[i])</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>}  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>￼ Because of the dynamic typing and lack of compilation, the interpreter needs to check if x exists, if it is a vector of sufficient length, if it contains numeric values, and it needs to go retrieve the required value, EVERY TIME the <code>exp()</code> is executed.</p>
<p>The R interpreter is a C program, so in some sense everything that happens is running as compiled code, but there are lots more things being done to accomplish a given task using interpreted code than if the task had been written directly in code that is compiled. By analogy, consider talking directly to a person in a language you both know compared to talking to a person via an interpreter who has to translate between two languages. Ultimately, the same information gets communicated (hopefully!) but the number of words spoken and time involved is much greater.</p>
</section>
<section id="when-are-loops-not-slow" class="level1">
<h1>When are loops not slow?</h1>
<p>When the bulk of the time in the loop involves actual computation rather than checking, e.g., a loop that fits a separate machine learning model at each iteration.</p>
<p>Conclusions: use vectorization when you can, especially when the individual calculations are fast, but don’t obsess when the individual calculations are intensive (and often will call out to C directly).</p>
</section>
<section id="some-efficiency-tips-not-r-specific" class="level1">
<h1>Some efficiency tips (not R-specific)</h1>
<ul>
<li><p>Consider the order of operations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">^</span><span class="dv">2</span>),n)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">^</span><span class="dv">2</span>),n)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(A <span class="sc">%*%</span> B <span class="sc">%*%</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  2.898   0.694   0.632 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(A <span class="sc">%*%</span> (B <span class="sc">%*%</span> x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.098   0.048   0.036 </code></pre>
</div>
</div></li>
<li><p>Avoid duplicated computation</p>
<ul>
<li>Don’t duplicate operations within iterations of a loop unnecessarily (precompute them)</li>
</ul></li>
<li><p>Try to work with adjacent elements (in memory) of large vectors/matrices/arrays to <a href="https://computing.stat.berkeley.edu/tutorial-efficient-R/efficiency#6-cache-aware-programming">efficiently use the CPU cache</a>.</p>
<ul>
<li>In R, generally work column-wise rather than row-wise with matrices</li>
</ul></li>
<li><p>In R, look up elements by numerical index rather than by name for O(1) computation</p></li>
</ul>
</section>
<section id="timing-your-code" class="level1">
<h1>Timing your code</h1>
<p>First, a cautionary note…</p>
<blockquote class="blockquote">
<p>premature optimization is the root of all evil</p>
<p>— Donald Knuth, 1974</p>
</blockquote>
<p>There are a few tools in R for timing your code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">mean</span>(<span class="fu">rnorm</span>(<span class="fl">1e7</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.603   0.027   0.630 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rbenchmark)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">^</span><span class="dv">2</span>), n)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="fu">benchmark</span>(<span class="fu">t</span>(x) <span class="sc">%*%</span> x,</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">crossprod</span>(x),</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">replications =</span> <span class="dv">5</span>,</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">'replications'</span>, <span class="st">'elapsed'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  replications elapsed
2            5   0.080
1            5   0.178</code></pre>
</div>
</div>
<p>Consider why the automatic crossproduct may be faster than the manual version. Note that <code>crossprod</code> calls out directly to a linear algebra system routine.</p>
</section>
<section id="microbenchmark" class="level1">
<h1>Microbenchmark</h1>
<p>To time code that runs very quickly, you should use the microbenchmark package. Of course one would generally only care about accurately timing quick calculations if a larger operation does the quick calculation very many times. Here’s a comparison of different ways of accessing an element of a dataframe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">vals =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">labs =</span> <span class="fu">c</span>(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>))</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  df[<span class="dv">2</span>,<span class="dv">1</span>],</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>vals[<span class="dv">2</span>],</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  df[<span class="dv">2</span>, <span class="st">'vals'</span>]</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: nanoseconds
          expr  min     lq     mean median     uq   max neval cld
      df[2, 1] 8684 9199.0  9797.05   9497 9824.5 20364   100  a 
    df$vals[2]  642  891.5  1184.58    978 1139.0 16244   100   b
 df[2, "vals"] 8661 9200.0 10079.54   9491 9802.0 58783   100  a </code></pre>
</div>
</div>
</section>
<section id="memory-use" class="level1">
<h1>Memory use</h1>
<p>You should know how much memory (RAM) the computer you are using has and keep in mind how big your objects are and how much memory you code might use. All objects in R are stored in RAM unlike a database or certain tools for working with big data (e.g., Python’s Dask package and certain R packages).</p>
<p>If in total, the jobs on a machine approach the physical RAM, the machine may (depending on how it is set up) start to use the hard disk as ‘virtual memory’. This is called <em>paging</em> or <em>swapping</em>, and once this happens you’re often toast (i.e., your code may take essentially forever to finish). And if paging doesn’t happen, your job will die with an out-of-memory (OOM) error.</p>
<p>You can assess memory use with <code>top</code> or <code>ps</code> or <code>free</code> in Linux/Mac or the Task Manager in Windows.</p>
<p>Often it’s a good idea to roughly estimate how much memory an object will take up even before creating it in R. You can do this with some simple arithmetic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="fl">1e6</span><span class="sc">*</span><span class="dv">10</span>), <span class="fl">1e6</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80000216 bytes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1e6</span> <span class="sc">*</span> <span class="dv">10</span> <span class="sc">*</span><span class="dv">8</span><span class="sc">/</span> <span class="fl">1e6</span>  <span class="co"># direct calculation of Mb</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 80</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">object.size</span>(x), <span class="at">units =</span> <span class="st">'auto'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>76.3 Mb</code></pre>
</div>
</div>
</section>
<section id="garbage-collection" class="level1">
<h1>Garbage collection</h1>
<p>A variable is just a name that references a location (object) in memory. When a name is used for a different object, the memory for the old object is freed to be used again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e8</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>800000048 bytes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.09 GB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">"hello"</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>291 MB</code></pre>
</div>
</div>
</section>
<section id="copy-on-modify" class="level1">
<h1>Copy-on-modify</h1>
<p>The <em>semantics</em> of R say that <code>&lt;-</code> creates a new copy of an object.</p>
<p>The <em>implementation</em> in the R interpreter is that copies are only made when needed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  6.104   0.247   6.355 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>800000048 bytes</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.09 GB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(y <span class="ot">&lt;-</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
      0       0       0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.09 GB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7b8ea2518010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7b8ea2518010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(x[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">3</span>)  <span class="co"># Clearly more time than just modifying one element!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.146   0.221   0.368 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.89 GB</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7b8e72a27010"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0x7b8ea2518010"</code></pre>
</div>
</div>
<p>Internally R manages this by keeping track of how many variables (references) there are to a given object in memory.</p>
</section>
<section id="memory-and-lists" class="level1">
<h1>Memory and lists</h1>
<p><a href="https://stat243.berkeley.edu/stat243-fall-2022/units/unit5-programming.html#how-lists-are-stored">R plays various games with lists and character strings (essentially copy-on-change) to avoid redundant copies of identical data</a>. We won’t go into details.</p>
<section id="basics" class="level3">
<h3 class="anchored" data-anchor-id="basics">Basics</h3>
<ol type="1">
<li><p>Create a vector of GDP per capita in units of Euros rather than dollars.</p></li>
<li><p>Create a vector that concatenates the country and year to create a ‘country-year’ variable in a vectorized way using the string processing functions.</p></li>
<li><p>Use <code>table()</code> to figure out the number of countries available for each continent.</p></li>
</ol>
</section>
<section id="using-the-ideas" class="level3">
<h3 class="anchored" data-anchor-id="using-the-ideas">Using the ideas</h3>
<ol start="4" type="1">
<li><p>Explain the steps of what this code is doing: <code>tmp &lt;- gapminder[ , -which(names(gapminder) == "continent")]</code>.</p></li>
<li><p>Compute the number of NAs in each column of the gapminder dataset using <code>sapply()</code> and making use of the <code>is.na()</code> function. It’s possible to do this without writing a function.</p></li>
<li><p>Suppose we have two categorical variables and we conduct a hypothesis test of independence. The chi-square statistic is:</p></li>
</ol>
<p><span class="math display">\[
\chi^2 = \sum_{i=1}^{n}\sum_{j=1}^{m} \frac{(y_{ij} - e_{ij})^2}{e_{ij}},
\]</span></p>
<p>where <span class="math inline">\(e_{ij} = \frac{y_{i\cdot} y_{\cdot j}}{y_{\cdot \cdot}}\)</span>, with <span class="math inline">\(y_{i\cdot}\)</span> the sum of the values in the i’th row, <span class="math inline">\(y_{\cdot j}\)</span> the sum of values in the j’th column, and <span class="math inline">\(y_{\cdot\cdot}\)</span> the sum of all the values. Suppose I give you a matrix in R with the <span class="math inline">\(y_{ij}\)</span> values.</p>
<p>You can generate a test matrix as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">12</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compute the statistic without <em>any</em> loops as follows:</p>
<ul>
<li>First, assume you have the <em>e</em> matrix. How do you compute the statistic without loops as a function of <code>y</code> and <code>e</code>?</li>
<li>How can you construct the <em>e</em> matrix? Hint: the numerator of <em>e</em> is just an <em>outer product</em> for which the <code>outer()</code> function can be used.</li>
</ul>
</section>
<section id="advanced" class="level3">
<h3 class="anchored" data-anchor-id="advanced">Advanced</h3>
<ol start="7" type="1">
<li>Here’s a cool trick to pull off a particular element of a list of lists:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">a =</span> <span class="fu">list</span>(<span class="at">mn =</span> <span class="dv">7</span>, <span class="at">sd =</span> <span class="dv">3</span>), <span class="at">b =</span> <span class="fu">list</span>(<span class="at">mn =</span> <span class="dv">6</span>,<span class="at">sd =</span> <span class="dv">1</span>), </span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">c =</span> <span class="fu">list</span>(<span class="at">mn =</span> <span class="dv">2</span>, <span class="at">sd =</span> <span class="dv">1</span>))</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(params, <span class="st">"[["</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>a b c 
7 6 2 </code></pre>
</div>
</div>
<p>Explain what that does and why it works.</p>
<p>Hint:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">3</span>)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>test[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># `[[`(test, 2)  # need it commented or R Markdown processing messes it up...</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `+`(3, 7)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb119" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Calculations and Efficiency"</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="co">    css: ../assets/styles.css</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-block-bg: true</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-block-border-left: "#31BAE9"</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: auto</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, chunksetup}</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a><span class="in">#| include: false</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a><span class="in"># include any code here you don't want to show up in the document,</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a><span class="in"># e.g. package and dataset loading</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a><span class="in">rm(list=ls())</span></span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a><span class="in">library(gapminder)</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a><span class="fu"># Vectorized calculations and comparisons</span></span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>At the core of R is the idea of doing calculations on entire vectors.</span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a><span class="do">## Vectorized arithmetic</span></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>gdpTotal <span class="ot">&lt;-</span> gapminder<span class="sc">$</span>gdpPercap <span class="sc">*</span> gapminder<span class="sc">$</span>pop</span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>gapminder2007 <span class="ot">&lt;-</span> gapminder[gapminder<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">2007</span>, ]</span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a><span class="do">## Vectorized comparisons</span></span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>wealthy <span class="ot">&lt;-</span> gapminder2007<span class="sc">$</span>gdpPercap <span class="sc">&gt;=</span> <span class="dv">30000</span></span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>poorOrWealthy <span class="ot">&lt;-</span> gapminder2007<span class="sc">$</span>gdpPercap <span class="sc">&gt;=</span> <span class="dv">100000</span> <span class="sc">|</span> gapminder2007<span class="sc">$</span>gdpPercap <span class="sc">&lt;</span> <span class="dv">1000</span></span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>asiaWealthy <span class="ot">&lt;-</span> gapminder2007<span class="sc">$</span>gdpPercap <span class="sc">&gt;=</span> <span class="dv">100000</span> <span class="sc">&amp;</span>  gapminder<span class="sc">$</span>continent <span class="sc">==</span> <span class="st">"Asia"</span></span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a>vec1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>vec2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a>vec1 <span class="sc">&gt;</span> vec2</span>
<span id="cb119-46"><a href="#cb119-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-47"><a href="#cb119-47" aria-hidden="true" tabindex="-1"></a><span class="do">## Vectorized boolean operations</span></span>
<span id="cb119-48"><a href="#cb119-48" aria-hidden="true" tabindex="-1"></a>vec1 <span class="sc">==</span> vec2</span>
<span id="cb119-49"><a href="#cb119-49" aria-hidden="true" tabindex="-1"></a>vec1 <span class="sc">!=</span> vec2</span>
<span id="cb119-50"><a href="#cb119-50" aria-hidden="true" tabindex="-1"></a><span class="do">## careful: </span></span>
<span id="cb119-51"><a href="#cb119-51" aria-hidden="true" tabindex="-1"></a>vec1 <span class="ot">=</span> vec2</span>
<span id="cb119-52"><a href="#cb119-52" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(vec1, vec2)</span>
<span id="cb119-53"><a href="#cb119-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-54"><a href="#cb119-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-55"><a href="#cb119-55" aria-hidden="true" tabindex="-1"></a><span class="fu"># Recycling</span></span>
<span id="cb119-56"><a href="#cb119-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-57"><a href="#cb119-57" aria-hidden="true" tabindex="-1"></a>An important related concept is that of recycling</span>
<span id="cb119-60"><a href="#cb119-60" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-61"><a href="#cb119-61" aria-hidden="true" tabindex="-1"></a>vec10 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">10</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb119-62"><a href="#cb119-62" aria-hidden="true" tabindex="-1"></a>vec3 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">3</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb119-63"><a href="#cb119-63" aria-hidden="true" tabindex="-1"></a>vec5 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">5</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb119-64"><a href="#cb119-64" aria-hidden="true" tabindex="-1"></a>vec10</span>
<span id="cb119-65"><a href="#cb119-65" aria-hidden="true" tabindex="-1"></a>vec3</span>
<span id="cb119-66"><a href="#cb119-66" aria-hidden="true" tabindex="-1"></a>vec5</span>
<span id="cb119-67"><a href="#cb119-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-68"><a href="#cb119-68" aria-hidden="true" tabindex="-1"></a>vec10 <span class="sc">+</span> vec5</span>
<span id="cb119-69"><a href="#cb119-69" aria-hidden="true" tabindex="-1"></a>vec10 <span class="sc">+</span> vec3</span>
<span id="cb119-70"><a href="#cb119-70" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-71"><a href="#cb119-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-72"><a href="#cb119-72" aria-hidden="true" tabindex="-1"></a>What choices were made by the R developers?</span>
<span id="cb119-73"><a href="#cb119-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-74"><a href="#cb119-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-75"><a href="#cb119-75" aria-hidden="true" tabindex="-1"></a><span class="fu"># Why vectorize?</span></span>
<span id="cb119-76"><a href="#cb119-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-77"><a href="#cb119-77" aria-hidden="true" tabindex="-1"></a>Imagine how this code would look if written using a loop, or three separate loops.</span>
<span id="cb119-78"><a href="#cb119-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-81"><a href="#cb119-81" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-82"><a href="#cb119-82" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb119-83"><a href="#cb119-83" aria-hidden="true" tabindex="-1"></a>chi2vals <span class="ot">&lt;-</span> vals<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb119-84"><a href="#cb119-84" aria-hidden="true" tabindex="-1"></a>chi2_df1000 <span class="ot">&lt;-</span> <span class="fu">sum</span>(chi2vals)</span>
<span id="cb119-85"><a href="#cb119-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-86"><a href="#cb119-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-87"><a href="#cb119-87" aria-hidden="true" tabindex="-1"></a>Advantages:</span>
<span id="cb119-88"><a href="#cb119-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-89"><a href="#cb119-89" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>much faster than looping</span>
<span id="cb119-90"><a href="#cb119-90" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>easier to code</span>
<span id="cb119-91"><a href="#cb119-91" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>easier to read and understand the code</span>
<span id="cb119-92"><a href="#cb119-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-93"><a href="#cb119-93" aria-hidden="true" tabindex="-1"></a>Vectorized code is generally fast because the underlying loop is executed in compiled C code rather than by the R interpreter.</span>
<span id="cb119-94"><a href="#cb119-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-95"><a href="#cb119-95" aria-hidden="true" tabindex="-1"></a>We've already seen that lots of functions (and operators) in R are vectorized (i.e., they can take a single value or a vector as an input argument).</span>
<span id="cb119-96"><a href="#cb119-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-97"><a href="#cb119-97" aria-hidden="true" tabindex="-1"></a><span class="fu"># Vectorized vector/matrix calculations</span></span>
<span id="cb119-98"><a href="#cb119-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-99"><a href="#cb119-99" aria-hidden="true" tabindex="-1"></a><span class="fu">## Vectorized arithmetic </span></span>
<span id="cb119-100"><a href="#cb119-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-101"><a href="#cb119-101" aria-hidden="true" tabindex="-1"></a>Recall that <span class="in">`+`</span>, <span class="in">`-`</span>,<span class="in">`*`</span>, <span class="in">`/`</span> do vectorized calculations:</span>
<span id="cb119-102"><a href="#cb119-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-105"><a href="#cb119-105" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-106"><a href="#cb119-106" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="dv">3</span>)</span>
<span id="cb119-107"><a href="#cb119-107" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">seq</span>(<span class="dv">4</span>,<span class="dv">36</span>, <span class="at">by =</span> <span class="dv">4</span>), <span class="dv">3</span>)</span>
<span id="cb119-108"><a href="#cb119-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-109"><a href="#cb119-109" aria-hidden="true" tabindex="-1"></a>A<span class="sc">*</span><span class="dv">7</span></span>
<span id="cb119-110"><a href="#cb119-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-111"><a href="#cb119-111" aria-hidden="true" tabindex="-1"></a>A <span class="sc">+</span> B</span>
<span id="cb119-112"><a href="#cb119-112" aria-hidden="true" tabindex="-1"></a>A <span class="sc">+</span> B[ , <span class="dv">1</span>]</span>
<span id="cb119-113"><a href="#cb119-113" aria-hidden="true" tabindex="-1"></a>A <span class="sc">*</span> B</span>
<span id="cb119-114"><a href="#cb119-114" aria-hidden="true" tabindex="-1"></a>A <span class="sc">*</span> B[ , <span class="dv">1</span>]</span>
<span id="cb119-115"><a href="#cb119-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-116"><a href="#cb119-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-117"><a href="#cb119-117" aria-hidden="true" tabindex="-1"></a><span class="fu">## Linear algebra: Matrix/vector multiplication</span></span>
<span id="cb119-118"><a href="#cb119-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-121"><a href="#cb119-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-122"><a href="#cb119-122" aria-hidden="true" tabindex="-1"></a>A <span class="sc">%*%</span> B[ , <span class="dv">1</span>]</span>
<span id="cb119-123"><a href="#cb119-123" aria-hidden="true" tabindex="-1"></a>A <span class="sc">%*%</span> B</span>
<span id="cb119-124"><a href="#cb119-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-125"><a href="#cb119-125" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">t</span>(A)<span class="sc">%*%</span>A, <span class="fu">crossprod</span>(A))</span>
<span id="cb119-126"><a href="#cb119-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-127"><a href="#cb119-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-128"><a href="#cb119-128" aria-hidden="true" tabindex="-1"></a>Now let's do a bit of manipulation and see if you can infer how R represents matrices internally.</span>
<span id="cb119-129"><a href="#cb119-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-130"><a href="#cb119-130" aria-hidden="true" tabindex="-1"></a><span class="fu">## Matrix (and array) internals</span></span>
<span id="cb119-131"><a href="#cb119-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-132"><a href="#cb119-132" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Question"}</span>
<span id="cb119-133"><a href="#cb119-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-134"><a href="#cb119-134" aria-hidden="true" tabindex="-1"></a>Consider our matrix 'mat':</span>
<span id="cb119-135"><a href="#cb119-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-136"><a href="#cb119-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-137"><a href="#cb119-137" aria-hidden="true" tabindex="-1"></a><span class="in">mat &lt;- matrix(1:16, nrow = 4, ncol = 4)</span></span>
<span id="cb119-138"><a href="#cb119-138" aria-hidden="true" tabindex="-1"></a><span class="in">     [,1] [,2] [,3] [,4]</span></span>
<span id="cb119-139"><a href="#cb119-139" aria-hidden="true" tabindex="-1"></a><span class="in">[1,]    1    5    9   13</span></span>
<span id="cb119-140"><a href="#cb119-140" aria-hidden="true" tabindex="-1"></a><span class="in">[2,]    2    6   10   14</span></span>
<span id="cb119-141"><a href="#cb119-141" aria-hidden="true" tabindex="-1"></a><span class="in">[3,]    3    7   11   15</span></span>
<span id="cb119-142"><a href="#cb119-142" aria-hidden="true" tabindex="-1"></a><span class="in">[4,]    4    8   12   16</span></span>
<span id="cb119-143"><a href="#cb119-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-144"><a href="#cb119-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-145"><a href="#cb119-145" aria-hidden="true" tabindex="-1"></a>Suppose I run this code: <span class="in">`mat[4]`</span>.</span>
<span id="cb119-146"><a href="#cb119-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-147"><a href="#cb119-147" aria-hidden="true" tabindex="-1"></a>What do you think will be returned?</span>
<span id="cb119-148"><a href="#cb119-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-149"><a href="#cb119-149" aria-hidden="true" tabindex="-1"></a>1) 13</span>
<span id="cb119-150"><a href="#cb119-150" aria-hidden="true" tabindex="-1"></a>2) 4</span>
<span id="cb119-151"><a href="#cb119-151" aria-hidden="true" tabindex="-1"></a>3) 13, 14, 15, 16</span>
<span id="cb119-152"><a href="#cb119-152" aria-hidden="true" tabindex="-1"></a>4) 4, 8, 12, 16</span>
<span id="cb119-153"><a href="#cb119-153" aria-hidden="true" tabindex="-1"></a>5) an error</span>
<span id="cb119-154"><a href="#cb119-154" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb119-155"><a href="#cb119-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-156"><a href="#cb119-156" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Answer" collapse="true"}</span>
<span id="cb119-157"><a href="#cb119-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-158"><a href="#cb119-158" aria-hidden="true" tabindex="-1"></a>Matrices are stored column-major</span>
<span id="cb119-159"><a href="#cb119-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-160"><a href="#cb119-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r what_is_a_matrix, eval = FALSE}</span></span>
<span id="cb119-161"><a href="#cb119-161" aria-hidden="true" tabindex="-1"></a><span class="in">mat[4]</span></span>
<span id="cb119-162"><a href="#cb119-162" aria-hidden="true" tabindex="-1"></a><span class="in">attributes(mat) &lt;- NULL</span></span>
<span id="cb119-163"><a href="#cb119-163" aria-hidden="true" tabindex="-1"></a><span class="in">mat</span></span>
<span id="cb119-164"><a href="#cb119-164" aria-hidden="true" tabindex="-1"></a><span class="in">is.matrix(mat)</span></span>
<span id="cb119-165"><a href="#cb119-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-166"><a href="#cb119-166" aria-hidden="true" tabindex="-1"></a>This is like Fortran, MATLAB and Julia but not like C or Python(numpy). </span>
<span id="cb119-167"><a href="#cb119-167" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb119-168"><a href="#cb119-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-169"><a href="#cb119-169" aria-hidden="true" tabindex="-1"></a><span class="fu"># Linear algebra </span></span>
<span id="cb119-170"><a href="#cb119-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-171"><a href="#cb119-171" aria-hidden="true" tabindex="-1"></a>R can do essentially any linear algebra you need. It uses system-level packages called BLAS (basic linear algebra subroutines) and LAPACK (linear algebra package). Note that these calculations will be essentially as fast as if you wrote C code because R just calls C and Fortran routines to do the calculations.</span>
<span id="cb119-172"><a href="#cb119-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-173"><a href="#cb119-173" aria-hidden="true" tabindex="-1"></a>The BLAS that comes with R is fairly slow. It's possible to use a <span class="co">[</span><span class="ot">faster BLAS, as well as one that uses multiple cores automatically</span><span class="co">](https://statistics.berkeley.edu/computing/faqs/linear-algebra-and-parallelized-linear-algebra-using-blas)</span>. This can in some cases give you an order of magnitude speedup if your work involves a lot of matrix manipulations/linear algebra.</span>
<span id="cb119-174"><a href="#cb119-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-175"><a href="#cb119-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-176"><a href="#cb119-176" aria-hidden="true" tabindex="-1"></a><span class="fu"># Matrix decompositions</span></span>
<span id="cb119-177"><a href="#cb119-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-178"><a href="#cb119-178" aria-hidden="true" tabindex="-1"></a>Here are some examples of common matrix decompositions: Cholesky decomposition, eigenvalues/eigenvectors, and SVD. These all use BLAS+LAPACK.</span>
<span id="cb119-179"><a href="#cb119-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-180"><a href="#cb119-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cache=TRUE}</span></span>
<span id="cb119-181"><a href="#cb119-181" aria-hidden="true" tabindex="-1"></a><span class="in">## next 3 lines generate a positive definite matrix</span></span>
<span id="cb119-182"><a href="#cb119-182" aria-hidden="true" tabindex="-1"></a><span class="in">library(fields)</span></span>
<span id="cb119-183"><a href="#cb119-183" aria-hidden="true" tabindex="-1"></a><span class="in">times &lt;- seq(0, 1, length = 100)</span></span>
<span id="cb119-184"><a href="#cb119-184" aria-hidden="true" tabindex="-1"></a><span class="in">R &lt;- exp(-rdist(times) / 0.2) # a correlation matrix</span></span>
<span id="cb119-185"><a href="#cb119-185" aria-hidden="true" tabindex="-1"></a><span class="in">######################################################</span></span>
<span id="cb119-186"><a href="#cb119-186" aria-hidden="true" tabindex="-1"></a><span class="in">e &lt;- eigen(R)</span></span>
<span id="cb119-187"><a href="#cb119-187" aria-hidden="true" tabindex="-1"></a><span class="in">range(e$values)</span></span>
<span id="cb119-188"><a href="#cb119-188" aria-hidden="true" tabindex="-1"></a><span class="in">e$vectors[ , 1]</span></span>
<span id="cb119-189"><a href="#cb119-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-190"><a href="#cb119-190" aria-hidden="true" tabindex="-1"></a><span class="in">sv &lt;- svd(R)</span></span>
<span id="cb119-191"><a href="#cb119-191" aria-hidden="true" tabindex="-1"></a><span class="in">U &lt;- chol(R)</span></span>
<span id="cb119-192"><a href="#cb119-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-193"><a href="#cb119-193" aria-hidden="true" tabindex="-1"></a><span class="in">devs &lt;- rnorm(100)</span></span>
<span id="cb119-194"><a href="#cb119-194" aria-hidden="true" tabindex="-1"></a><span class="in">Rinvb &lt;- solve(R, devs)  # R^{-1} b</span></span>
<span id="cb119-195"><a href="#cb119-195" aria-hidden="true" tabindex="-1"></a><span class="in">Rinv &lt;- solve(R) # R^{-1} -- try to avoid this (slower and less numerically stable)</span></span>
<span id="cb119-196"><a href="#cb119-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-197"><a href="#cb119-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-198"><a href="#cb119-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-199"><a href="#cb119-199" aria-hidden="true" tabindex="-1"></a><span class="fu"># Pre-allocation</span></span>
<span id="cb119-200"><a href="#cb119-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-201"><a href="#cb119-201" aria-hidden="true" tabindex="-1"></a>This is slow.</span>
<span id="cb119-202"><a href="#cb119-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cache=TRUE}</span></span>
<span id="cb119-203"><a href="#cb119-203" aria-hidden="true" tabindex="-1"></a><span class="in">vals &lt;- 0</span></span>
<span id="cb119-204"><a href="#cb119-204" aria-hidden="true" tabindex="-1"></a><span class="in">n &lt;- 50000</span></span>
<span id="cb119-205"><a href="#cb119-205" aria-hidden="true" tabindex="-1"></a><span class="in">system.time({</span></span>
<span id="cb119-206"><a href="#cb119-206" aria-hidden="true" tabindex="-1"></a><span class="in">for(i in 1:n)</span></span>
<span id="cb119-207"><a href="#cb119-207" aria-hidden="true" tabindex="-1"></a><span class="in">      vals &lt;- c(vals, i)</span></span>
<span id="cb119-208"><a href="#cb119-208" aria-hidden="true" tabindex="-1"></a><span class="in">})</span></span>
<span id="cb119-209"><a href="#cb119-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-210"><a href="#cb119-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-211"><a href="#cb119-211" aria-hidden="true" tabindex="-1"></a>The same holds for using <span class="in">`rbind()`</span>, <span class="in">`cbind()`</span>, or adding to a list, one element at a time.</span>
<span id="cb119-212"><a href="#cb119-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-213"><a href="#cb119-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-214"><a href="#cb119-214" aria-hidden="true" tabindex="-1"></a>**Question**: Thoughts on why this are so slow? Think about what R might be doing behind the scenes in terms of storage in memory.</span>
<span id="cb119-215"><a href="#cb119-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-216"><a href="#cb119-216" aria-hidden="true" tabindex="-1"></a>**Note**: This is one area where Python and some other languages handle the situation in a more sophisticated way.</span>
<span id="cb119-217"><a href="#cb119-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-218"><a href="#cb119-218" aria-hidden="true" tabindex="-1"></a><span class="fu"># The answer is to pre-allocate memory</span></span>
<span id="cb119-219"><a href="#cb119-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-220"><a href="#cb119-220" aria-hidden="true" tabindex="-1"></a>This is not so slow. (Please ignore the fact that this is a silly way to do this in R.)</span>
<span id="cb119-221"><a href="#cb119-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-224"><a href="#cb119-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-225"><a href="#cb119-225" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb119-226"><a href="#cb119-226" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb119-227"><a href="#cb119-227" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb119-228"><a href="#cb119-228" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb119-229"><a href="#cb119-229" aria-hidden="true" tabindex="-1"></a>      vals[i] <span class="ot">&lt;-</span> i</span>
<span id="cb119-230"><a href="#cb119-230" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb119-231"><a href="#cb119-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-232"><a href="#cb119-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-233"><a href="#cb119-233" aria-hidden="true" tabindex="-1"></a>Here's how to pre-allocate an empty list: </span>
<span id="cb119-236"><a href="#cb119-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-237"><a href="#cb119-237" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">list</span>(); <span class="fu">length</span>(vals) <span class="ot">&lt;-</span> n</span>
<span id="cb119-238"><a href="#cb119-238" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(vals)</span>
<span id="cb119-239"><a href="#cb119-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-240"><a href="#cb119-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-241"><a href="#cb119-241" aria-hidden="true" tabindex="-1"></a><span class="fu"># apply</span></span>
<span id="cb119-242"><a href="#cb119-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-243"><a href="#cb119-243" aria-hidden="true" tabindex="-1"></a>Some functions aren't vectorized, or you may want to use a function on every row or column of a matrix/data frame, every element of a list, etc.</span>
<span id="cb119-244"><a href="#cb119-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-245"><a href="#cb119-245" aria-hidden="true" tabindex="-1"></a>For this we use the <span class="in">`apply()`</span> family of functions to make our code more readable.</span>
<span id="cb119-246"><a href="#cb119-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-249"><a href="#cb119-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-250"><a href="#cb119-250" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">100</span><span class="sc">*</span><span class="dv">1000</span>), <span class="at">nr =</span> <span class="dv">100</span>)</span>
<span id="cb119-251"><a href="#cb119-251" aria-hidden="true" tabindex="-1"></a>row_min <span class="ot">&lt;-</span> <span class="fu">apply</span>(mat, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> min)</span>
<span id="cb119-252"><a href="#cb119-252" aria-hidden="true" tabindex="-1"></a>col_max <span class="ot">&lt;-</span> <span class="fu">apply</span>(mat, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> max)</span>
<span id="cb119-253"><a href="#cb119-253" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-254"><a href="#cb119-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-255"><a href="#cb119-255" aria-hidden="true" tabindex="-1"></a>There are actually some even faster specialized functions:</span>
<span id="cb119-258"><a href="#cb119-258" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-259"><a href="#cb119-259" aria-hidden="true" tabindex="-1"></a>row_mean <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(mat)</span>
<span id="cb119-260"><a href="#cb119-260" aria-hidden="true" tabindex="-1"></a>col_sum <span class="ot">&lt;-</span> <span class="fu">colSums</span>(mat)</span>
<span id="cb119-261"><a href="#cb119-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-262"><a href="#cb119-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-263"><a href="#cb119-263" aria-hidden="true" tabindex="-1"></a><span class="fu"># `lapply()` and `sapply()`</span></span>
<span id="cb119-264"><a href="#cb119-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-265"><a href="#cb119-265" aria-hidden="true" tabindex="-1"></a>These are "map" operations that apply a function to each element of a list.</span>
<span id="cb119-266"><a href="#cb119-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-269"><a href="#cb119-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-270"><a href="#cb119-270" aria-hidden="true" tabindex="-1"></a>myList <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">rnorm</span>(<span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="dv">5</span>))</span>
<span id="cb119-271"><a href="#cb119-271" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(myList, min)</span>
<span id="cb119-272"><a href="#cb119-272" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(myList, min)</span>
<span id="cb119-273"><a href="#cb119-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-274"><a href="#cb119-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-275"><a href="#cb119-275" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Why use lapply and sapply?"}</span>
<span id="cb119-276"><a href="#cb119-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-277"><a href="#cb119-277" aria-hidden="true" tabindex="-1"></a>The *array functions won't generally be faster than loops. They're generally used in order to have cleaner, more readable code.</span>
<span id="cb119-278"><a href="#cb119-278" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb119-279"><a href="#cb119-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-280"><a href="#cb119-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-281"><a href="#cb119-281" aria-hidden="true" tabindex="-1"></a>Note that we don't generally want to use <span class="in">`apply()`</span> on a data frame. </span>
<span id="cb119-282"><a href="#cb119-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-283"><a href="#cb119-283" aria-hidden="true" tabindex="-1"></a><span class="fu"># `lapply()` and `sapply()` with vectors</span></span>
<span id="cb119-284"><a href="#cb119-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-285"><a href="#cb119-285" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`lapply()`</span> and <span class="in">`sapply()`</span> on regular vectors, such as vectors of indices, which can come in handy. This is a bit silly but it illustrates the idea:</span>
<span id="cb119-286"><a href="#cb119-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-289"><a href="#cb119-289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-290"><a href="#cb119-290" aria-hidden="true" tabindex="-1"></a>myfun <span class="ot">&lt;-</span> <span class="cf">function</span>(i) {</span>
<span id="cb119-291"><a href="#cb119-291" aria-hidden="true" tabindex="-1"></a>   <span class="fu">max</span>(<span class="fu">rnorm</span>(<span class="dv">100</span>))</span>
<span id="cb119-292"><a href="#cb119-292" aria-hidden="true" tabindex="-1"></a>}   </span>
<span id="cb119-293"><a href="#cb119-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-294"><a href="#cb119-294" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, myfun)</span>
<span id="cb119-295"><a href="#cb119-295" aria-hidden="true" tabindex="-1"></a>out</span>
<span id="cb119-296"><a href="#cb119-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-297"><a href="#cb119-297" aria-hidden="true" tabindex="-1"></a><span class="do">## Or, 'in-line' the function:</span></span>
<span id="cb119-298"><a href="#cb119-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-299"><a href="#cb119-299" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb119-300"><a href="#cb119-300" aria-hidden="true" tabindex="-1"></a>out</span>
<span id="cb119-301"><a href="#cb119-301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-302"><a href="#cb119-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-303"><a href="#cb119-303" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Question"}</span>
<span id="cb119-304"><a href="#cb119-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-305"><a href="#cb119-305" aria-hidden="true" tabindex="-1"></a>Which of these give exactly this result: <span class="in">`pi`</span>, <span class="in">`2*pi`</span>, <span class="in">`3*pi`</span>, ...?</span>
<span id="cb119-306"><a href="#cb119-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-307"><a href="#cb119-307" aria-hidden="true" tabindex="-1"></a>1) (1:n)*pi</span>
<span id="cb119-308"><a href="#cb119-308" aria-hidden="true" tabindex="-1"></a>2) out &lt;- rep(0, n); for(x in 1:n) out &lt;- x*pi</span>
<span id="cb119-309"><a href="#cb119-309" aria-hidden="true" tabindex="-1"></a>3) sapply(1:n, function(x) x*pi)</span>
<span id="cb119-310"><a href="#cb119-310" aria-hidden="true" tabindex="-1"></a>4) out &lt;- rep(0, n); for(x in 1:n) out<span class="co">[</span><span class="ot">i</span><span class="co">]</span> &lt;- x*pi</span>
<span id="cb119-311"><a href="#cb119-311" aria-hidden="true" tabindex="-1"></a>5) lapply(1:n, function(x) x*pi)</span>
<span id="cb119-312"><a href="#cb119-312" aria-hidden="true" tabindex="-1"></a>6) sapply(1:n, "*", pi)</span>
<span id="cb119-313"><a href="#cb119-313" aria-hidden="true" tabindex="-1"></a>7) 1:n*pi</span>
<span id="cb119-314"><a href="#cb119-314" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb119-315"><a href="#cb119-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-316"><a href="#cb119-316" aria-hidden="true" tabindex="-1"></a><span class="fu"># When/why are loops in R slow?</span></span>
<span id="cb119-317"><a href="#cb119-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-318"><a href="#cb119-318" aria-hidden="true" tabindex="-1"></a>Consider this code:</span>
<span id="cb119-319"><a href="#cb119-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-322"><a href="#cb119-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-323"><a href="#cb119-323" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb119-324"><a href="#cb119-324" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb119-325"><a href="#cb119-325" aria-hidden="true" tabindex="-1"></a>x<span class="sc">*</span><span class="dv">7</span></span>
<span id="cb119-326"><a href="#cb119-326" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">'hi'</span></span>
<span id="cb119-327"><a href="#cb119-327" aria-hidden="true" tabindex="-1"></a>x<span class="sc">*</span><span class="dv">7</span></span>
<span id="cb119-328"><a href="#cb119-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-329"><a href="#cb119-329" aria-hidden="true" tabindex="-1"></a>￼</span>
<span id="cb119-330"><a href="#cb119-330" aria-hidden="true" tabindex="-1"></a>Because of dynamic typing, when the interpreter sees <span class="in">`x*7`</span> it needs to check if <span class="in">`x`</span> is something that can be multiplied by 7, including dealing with the fact that <span class="in">`x`</span> could be a vector with many numbers in it. In addition it needs to (using scoping rules) look up the value of <span class="in">`x`</span>. (Consider that <span class="in">`x`</span> might not even exist at the point that <span class="in">`x*7`</span> is called.) Only then can the multiplication happen.</span>
<span id="cb119-331"><a href="#cb119-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-332"><a href="#cb119-332" aria-hidden="true" tabindex="-1"></a>Let’s consider writing a loop:</span>
<span id="cb119-333"><a href="#cb119-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-336"><a href="#cb119-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-337"><a href="#cb119-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb119-338"><a href="#cb119-338" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb119-339"><a href="#cb119-339" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) x <span class="ot">&lt;-</span> <span class="st">'hi'</span></span>
<span id="cb119-340"><a href="#cb119-340" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="fu">rm</span>(x)</span>
<span id="cb119-341"><a href="#cb119-341" aria-hidden="true" tabindex="-1"></a>  x[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(x[i])</span>
<span id="cb119-342"><a href="#cb119-342" aria-hidden="true" tabindex="-1"></a>}  </span>
<span id="cb119-343"><a href="#cb119-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-344"><a href="#cb119-344" aria-hidden="true" tabindex="-1"></a>￼</span>
<span id="cb119-345"><a href="#cb119-345" aria-hidden="true" tabindex="-1"></a>Because of the dynamic typing and lack of compilation, the interpreter needs to check if x exists, if it is a vector of sufficient length, if it contains numeric values, and it needs to go retrieve the required value, EVERY TIME the <span class="in">`exp()`</span> is executed.</span>
<span id="cb119-346"><a href="#cb119-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-347"><a href="#cb119-347" aria-hidden="true" tabindex="-1"></a>The R interpreter is a C program, so in some sense everything that happens is running as compiled code, but there are lots more things being done to accomplish a given task using interpreted code than if the task had been written directly in code that is compiled. By analogy, consider talking directly to a person in a language you both know compared to talking to a person via an interpreter who has to translate between two languages. Ultimately, the same information gets communicated (hopefully!) but the number of words spoken and time involved is much greater.</span>
<span id="cb119-348"><a href="#cb119-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-349"><a href="#cb119-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-350"><a href="#cb119-350" aria-hidden="true" tabindex="-1"></a><span class="fu"># When are loops not slow?</span></span>
<span id="cb119-351"><a href="#cb119-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-352"><a href="#cb119-352" aria-hidden="true" tabindex="-1"></a>When the bulk of the time in the loop involves actual computation rather than checking, e.g., a loop that fits a separate machine learning model at each iteration.</span>
<span id="cb119-353"><a href="#cb119-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-354"><a href="#cb119-354" aria-hidden="true" tabindex="-1"></a>Conclusions: use vectorization when you can, especially when the individual calculations are fast, but don't obsess when the individual calculations are intensive (and often will call out to C directly).</span>
<span id="cb119-355"><a href="#cb119-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-356"><a href="#cb119-356" aria-hidden="true" tabindex="-1"></a><span class="fu"># Some efficiency tips (not R-specific)</span></span>
<span id="cb119-357"><a href="#cb119-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-358"><a href="#cb119-358" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Consider the order of operations:</span>
<span id="cb119-359"><a href="#cb119-359" aria-hidden="true" tabindex="-1"></a>  <span class="in">```{r}</span></span>
<span id="cb119-360"><a href="#cb119-360" aria-hidden="true" tabindex="-1"></a><span class="in">  n &lt;- 3000</span></span>
<span id="cb119-361"><a href="#cb119-361" aria-hidden="true" tabindex="-1"></a><span class="in">  A &lt;- matrix(rnorm(n^2),n)</span></span>
<span id="cb119-362"><a href="#cb119-362" aria-hidden="true" tabindex="-1"></a><span class="in">  B &lt;- matrix(rnorm(n^2),n)</span></span>
<span id="cb119-363"><a href="#cb119-363" aria-hidden="true" tabindex="-1"></a><span class="in">  x &lt;- rnorm(n)</span></span>
<span id="cb119-364"><a href="#cb119-364" aria-hidden="true" tabindex="-1"></a><span class="in">  system.time(A %*% B %*% x)</span></span>
<span id="cb119-365"><a href="#cb119-365" aria-hidden="true" tabindex="-1"></a><span class="in">  system.time(A %*% (B %*% x))</span></span>
<span id="cb119-366"><a href="#cb119-366" aria-hidden="true" tabindex="-1"></a><span class="in">  ```</span></span>
<span id="cb119-367"><a href="#cb119-367" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Avoid duplicated computation</span>
<span id="cb119-368"><a href="#cb119-368" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Don't duplicate operations within iterations of a loop unnecessarily (precompute them)</span>
<span id="cb119-369"><a href="#cb119-369" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Try to work with adjacent elements (in memory) of large vectors/matrices/arrays to <span class="co">[</span><span class="ot">efficiently use the CPU cache</span><span class="co">](https://computing.stat.berkeley.edu/tutorial-efficient-R/efficiency#6-cache-aware-programming)</span>.</span>
<span id="cb119-370"><a href="#cb119-370" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>In R, generally work column-wise rather than row-wise with matrices</span>
<span id="cb119-371"><a href="#cb119-371" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In R, look up elements by numerical index rather than by name for O(1) computation</span>
<span id="cb119-372"><a href="#cb119-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-373"><a href="#cb119-373" aria-hidden="true" tabindex="-1"></a><span class="fu"># Timing your code</span></span>
<span id="cb119-374"><a href="#cb119-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-375"><a href="#cb119-375" aria-hidden="true" tabindex="-1"></a>First, a cautionary note...</span>
<span id="cb119-376"><a href="#cb119-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-377"><a href="#cb119-377" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; premature optimization is the root of all evil</span></span>
<span id="cb119-378"><a href="#cb119-378" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;</span></span>
<span id="cb119-379"><a href="#cb119-379" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; --- Donald Knuth, 1974</span></span>
<span id="cb119-380"><a href="#cb119-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-381"><a href="#cb119-381" aria-hidden="true" tabindex="-1"></a>There are a few tools in R for timing your code.</span>
<span id="cb119-382"><a href="#cb119-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-385"><a href="#cb119-385" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-386"><a href="#cb119-386" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb119-387"><a href="#cb119-387" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">mean</span>(<span class="fu">rnorm</span>(<span class="fl">1e7</span>)))</span>
<span id="cb119-388"><a href="#cb119-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-389"><a href="#cb119-389" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rbenchmark)</span>
<span id="cb119-390"><a href="#cb119-390" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb119-391"><a href="#cb119-391" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">^</span><span class="dv">2</span>), n)</span>
<span id="cb119-392"><a href="#cb119-392" aria-hidden="true" tabindex="-1"></a><span class="fu">benchmark</span>(<span class="fu">t</span>(x) <span class="sc">%*%</span> x,</span>
<span id="cb119-393"><a href="#cb119-393" aria-hidden="true" tabindex="-1"></a>          <span class="fu">crossprod</span>(x),</span>
<span id="cb119-394"><a href="#cb119-394" aria-hidden="true" tabindex="-1"></a>          <span class="at">replications =</span> <span class="dv">5</span>,</span>
<span id="cb119-395"><a href="#cb119-395" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">'replications'</span>, <span class="st">'elapsed'</span>))</span>
<span id="cb119-396"><a href="#cb119-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-397"><a href="#cb119-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-398"><a href="#cb119-398" aria-hidden="true" tabindex="-1"></a>Consider why the automatic crossproduct may be faster than the manual version. Note that <span class="in">`crossprod`</span> calls out directly to a linear algebra system routine.</span>
<span id="cb119-399"><a href="#cb119-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-400"><a href="#cb119-400" aria-hidden="true" tabindex="-1"></a><span class="fu"># Microbenchmark</span></span>
<span id="cb119-401"><a href="#cb119-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-402"><a href="#cb119-402" aria-hidden="true" tabindex="-1"></a>To time code that runs very quickly, you should use the microbenchmark package. Of course one would generally only care about accurately timing quick calculations if a larger operation does the quick calculation very many times. Here’s a comparison of different ways of accessing an element of a dataframe.</span>
<span id="cb119-403"><a href="#cb119-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-406"><a href="#cb119-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-407"><a href="#cb119-407" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb119-408"><a href="#cb119-408" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">vals =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">labs =</span> <span class="fu">c</span>(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>))</span>
<span id="cb119-409"><a href="#cb119-409" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb119-410"><a href="#cb119-410" aria-hidden="true" tabindex="-1"></a>  df[<span class="dv">2</span>,<span class="dv">1</span>],</span>
<span id="cb119-411"><a href="#cb119-411" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>vals[<span class="dv">2</span>],</span>
<span id="cb119-412"><a href="#cb119-412" aria-hidden="true" tabindex="-1"></a>  df[<span class="dv">2</span>, <span class="st">'vals'</span>]</span>
<span id="cb119-413"><a href="#cb119-413" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb119-414"><a href="#cb119-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-415"><a href="#cb119-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-416"><a href="#cb119-416" aria-hidden="true" tabindex="-1"></a><span class="fu"># Memory use</span></span>
<span id="cb119-417"><a href="#cb119-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-418"><a href="#cb119-418" aria-hidden="true" tabindex="-1"></a>You should know how much memory (RAM) the computer you are using has and keep in mind how big your objects are and how much memory you code might use. All objects in R are stored in RAM unlike a database or certain tools for working with big data (e.g., Python's Dask package and certain R packages).</span>
<span id="cb119-419"><a href="#cb119-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-420"><a href="#cb119-420" aria-hidden="true" tabindex="-1"></a>If in total, the jobs on a machine approach the physical RAM, the machine may (depending on how it is set up) start to use the hard disk as 'virtual memory'. This is called *paging* or *swapping*, and once this happens you're often toast (i.e., your code may take essentially forever to finish). And if paging doesn't happen, your job will die with an out-of-memory (OOM) error.</span>
<span id="cb119-421"><a href="#cb119-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-422"><a href="#cb119-422" aria-hidden="true" tabindex="-1"></a>You can assess memory use with <span class="in">`top`</span> or <span class="in">`ps`</span> or <span class="in">`free`</span> in Linux/Mac or the Task Manager in Windows.</span>
<span id="cb119-423"><a href="#cb119-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-424"><a href="#cb119-424" aria-hidden="true" tabindex="-1"></a>Often it's a good idea to roughly estimate how much memory an object will take up even before creating it in R. You can do this with some simple arithmetic. </span>
<span id="cb119-425"><a href="#cb119-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-426"><a href="#cb119-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-429"><a href="#cb119-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-430"><a href="#cb119-430" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="fl">1e6</span><span class="sc">*</span><span class="dv">10</span>), <span class="fl">1e6</span>)</span>
<span id="cb119-431"><a href="#cb119-431" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(x)</span>
<span id="cb119-432"><a href="#cb119-432" aria-hidden="true" tabindex="-1"></a><span class="fl">1e6</span> <span class="sc">*</span> <span class="dv">10</span> <span class="sc">*</span><span class="dv">8</span><span class="sc">/</span> <span class="fl">1e6</span>  <span class="co"># direct calculation of Mb</span></span>
<span id="cb119-433"><a href="#cb119-433" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">object.size</span>(x), <span class="at">units =</span> <span class="st">'auto'</span>)</span>
<span id="cb119-434"><a href="#cb119-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-435"><a href="#cb119-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-436"><a href="#cb119-436" aria-hidden="true" tabindex="-1"></a><span class="fu"># Garbage collection</span></span>
<span id="cb119-437"><a href="#cb119-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-438"><a href="#cb119-438" aria-hidden="true" tabindex="-1"></a>A variable is just a name that references a location (object) in memory. When a name is used for a different object, the memory for the old object is freed to be used again.</span>
<span id="cb119-439"><a href="#cb119-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-442"><a href="#cb119-442" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-443"><a href="#cb119-443" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb119-444"><a href="#cb119-444" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e8</span>)</span>
<span id="cb119-445"><a href="#cb119-445" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(x)</span>
<span id="cb119-446"><a href="#cb119-446" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span>
<span id="cb119-447"><a href="#cb119-447" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">"hello"</span></span>
<span id="cb119-448"><a href="#cb119-448" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span>
<span id="cb119-449"><a href="#cb119-449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-450"><a href="#cb119-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-451"><a href="#cb119-451" aria-hidden="true" tabindex="-1"></a><span class="fu"># Copy-on-modify</span></span>
<span id="cb119-452"><a href="#cb119-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-453"><a href="#cb119-453" aria-hidden="true" tabindex="-1"></a>The *semantics* of R say that <span class="in">`&lt;-`</span> creates a new copy of an object.</span>
<span id="cb119-454"><a href="#cb119-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-455"><a href="#cb119-455" aria-hidden="true" tabindex="-1"></a>The *implementation* in the R interpreter  is that copies are only made when needed.</span>
<span id="cb119-456"><a href="#cb119-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-459"><a href="#cb119-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-460"><a href="#cb119-460" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb119-461"><a href="#cb119-461" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e8</span>))</span>
<span id="cb119-462"><a href="#cb119-462" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(x)</span>
<span id="cb119-463"><a href="#cb119-463" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span>
<span id="cb119-464"><a href="#cb119-464" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(y <span class="ot">&lt;-</span> x)</span>
<span id="cb119-465"><a href="#cb119-465" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span>
<span id="cb119-466"><a href="#cb119-466" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span>
<span id="cb119-467"><a href="#cb119-467" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(y)</span>
<span id="cb119-468"><a href="#cb119-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-469"><a href="#cb119-469" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(x[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">3</span>)  <span class="co"># Clearly more time than just modifying one element!</span></span>
<span id="cb119-470"><a href="#cb119-470" aria-hidden="true" tabindex="-1"></a><span class="fu">mem_used</span>()</span>
<span id="cb119-471"><a href="#cb119-471" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(x)</span>
<span id="cb119-472"><a href="#cb119-472" aria-hidden="true" tabindex="-1"></a><span class="fu">address</span>(y)</span>
<span id="cb119-473"><a href="#cb119-473" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-474"><a href="#cb119-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-475"><a href="#cb119-475" aria-hidden="true" tabindex="-1"></a>Internally R manages this by keeping track of how many variables (references) there are to a given object in memory.</span>
<span id="cb119-476"><a href="#cb119-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-477"><a href="#cb119-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-478"><a href="#cb119-478" aria-hidden="true" tabindex="-1"></a><span class="fu"># Memory and lists</span></span>
<span id="cb119-479"><a href="#cb119-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-480"><a href="#cb119-480" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">R plays various games with lists and character strings (essentially copy-on-change) to avoid redundant copies of identical data</span><span class="co">](https://stat243.berkeley.edu/stat243-fall-2022/units/unit5-programming.html#how-lists-are-stored)</span>. We won't go into details.</span>
<span id="cb119-481"><a href="#cb119-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-482"><a href="#cb119-482" aria-hidden="true" tabindex="-1"></a><span class="fu">### Basics</span></span>
<span id="cb119-483"><a href="#cb119-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-484"><a href="#cb119-484" aria-hidden="true" tabindex="-1"></a>1) Create a vector of GDP per capita in units of Euros rather than dollars.</span>
<span id="cb119-485"><a href="#cb119-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-486"><a href="#cb119-486" aria-hidden="true" tabindex="-1"></a>2) Create a vector that concatenates the country and year to create a 'country-year' variable in a vectorized way using the string processing functions.</span>
<span id="cb119-487"><a href="#cb119-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-488"><a href="#cb119-488" aria-hidden="true" tabindex="-1"></a>3) Use <span class="in">`table()`</span> to figure out the number of countries available for each continent.</span>
<span id="cb119-489"><a href="#cb119-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-490"><a href="#cb119-490" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using the ideas</span></span>
<span id="cb119-491"><a href="#cb119-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-492"><a href="#cb119-492" aria-hidden="true" tabindex="-1"></a>4) Explain the steps of what this code is doing: <span class="in">`tmp &lt;- gapminder[ , -which(names(gapminder) == "continent")]`</span>.</span>
<span id="cb119-493"><a href="#cb119-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-494"><a href="#cb119-494" aria-hidden="true" tabindex="-1"></a>5) Compute the number of NAs in each column of the gapminder dataset using <span class="in">`sapply()`</span> and making use of the <span class="in">`is.na()`</span> function. It's possible to do this without writing a function.</span>
<span id="cb119-495"><a href="#cb119-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-496"><a href="#cb119-496" aria-hidden="true" tabindex="-1"></a>6)  Suppose we have two categorical variables and we conduct a hypothesis test of independence. The chi-square statistic is: </span>
<span id="cb119-497"><a href="#cb119-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-498"><a href="#cb119-498" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb119-499"><a href="#cb119-499" aria-hidden="true" tabindex="-1"></a>\chi^2 = \sum_{i=1}^{n}\sum_{j=1}^{m} \frac{(y_{ij} - e_{ij})^2}{e_{ij}}, </span>
<span id="cb119-500"><a href="#cb119-500" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb119-501"><a href="#cb119-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-502"><a href="#cb119-502" aria-hidden="true" tabindex="-1"></a>where $e_{ij} = \frac{y_{i\cdot} y_{\cdot j}}{y_{\cdot \cdot}}$, with $y_{i\cdot}$ the sum of the values in the i'th row, $y_{\cdot j}$ the sum of values in the j'th column, and $y_{\cdot\cdot}$ the sum of all the values. Suppose I give you a matrix in R with the $y_{ij}$ values. </span>
<span id="cb119-503"><a href="#cb119-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-504"><a href="#cb119-504" aria-hidden="true" tabindex="-1"></a>You can generate a test matrix as: </span>
<span id="cb119-505"><a href="#cb119-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb119-506"><a href="#cb119-506" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- matrix(sample(1:10, 12, replace = TRUE), </span></span>
<span id="cb119-507"><a href="#cb119-507" aria-hidden="true" tabindex="-1"></a><span class="in">nrow = 3, ncol = 4)</span></span>
<span id="cb119-508"><a href="#cb119-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-509"><a href="#cb119-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-510"><a href="#cb119-510" aria-hidden="true" tabindex="-1"></a>Compute the statistic without *any* loops as follows:</span>
<span id="cb119-511"><a href="#cb119-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-512"><a href="#cb119-512" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>First, assume you have the *e* matrix. How do you compute the statistic without loops as a function of <span class="in">`y`</span> and <span class="in">`e`</span>?</span>
<span id="cb119-513"><a href="#cb119-513" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>How can you construct the *e* matrix? Hint: the numerator of *e* is just an *outer product* for which the <span class="in">`outer()`</span> function can be used.</span>
<span id="cb119-514"><a href="#cb119-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-515"><a href="#cb119-515" aria-hidden="true" tabindex="-1"></a><span class="fu">### Advanced </span></span>
<span id="cb119-516"><a href="#cb119-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-517"><a href="#cb119-517" aria-hidden="true" tabindex="-1"></a>7) Here's a cool trick to pull off a particular element of a list of lists:</span>
<span id="cb119-518"><a href="#cb119-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-521"><a href="#cb119-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-522"><a href="#cb119-522" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">a =</span> <span class="fu">list</span>(<span class="at">mn =</span> <span class="dv">7</span>, <span class="at">sd =</span> <span class="dv">3</span>), <span class="at">b =</span> <span class="fu">list</span>(<span class="at">mn =</span> <span class="dv">6</span>,<span class="at">sd =</span> <span class="dv">1</span>), </span>
<span id="cb119-523"><a href="#cb119-523" aria-hidden="true" tabindex="-1"></a>  <span class="at">c =</span> <span class="fu">list</span>(<span class="at">mn =</span> <span class="dv">2</span>, <span class="at">sd =</span> <span class="dv">1</span>))</span>
<span id="cb119-524"><a href="#cb119-524" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(params, <span class="st">"[["</span>, <span class="dv">1</span>)</span>
<span id="cb119-525"><a href="#cb119-525" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb119-526"><a href="#cb119-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-527"><a href="#cb119-527" aria-hidden="true" tabindex="-1"></a>Explain what that does and why it works.</span>
<span id="cb119-528"><a href="#cb119-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-529"><a href="#cb119-529" aria-hidden="true" tabindex="-1"></a>Hint:</span>
<span id="cb119-532"><a href="#cb119-532" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb119-533"><a href="#cb119-533" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">3</span>)</span>
<span id="cb119-534"><a href="#cb119-534" aria-hidden="true" tabindex="-1"></a>test[[<span class="dv">2</span>]]</span>
<span id="cb119-535"><a href="#cb119-535" aria-hidden="true" tabindex="-1"></a><span class="co"># `[[`(test, 2)  # need it commented or R Markdown processing messes it up...</span></span>
<span id="cb119-536"><a href="#cb119-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-537"><a href="#cb119-537" aria-hidden="true" tabindex="-1"></a><span class="co"># `+`(3, 7)</span></span>
<span id="cb119-538"><a href="#cb119-538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>