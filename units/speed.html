<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Parallelization and Rcpp</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-2eb2de9d08919211f8a1d749abb3db00.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../assets/styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../units/intro.html">Modules</a></li><li class="breadcrumb-item"><a href="../units/speed.html">Parallelization/Rcpp</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Voleon R Bootcamp</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/paciorek/r-voleon-2025" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home / Schedule</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../prep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preparation</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Modules</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Introduction (Module “0”)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Structures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/calculation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calculation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Programming</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Wrangling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Plotting (ggplot)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Analysis/Useful Packages</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/speed.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Parallelization/Rcpp</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#parellelization" id="toc-parellelization" class="nav-link active" data-scroll-target="#parellelization">Parellelization</a>
  <ul class="collapse">
  <li><a href="#computer-architecture" id="toc-computer-architecture" class="nav-link" data-scroll-target="#computer-architecture">Computer architecture</a></li>
  <li><a href="#how-do-i-know-how-many-cores-a-computer-has" id="toc-how-do-i-know-how-many-cores-a-computer-has" class="nav-link" data-scroll-target="#how-do-i-know-how-many-cores-a-computer-has">How do I know how many cores a computer has?</a></li>
  <li><a href="#how-can-we-make-use-of-multiple-cores" id="toc-how-can-we-make-use-of-multiple-cores" class="nav-link" data-scroll-target="#how-can-we-make-use-of-multiple-cores">How can we make use of multiple cores?</a></li>
  <li><a href="#threaded-linear-algebra" id="toc-threaded-linear-algebra" class="nav-link" data-scroll-target="#threaded-linear-algebra">Threaded linear algebra</a></li>
  <li><a href="#more-details-on-the-blas-optional" id="toc-more-details-on-the-blas-optional" class="nav-link" data-scroll-target="#more-details-on-the-blas-optional">More details on the BLAS (optional)</a></li>
  <li><a href="#what-is-an-embarrassingly-parallel-ep-problem" id="toc-what-is-an-embarrassingly-parallel-ep-problem" class="nav-link" data-scroll-target="#what-is-an-embarrassingly-parallel-ep-problem">What is an embarrassingly parallel (EP) problem?</a></li>
  </ul></li>
  <li><a href="#using-the-future-package" id="toc-using-the-future-package" class="nav-link" data-scroll-target="#using-the-future-package">Using the future package</a>
  <ul class="collapse">
  <li><a href="#using-multiple-cores-for-ep-problems-parallel-apply-using-future" id="toc-using-multiple-cores-for-ep-problems-parallel-apply-using-future" class="nav-link" data-scroll-target="#using-multiple-cores-for-ep-problems-parallel-apply-using-future">Using multiple cores for EP problems: parallel <em>apply</em> using <code>future</code></a></li>
  <li><a href="#using-multiple-cores-for-ep-problems-foreach" id="toc-using-multiple-cores-for-ep-problems-foreach" class="nav-link" data-scroll-target="#using-multiple-cores-for-ep-problems-foreach">Using multiple cores for EP problems: <em>foreach</em></a></li>
  <li><a href="#other-plans" id="toc-other-plans" class="nav-link" data-scroll-target="#other-plans">Other “plans”</a></li>
  <li><a href="#parallelization-and-random-number-generation" id="toc-parallelization-and-random-number-generation" class="nav-link" data-scroll-target="#parallelization-and-random-number-generation">Parallelization and Random Number Generation</a></li>
  </ul></li>
  <li><a href="#rcpp" id="toc-rcpp" class="nav-link" data-scroll-target="#rcpp">Rcpp</a>
  <ul class="collapse">
  <li><a href="#rcpp-compilation" id="toc-rcpp-compilation" class="nav-link" data-scroll-target="#rcpp-compilation">Rcpp: compilation</a></li>
  <li><a href="#basic-example" id="toc-basic-example" class="nav-link" data-scroll-target="#basic-example">Basic example</a></li>
  <li><a href="#a-short-but-rich-example-loop-fusion" id="toc-a-short-but-rich-example-loop-fusion" class="nav-link" data-scroll-target="#a-short-but-rich-example-loop-fusion">A short but rich example: loop fusion</a></li>
  <li><a href="#loop-fusion-using-rcpp" id="toc-loop-fusion-using-rcpp" class="nav-link" data-scroll-target="#loop-fusion-using-rcpp">Loop fusion using Rcpp</a></li>
  <li><a href="#rcpp-source-code-files" id="toc-rcpp-source-code-files" class="nav-link" data-scroll-target="#rcpp-source-code-files">Rcpp source code files</a></li>
  <li><a href="#some-notes-about-memory-and-argument-passing" id="toc-some-notes-about-memory-and-argument-passing" class="nav-link" data-scroll-target="#some-notes-about-memory-and-argument-passing">Some notes about memory and argument passing</a></li>
  <li><a href="#using-r-classes-in-c" id="toc-using-r-classes-in-c" class="nav-link" data-scroll-target="#using-r-classes-in-c">Using R classes in C++</a></li>
  <li><a href="#rcpp-sugar" id="toc-rcpp-sugar" class="nav-link" data-scroll-target="#rcpp-sugar">Rcpp “sugar”</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../units/intro.html">Modules</a></li><li class="breadcrumb-item"><a href="../units/speed.html">Parallelization/Rcpp</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Parallelization and Rcpp</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="parellelization" class="level1">
<h1>Parellelization</h1>
<section id="computer-architecture" class="level2">
<h2 class="anchored" data-anchor-id="computer-architecture">Computer architecture</h2>
<p>Note to participants: It can be troublesome to use parallelization in RStudio, so we’ll just run the demo code in this module in a command line R session. You can open the basic R GUI for Mac or Windows, or, on a Mac, start R in a terminal window.</p>
<ul>
<li>Modern computers have multiple processors and clusters/supercomputers have multiple networked machines, each with multiple processors.</li>
<li>The key to increasing computational efficiency in these contexts is breaking up the work amongst the processors.</li>
<li>Processors on a single machine (or ‘node’) share memory and don’t need to carry out explicit communication (shared memory computation)</li>
<li>Processors on separate machines need to pass data across a network, often using the MPI protocol (distributed memory computation)</li>
</ul>
<p>We’ll focus on shared memory computation here.</p>
</section>
<section id="how-do-i-know-how-many-cores-a-computer-has" class="level2">
<h2 class="anchored" data-anchor-id="how-do-i-know-how-many-cores-a-computer-has">How do I know how many cores a computer has?</h2>
<ul>
<li>Linux - count the processors listed in <em>/proc/cpuinfo</em> or use <code>nproc</code></li>
<li>Mac - in a terminal: <code>system_profiler | grep -i 'Cores'</code></li>
<li>Windows - count the number of graphs shown for CPU Usage (or CPU Usage History) under “Task Manager-&gt;Performance”, or <a href="http://www.cpuid.com/cpuz.php">try this program</a></li>
</ul>
<p>To see if multiple cores are being used by your job, you can do:</p>
<ul>
<li>Mac/Linux - use <em>top</em> or <em>ps</em></li>
<li>Windows - see the “Task Manager-&gt;Performance-&gt;CPU Usage”</li>
</ul>
</section>
<section id="how-can-we-make-use-of-multiple-cores" class="level2">
<h2 class="anchored" data-anchor-id="how-can-we-make-use-of-multiple-cores">How can we make use of multiple cores?</h2>
<p>Some basic approaches are:</p>
<ul>
<li>Use a linear algebra package that distributes computations across ‘threads’</li>
<li>Spread independent calculations (embarrassingly parallel problems) across multiple cores
<ul>
<li><em>for</em> loops with independent calculations</li>
<li>parallelizing <code>lapply()</code> and its variants</li>
</ul></li>
</ul>
</section>
<section id="threaded-linear-algebra" class="level2">
<h2 class="anchored" data-anchor-id="threaded-linear-algebra">Threaded linear algebra</h2>
<p>R comes with a default BLAS (basic linear algebra subroutines) and LAPACK (linear algebra package) that carry out the core linear algebra computations. However, you can generally improve performance (sometimes by an order of magnitude) by using a different BLAS. Furthermore a threaded BLAS will allow you to use multiple cores.</p>
<p>A ‘thread’ is a lightweight process, and the operating system sees multiple threads as part of a single process.</p>
<ul>
<li>For Linux, <em>openBLAS</em> and Intel’s <em>MKL</em> are both fast and threaded.</li>
<li>For Mac, Apple’s <em>vecLib</em> is fast and threaded.</li>
<li>For Windows, you may be out of luck.</li>
</ul>
<p>We’ll show by demonstration that my desktop in my office is using multiple cores for linear algebra operations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># note to CJP: don't run on laptop with slow BLAS</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">^</span><span class="dv">2</span>), n)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="fu">chol</span>(<span class="fu">crossprod</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You should see that your R process is using more than 100% of CPU. Inconceivable!</p>
</section>
<section id="more-details-on-the-blas-optional" class="level2">
<h2 class="anchored" data-anchor-id="more-details-on-the-blas-optional">More details on the BLAS (optional)</h2>
<p>You can talk with your systems administrator about linking R to a fast BLAS or you can look into it yourself for your personal machine; see <a href="https://statistics.berkeley.edu/computing/faqs/linear-algebra-and-parallelized-linear-algebra-using-blas">this FAQ</a> or the <a href="http://www.cran.r-project.org/manuals.html">R Installation and Administration manual</a>.</p>
<p>Note that in some cases, in particular for small matrix operations, using multiple threads may actually slow down computation, so you may want to experiment, particularly with Linux. You can force the linear algebra to use only a single core by doing (assuming you’re using the bash shell) <code>export OMP_NUM_THREADS=1</code> in the terminal window <em>before</em> starting R in the same terminal. Or see the <em>RhpcBLASctl</em> package to do it from within R.</p>
</section>
<section id="what-is-an-embarrassingly-parallel-ep-problem" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-embarrassingly-parallel-ep-problem">What is an embarrassingly parallel (EP) problem?</h2>
<p>An EP problem is one that can be solved by doing independent computations as separate processes without communication between the processes. You can get the answer by doing separate tasks and then collecting the results.</p>
<p>Examples in statistics / data science / machine learning include</p>
<ol type="1">
<li>stratified analyses</li>
<li>cross-validation</li>
<li>simulations with many independent replicates</li>
<li>bootstrapping</li>
<li>random forest models</li>
</ol>
<p>Some things that are not EP (at least not in a basic formulation):</p>
<ol type="1">
<li>optimization</li>
<li>Markov chain Monte Carlo for fitting Bayesian models</li>
</ol>
</section>
</section>
<section id="using-the-future-package" class="level1">
<h1>Using the future package</h1>
<section id="using-multiple-cores-for-ep-problems-parallel-apply-using-future" class="level2">
<h2 class="anchored" data-anchor-id="using-multiple-cores-for-ep-problems-parallel-apply-using-future">Using multiple cores for EP problems: parallel <em>apply</em> using <code>future</code></h2>
<p>The <code>future</code> package provides a lot of nice features for parallelization. We’ll just scratch the surface here to parallelize operations over the elements of a list (note that this is essentially equivalent to <code>parLapply</code> and <code>mclapply</code>).</p>
<p>First, make sure your computations on the elements are independent of each other and don’t involve sequential calculations!</p>
<p>We’ll use the <a href="https://www.stat.berkeley.edu/~paciorek/share/airline.csv">airline departure dataset</a>, with timing informatin for all flights from SFO over a period of several years. We’ll do a stratified analysis, fitting a GAM (see Unit 6) for each of the destination airports.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>air <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>fitFun <span class="ot">&lt;-</span> <span class="cf">function</span>(curDest) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">library</span>(mgcv)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>            tmp <span class="ot">&lt;-</span> <span class="fu">subset</span>(air, Dest <span class="sc">==</span> curDest)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            <span class="do">## It would better to do this with date-time functionality:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>            tmp<span class="sc">$</span>Hour <span class="ot">&lt;-</span> tmp<span class="sc">$</span>CRSDepTime <span class="sc">%/%</span> <span class="dv">100</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>            curMod <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">gam</span>(DepDelay <span class="sc">~</span> Year <span class="sc">+</span> <span class="fu">s</span>(Month) <span class="sc">+</span> <span class="fu">s</span>(Hour) <span class="sc">+</span> </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">as.factor</span>(DayOfWeek), <span class="at">data =</span> tmp))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">is</span>(tmp, <span class="st">"try-error"</span>)) curMod <span class="ot">&lt;-</span> <span class="cn">NA</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(curMod)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: future</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>nCores <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nCores)  </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">future_lapply</span>(<span class="fu">unique</span>(air<span class="sc">$</span>Dest), fitFun)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>out[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  gam(formula = DepDelay ~ Year + s(Month) + s(Hour) + as.factor(DayOfWeek), 
    data = tmp)

Coefficients:
          (Intercept)                   Year  as.factor(DayOfWeek)2  
           -3497.3037                 1.7490                -2.1810  
as.factor(DayOfWeek)3  as.factor(DayOfWeek)4  as.factor(DayOfWeek)5  
              -3.6045                -1.6800                 2.9982  
as.factor(DayOfWeek)6  as.factor(DayOfWeek)7             s(Month).1  
              -2.4173                 0.7169                -8.6549  
           s(Month).2             s(Month).3             s(Month).4  
              32.1570                12.0161                10.7049  
           s(Month).5             s(Month).6             s(Month).7  
               8.2426                13.9619                -4.9777  
           s(Month).8             s(Month).9              s(Hour).1  
             -46.2121                14.8763                 5.6931  
            s(Hour).2              s(Hour).3              s(Hour).4  
               4.5111                 9.9465                 8.5980  
            s(Hour).5              s(Hour).6              s(Hour).7  
               1.9587                 6.1938                -0.2061  
            s(Hour).8              s(Hour).9  
              -7.0151                 2.2963  

Degrees of Freedom: 15782 Total (i.e. Null);  15760 Residual
  (142 observations deleted due to missingness)
Null Deviance:      17480000 
Residual Deviance: 16550000     AIC: 154600</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>out[[<span class="dv">81</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Error in smooth.construct.tp.smooth.spec(object, dk$data, dk$knots) : \n  A term has fewer unique covariate combinations than specified maximum degrees of freedom\n"
attr(,"class")
[1] "try-error"
attr(,"condition")
&lt;simpleError in smooth.construct.tp.smooth.spec(object, dk$data, dk$knots): A term has fewer unique covariate combinations than specified maximum degrees of freedom&gt;</code></pre>
</div>
</div>
<p>Note that the <code>plan</code> statement determines how the parallelization is done behind the scenes. As shown here, it will start up workers locally on your computer, but if you have access to a cluster, you can modify the plan to make use of multiple compute nodes in a cluster.</p>
<p>One thing to keep in mind is whether the different tasks all take about the same amount of time or widely different times. In the latter case, one wants to sequentially dispatch tasks as earlier tasks finish, rather than dispatching a block of tasks to each core. See the <code>future.scheduling</code> argument for user control over how the allocation is done.</p>
</section>
<section id="using-multiple-cores-for-ep-problems-foreach" class="level2">
<h2 class="anchored" data-anchor-id="using-multiple-cores-for-ep-problems-foreach">Using multiple cores for EP problems: <em>foreach</em></h2>
<p>First, make sure your iterations are independent and don’t involve sequential calculations!</p>
<p>The <em>foreach</em> package provides a way to do a for loop using multiple cores. It can use a variety of ‘back-ends’ that handle the nitty-gritty of the parallelization. Happily it integrates with the <code>future</code> package nicely.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>nCores <span class="ot">&lt;-</span> <span class="dv">4</span>  <span class="co"># actually only 2 on my laptop, but appears hyperthreaded</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nCores)  </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>progress <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">dest =</span> <span class="fu">unique</span>(air<span class="sc">$</span>Dest)) <span class="sc">%dopar%</span> {</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(progress) <span class="fu">cat</span>(<span class="st">"Starting job for "</span>, dest, <span class="st">".</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    outSub <span class="ot">&lt;-</span> <span class="fu">fitFun</span>(dest)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(progress) <span class="fu">cat</span>(<span class="st">"Finishing job for "</span>, dest, <span class="st">".</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    outSub <span class="co"># this will become part of the out objec</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>out[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]

Call:  gam(formula = DepDelay ~ Year + s(Month) + s(Hour) + as.factor(DayOfWeek), 
    data = tmp)

Coefficients:
          (Intercept)                   Year  as.factor(DayOfWeek)2  
           -3497.3037                 1.7490                -2.1810  
as.factor(DayOfWeek)3  as.factor(DayOfWeek)4  as.factor(DayOfWeek)5  
              -3.6045                -1.6800                 2.9982  
as.factor(DayOfWeek)6  as.factor(DayOfWeek)7             s(Month).1  
              -2.4173                 0.7169                -8.6549  
           s(Month).2             s(Month).3             s(Month).4  
              32.1570                12.0161                10.7049  
           s(Month).5             s(Month).6             s(Month).7  
               8.2426                13.9619                -4.9777  
           s(Month).8             s(Month).9              s(Hour).1  
             -46.2121                14.8763                 5.6931  
            s(Hour).2              s(Hour).3              s(Hour).4  
               4.5111                 9.9465                 8.5980  
            s(Hour).5              s(Hour).6              s(Hour).7  
               1.9587                 6.1938                -0.2061  
            s(Hour).8              s(Hour).9  
              -7.0151                 2.2963  

Degrees of Freedom: 15782 Total (i.e. Null);  15760 Residual
  (142 observations deleted due to missingness)
Null Deviance:      17480000 
Residual Deviance: 16550000     AIC: 154600

[[2]]

Call:  gam(formula = DepDelay ~ Year + s(Month) + s(Hour) + as.factor(DayOfWeek), 
    data = tmp)

Coefficients:
          (Intercept)                   Year  as.factor(DayOfWeek)2  
           -3034.4822                 1.5192                -1.4358  
as.factor(DayOfWeek)3  as.factor(DayOfWeek)4  as.factor(DayOfWeek)5  
              -1.3253                 1.1991                 2.8585  
as.factor(DayOfWeek)6  as.factor(DayOfWeek)7             s(Month).1  
              -3.4711                -0.6099               -11.5023  
           s(Month).2             s(Month).3             s(Month).4  
              29.9072                 7.8150                 3.4659  
           s(Month).5             s(Month).6             s(Month).7  
               3.9015                13.5777                -4.5265  
           s(Month).8             s(Month).9              s(Hour).1  
             -33.3586                14.2591               -14.9909  
            s(Hour).2              s(Hour).3              s(Hour).4  
              26.8251                 7.7860                11.7260  
            s(Hour).5              s(Hour).6              s(Hour).7  
              -8.2813                11.2469                 7.4184  
            s(Hour).8              s(Hour).9  
              42.5227               -41.9673  

Degrees of Freedom: 12564 Total (i.e. Null);  12540.9 Residual
  (142 observations deleted due to missingness)
Null Deviance:      17310000 
Residual Deviance: 16590000     AIC: 126000</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>What do you think are the advantages and disadvantages of having many small tasks vs.&nbsp;a few large tasks?</p>
</div>
</div>
</section>
<section id="other-plans" class="level2">
<h2 class="anchored" data-anchor-id="other-plans">Other “plans”</h2>
<ul>
<li><code>multisession</code>: multiple R sessions on a single machine</li>
<li><code>multicore</code>: multiple forked R sessions on a single machine (less copying)</li>
<li><code>cluster</code>: multiple R sessions on one or more machines</li>
</ul>
</section>
<section id="parallelization-and-random-number-generation" class="level2">
<h2 class="anchored" data-anchor-id="parallelization-and-random-number-generation">Parallelization and Random Number Generation</h2>
<p>A tale of the good, the bad, and the ugly</p>
<p>Random numbers on a computer are <a href="http://dilbert.com/strips/comic/2001-10-25">not truly random</a> but are generated as a sequence of pseudo-random numbers. The sequence is finite (but very, very, very, very long) and eventally repeats itself.</p>
<p>A random number seed determines where in the sequence one starts when generating random numbers.</p>
<ul>
<li><p>The ugly: Make sure you do not use the same seed for each task</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.6264538  0.1836433 -0.8356286  1.5952808  0.3295078</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rnorm</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.6264538  0.1836433 -0.8356286  1.5952808  0.3295078</code></pre>
</div>
</div></li>
<li><p>The (not so) bad: Use a different seed for each task or each process. It’s possible the subsequences will overlap but quite unlikely.</p></li>
<li><p>The good: Use the L’Ecuyer algorithm to ensure distinct subsequences in each worker, which <code>future</code> makes easy:</p>
<ul>
<li>with <code>future.apply</code>, use <code>future.seed = TRUE</code>.</li>
<li>with <code>foreach</code> and <code>%dofuture%</code>, include <code>.options.future = list(seed = TRUE)</code>.</li>
</ul></li>
</ul>
</section>
</section>
<section id="rcpp" class="level1">
<h1>Rcpp</h1>
<p>While R can interface with lots of other languages, the most fundamental is to interface with C/C++. In part this is because the R interpreter is a C program and under the hood, R data structures are C structs. In part this is because of the success of Rcpp as a wrapper that makes it easy to interface to C++ (including C) code.</p>
<p>Some comments:</p>
<ul>
<li>Rcpp has a nice interface that makes it easy to work with R data structures in C++ and use various functions similar to those provided in R.</li>
<li>Loops and recursion in C++ are fast, unlike in R.</li>
<li>Rcpp allows you to make use of various libraries available in C/C++, such as the standard template library (STL), Eigen (for linear algebra), and many others.</li>
<li>Often one will write most of one’s code in R and off-load the core, slow computational parts to C++, managed from R.</li>
</ul>
<p>Some good overviews of Rcpp are:</p>
<ul>
<li><a href="https://adv-r.hadley.nz/rcpp.html">The Advanced R book by Hadley Wickham</a></li>
<li><a href="https://cran.r-project.org/web/packages/Rcpp/vignettes/Rcpp-introduction.pdf">The Rcpp vignette</a></li>
<li><a href="https://dirk.eddelbuettel.com/papers/useR2019_rcpp_tutorial.pdf">Rcpp tutorial from 2019</a></li>
</ul>
<section id="rcpp-compilation" class="level2">
<h2 class="anchored" data-anchor-id="rcpp-compilation">Rcpp: compilation</h2>
<p>Behind the scenes, the first step in using a C++ function is that the C++ code is compiled to machine (binary) code that can be called from R.</p>
<p>To use Rcpp, you’ll need a C++ compiler:</p>
<ul>
<li>for Windows: install <code>rtools</code></li>
<li>for MacOS: install <code>xcode</code></li>
</ul>
<p>Here’s a test that your compiler works from R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"Rcpp"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">evalCpp</span>(<span class="st">"2 + 2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
</section>
<section id="basic-example" class="level2">
<h2 class="anchored" data-anchor-id="basic-example">Basic example</h2>
<p>Here’s a basic example of using C++ code via Rcpp from the Advanced R book.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cppFunction</span>(<span class="st">'int add3(int x, int y, int z) {</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="st">  int sum = x + y + z;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="st">  return sum;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="do">## The pause is because the C++ code has to be compiled.</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>add3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (x, y, z) 
.Call(&lt;pointer: 0x7f0ed1d302a0&gt;, x, y, z)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add3</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9</code></pre>
</div>
</div>
<p>Note that some casting/coercing of types by Rcpp must be happening:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add3</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add3</span>(<span class="dv">1</span>L, <span class="dv">2</span>L, <span class="dv">3</span>L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add3</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="fl">3.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
<p>Notice we need to include the types of variables, since C++ is statically typed (in large part this is why it is much faster than R).</p>
</section>
<section id="a-short-but-rich-example-loop-fusion" class="level2">
<h2 class="anchored" data-anchor-id="a-short-but-rich-example-loop-fusion">A short but rich example: loop fusion</h2>
<p>Consider this vectorized code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">exp</span>(x) <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">sin</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because it’s vectorized, it avoids the R overhead involved in looping, with the individual calculations (<code>exp</code>, <code>+</code>, <code>*</code>, and <code>sin</code>) done in for loops in compiled C code.</p>
<p>However, it has a subtle disadvantage compared to this for loop version:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>   x[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(x[i]) <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">sin</span>(x[i])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>What has to happen in the vectorized code that doesn’t happen in the for loop?</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Answer">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li>The individual operations are done as separate vectorized calls to compiled C code.</li>
<li>Temporary vectors must be allocated and filled to store the results of <code>exp</code>, <code>sin</code>, <code>*</code> and <code>+</code>.
<ul>
<li>Extra memory needed.</li>
<li>Time for allocation and moving values.</li>
</ul></li>
<li>The result <code>x</code> and the input <code>x</code> both need to exist at one time, briefly.</li>
</ul>
</div>
</div>
</div>
<p>None of that needs to happen with the loop version.</p>
</section>
<section id="loop-fusion-using-rcpp" class="level2">
<h2 class="anchored" data-anchor-id="loop-fusion-using-rcpp">Loop fusion using Rcpp</h2>
<p>We can write up the for loop version using Rcpp to get the benefits of loop fusion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cppFunction</span>(<span class="st">'void fuse(Rcpp::NumericVector x) {</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="st">  int n = x.size();</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="st">  Rcpp::Rcout &lt;&lt; "Working with a vector of length " &lt;&lt; n &lt;&lt; "." &lt;&lt; std::endl;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="st">  for(int i = 0; i &lt; n; ++i) {</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="st">    x[i] = exp(x[i]) + 3 * sin(x[i]);</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e7</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> x</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>rbenchmark<span class="sc">::</span><span class="fu">benchmark</span>(</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a> x <span class="ot">&lt;-</span> <span class="fu">exp</span>(x) <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span><span class="fu">sin</span>(x),</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a> <span class="fu">fuse</span>(y),</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a> <span class="at">replications =</span> <span class="dv">1</span>,  <span class="co"># 'x' could explode on repeated calls</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a> <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">'test'</span>, <span class="st">'replications'</span>, <span class="st">'elapsed'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Working with a vector of length 10000000.
Working with a vector of length 10000000.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                      test replications elapsed
2                  fuse(y)            1   0.272
1 x &lt;- exp(x) + 3 * sin(x)            1   0.370</code></pre>
</div>
</div>
<p>When using Rcpp’s built-in vector types, Rcpp reuses R memory so no copies of the inputs are made.</p>
<p>We could also have created a version that doesn’t overwrite the input.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cppFunction</span>(<span class="st">'NumericVector fuse(NumericVector x) {</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="st">  int n = x.size();</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="st">  NumericVector result(n);</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="st">  for(int i = 0; i &lt; n; ++i) {</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="st">    result[i] = exp(x[i]) + 3 * sin(x[i]);</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="st">  return result;</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="rcpp-source-code-files" class="level2">
<h2 class="anchored" data-anchor-id="rcpp-source-code-files">Rcpp source code files</h2>
<p>Except for quick-and-dirty work, we’d generally want the Rcpp C++ code in a code file that can be recognized by editors as C++ code rather than in quotations in R. This will also help with debugging.</p>
<p>See <a href="fuse.cpp">fuse.cpp</a> for the code for the version that does not overwrite the input.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sourceCpp</span>(<span class="st">'fuse.cpp'</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">fuse</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="some-notes-about-memory-and-argument-passing" class="level2">
<h2 class="anchored" data-anchor-id="some-notes-about-memory-and-argument-passing">Some notes about memory and argument passing</h2>
<ol type="1">
<li><p>Copy-on-change doesn’t work with Rcpp functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> x</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="fu">fuse</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.672176 -2.119454 -2.077276  3.033523  1.622440</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.7880376 -0.9816014 -0.9612346  0.4875063  0.1529766</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.7880376 -0.9816014 -0.9612346  0.4875063  0.1529766</code></pre>
</div>
</div></li>
<li><p>Type conversion can prevent modification</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "integer"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fuse</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   5.242695  10.116948  20.508897  52.327743 145.536386</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3 4 5</code></pre>
</div>
</div></li>
</ol>
<p>The <code>NumericVector</code> type can only make use of R memory for the input if the input R object is a numeric vector; above it is an integer vector, so a cast needs to be made with values copied to a new object in C++.</p>
</section>
<section id="using-r-classes-in-c" class="level2">
<h2 class="anchored" data-anchor-id="using-r-classes-in-c">Using R classes in C++</h2>
<p>Rcpp provides classes that correspond to most R data structures/classes. We’ve already seen the use of <code>NumericVector</code> for R’s numeric vector.</p>
<p>Here’s an example (from the Advanced R book) of working with a list (in this case an <code>lm</code> S3 object) and manipulating its components in C++. We need to cast the vector components as <code>NumericVector</code>s</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> mpe<span class="op">(</span>List mod<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>mod<span class="op">.</span>inherits<span class="op">(</span><span class="st">"lm"</span><span class="op">))</span> stop<span class="op">(</span><span class="st">"Input must be a linear model"</span><span class="op">);</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  NumericVector resid <span class="op">=</span> as<span class="op">&lt;</span>NumericVector<span class="op">&gt;(</span>mod<span class="op">[</span><span class="st">"residuals"</span><span class="op">]);</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  NumericVector fitted <span class="op">=</span> as<span class="op">&lt;</span>NumericVector<span class="op">&gt;(</span>mod<span class="op">[</span><span class="st">"fitted.values"</span><span class="op">]);</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> resid<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> err <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    err <span class="op">+=</span> resid<span class="op">[</span>i<span class="op">]</span> <span class="op">/</span> <span class="op">(</span>fitted<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> resid<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> err <span class="op">/</span> n<span class="op">;</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="rcpp-sugar" class="level2">
<h2 class="anchored" data-anchor-id="rcpp-sugar">Rcpp “sugar”</h2>
<p><a href="https://cran.r-project.org/web/packages/Rcpp/vignettes/Rcpp-sugar.pdf"><em>Rcpp Sugar</em></a> provides additional functionality to make it easier to write C++ code in an R-like way.</p>
<p>This includes:</p>
<ul>
<li>Calling functions from R’s C math library, e.g., <code>Rcpp::rnorm(10, 3, 0.5)</code></li>
<li>Various functions that mimic standard R functions (e.g., <code>all</code>, <code>is_na</code>)</li>
<li>Using R’s random number generation</li>
<li>Vectorized calls (for code clarity, not for speed!)</li>
</ul>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/paciorek\.github\.io\/r-voleon-2025");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb64" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Parallelization and Rcpp"</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co">    css: ../assets/styles.css</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-block-bg: true</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-block-border-left: "#31BAE9"</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: auto</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="fu"># Parellelization</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Computer architecture</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>Note to participants: It can be troublesome to use parallelization in RStudio, so we'll just run the demo code in this module in a command line R session. You can open the basic R GUI for Mac or Windows, or, on a Mac, start R in a terminal window.</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Modern computers have multiple processors and clusters/supercomputers have multiple networked machines, each with multiple processors.</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The key to increasing computational efficiency in these contexts is breaking up the work amongst the processors.</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Processors on a single machine (or 'node') share memory and don't need to carry out explicit communication (shared memory computation)</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Processors on separate machines need to pass data across a network, often using the MPI protocol (distributed memory computation)</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>We'll focus on shared memory computation here.</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## How do I know how many cores a computer has?</span></span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Linux - count the processors listed in */proc/cpuinfo* or use <span class="in">`nproc`</span></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Mac - in a terminal: <span class="in">`system_profiler | grep -i 'Cores'`</span></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Windows - count the number of graphs shown for CPU Usage (or CPU Usage History) under "Task Manager-&gt;Performance", or <span class="co">[</span><span class="ot">try this program</span><span class="co">](http://www.cpuid.com/cpuz.php)</span> </span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>To see if multiple cores are being used by your job, you can do:</span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Mac/Linux - use *top* or *ps*</span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Windows - see the "Task Manager-&gt;Performance-&gt;CPU Usage"</span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a><span class="fu">## How can we make use of multiple cores?</span></span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a>Some basic approaches are:</span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Use a linear algebra package that distributes computations across 'threads'</span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Spread independent calculations (embarrassingly parallel problems) across multiple cores</span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>*for* loops with independent calculations</span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>parallelizing <span class="in">`lapply()`</span> and its variants</span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a><span class="fu">## Threaded linear algebra</span></span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a>R comes with a default BLAS (basic linear algebra subroutines) and LAPACK (linear algebra package) that carry out the core linear algebra computations. However, you can generally improve performance (sometimes by an order of magnitude) by using a different BLAS. Furthermore a threaded BLAS will allow you to use multiple cores.</span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-54"><a href="#cb64-54" aria-hidden="true" tabindex="-1"></a>A 'thread' is a lightweight process, and the operating system sees multiple threads as part of a single process.</span>
<span id="cb64-55"><a href="#cb64-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-56"><a href="#cb64-56" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>For Linux, *openBLAS* and Intel's *MKL* are both fast and threaded. </span>
<span id="cb64-57"><a href="#cb64-57" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>For Mac, Apple's *vecLib* is fast and threaded.</span>
<span id="cb64-58"><a href="#cb64-58" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>For Windows, you may be out of luck.</span>
<span id="cb64-59"><a href="#cb64-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-60"><a href="#cb64-60" aria-hidden="true" tabindex="-1"></a>We'll show by demonstration that my desktop in my office is using multiple cores for linear algebra operations.</span>
<span id="cb64-61"><a href="#cb64-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-64"><a href="#cb64-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-65"><a href="#cb64-65" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb64-66"><a href="#cb64-66" aria-hidden="true" tabindex="-1"></a><span class="co"># note to CJP: don't run on laptop with slow BLAS</span></span>
<span id="cb64-67"><a href="#cb64-67" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb64-68"><a href="#cb64-68" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">^</span><span class="dv">2</span>), n)</span>
<span id="cb64-69"><a href="#cb64-69" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="fu">chol</span>(<span class="fu">crossprod</span>(x))</span>
<span id="cb64-70"><a href="#cb64-70" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-71"><a href="#cb64-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-72"><a href="#cb64-72" aria-hidden="true" tabindex="-1"></a>You should see that your R process is using more than 100% of CPU. Inconceivable!</span>
<span id="cb64-73"><a href="#cb64-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-74"><a href="#cb64-74" aria-hidden="true" tabindex="-1"></a><span class="fu">## More details on the BLAS (optional)</span></span>
<span id="cb64-75"><a href="#cb64-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-76"><a href="#cb64-76" aria-hidden="true" tabindex="-1"></a>You can talk with your systems administrator about linking R to a fast BLAS or you can look into it yourself for your personal machine; see <span class="co">[</span><span class="ot">this FAQ</span><span class="co">](https://statistics.berkeley.edu/computing/faqs/linear-algebra-and-parallelized-linear-algebra-using-blas)</span> or the <span class="co">[</span><span class="ot">R Installation and Administration manual</span><span class="co">](http://www.cran.r-project.org/manuals.html)</span>.</span>
<span id="cb64-77"><a href="#cb64-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-78"><a href="#cb64-78" aria-hidden="true" tabindex="-1"></a>Note that in some cases, in particular for small matrix operations, using multiple threads may actually slow down computation, so you may want to experiment, particularly with Linux. You can force the linear algebra to use only a single core by doing (assuming you're using the bash shell) <span class="in">`export OMP_NUM_THREADS=1`</span> in the terminal window *before* starting R in the same terminal. Or see the *RhpcBLASctl* package to do it from within R.</span>
<span id="cb64-79"><a href="#cb64-79" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb64-80"><a href="#cb64-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-81"><a href="#cb64-81" aria-hidden="true" tabindex="-1"></a><span class="fu">## What is an embarrassingly parallel (EP) problem?</span></span>
<span id="cb64-82"><a href="#cb64-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-83"><a href="#cb64-83" aria-hidden="true" tabindex="-1"></a>An EP problem is one that can be solved by doing independent computations as separate processes without communication between the processes. You can get the answer by doing separate tasks and then collecting the results. </span>
<span id="cb64-84"><a href="#cb64-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-85"><a href="#cb64-85" aria-hidden="true" tabindex="-1"></a>Examples in statistics / data science / machine learning include</span>
<span id="cb64-86"><a href="#cb64-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-87"><a href="#cb64-87" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>stratified analyses</span>
<span id="cb64-88"><a href="#cb64-88" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>cross-validation</span>
<span id="cb64-89"><a href="#cb64-89" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>simulations with many independent replicates</span>
<span id="cb64-90"><a href="#cb64-90" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>bootstrapping</span>
<span id="cb64-91"><a href="#cb64-91" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>random forest models</span>
<span id="cb64-92"><a href="#cb64-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-93"><a href="#cb64-93" aria-hidden="true" tabindex="-1"></a>Some things that are not EP (at least not in a basic formulation):</span>
<span id="cb64-94"><a href="#cb64-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-95"><a href="#cb64-95" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>optimization</span>
<span id="cb64-96"><a href="#cb64-96" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Markov chain Monte Carlo for fitting Bayesian models</span>
<span id="cb64-97"><a href="#cb64-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-98"><a href="#cb64-98" aria-hidden="true" tabindex="-1"></a><span class="fu"># Using the future package</span></span>
<span id="cb64-99"><a href="#cb64-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-100"><a href="#cb64-100" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using multiple cores for EP problems: parallel *apply* using `future`</span></span>
<span id="cb64-101"><a href="#cb64-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-102"><a href="#cb64-102" aria-hidden="true" tabindex="-1"></a>The <span class="in">`future`</span> package provides a lot of nice features for parallelization. We'll just scratch the surface here to parallelize operations over the elements of a list (note that this is essentially equivalent to <span class="in">`parLapply`</span> and <span class="in">`mclapply`</span>).</span>
<span id="cb64-103"><a href="#cb64-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-104"><a href="#cb64-104" aria-hidden="true" tabindex="-1"></a>First, make sure your computations on the elements are independent of each other and don't involve sequential calculations!</span>
<span id="cb64-105"><a href="#cb64-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-106"><a href="#cb64-106" aria-hidden="true" tabindex="-1"></a>We'll use the <span class="co">[</span><span class="ot">airline departure dataset</span><span class="co">](https://www.stat.berkeley.edu/~paciorek/share/airline.csv)</span>, with timing informatin for all flights from SFO over a period of several years. We'll do a stratified analysis, fitting a GAM (see Unit 6) for each of the destination airports.</span>
<span id="cb64-107"><a href="#cb64-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-110"><a href="#cb64-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-111"><a href="#cb64-111" aria-hidden="true" tabindex="-1"></a>air <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(<span class="st">'..'</span>, <span class="st">'data'</span>, <span class="st">'airline.csv'</span>))</span>
<span id="cb64-112"><a href="#cb64-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-113"><a href="#cb64-113" aria-hidden="true" tabindex="-1"></a>fitFun <span class="ot">&lt;-</span> <span class="cf">function</span>(curDest) {</span>
<span id="cb64-114"><a href="#cb64-114" aria-hidden="true" tabindex="-1"></a>            <span class="fu">library</span>(mgcv)</span>
<span id="cb64-115"><a href="#cb64-115" aria-hidden="true" tabindex="-1"></a>            tmp <span class="ot">&lt;-</span> <span class="fu">subset</span>(air, Dest <span class="sc">==</span> curDest)</span>
<span id="cb64-116"><a href="#cb64-116" aria-hidden="true" tabindex="-1"></a>            <span class="do">## It would better to do this with date-time functionality:</span></span>
<span id="cb64-117"><a href="#cb64-117" aria-hidden="true" tabindex="-1"></a>            tmp<span class="sc">$</span>Hour <span class="ot">&lt;-</span> tmp<span class="sc">$</span>CRSDepTime <span class="sc">%/%</span> <span class="dv">100</span></span>
<span id="cb64-118"><a href="#cb64-118" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb64-119"><a href="#cb64-119" aria-hidden="true" tabindex="-1"></a>            curMod <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">gam</span>(DepDelay <span class="sc">~</span> Year <span class="sc">+</span> <span class="fu">s</span>(Month) <span class="sc">+</span> <span class="fu">s</span>(Hour) <span class="sc">+</span> </span>
<span id="cb64-120"><a href="#cb64-120" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">as.factor</span>(DayOfWeek), <span class="at">data =</span> tmp))</span>
<span id="cb64-121"><a href="#cb64-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">is</span>(tmp, <span class="st">"try-error"</span>)) curMod <span class="ot">&lt;-</span> <span class="cn">NA</span> </span>
<span id="cb64-122"><a href="#cb64-122" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(curMod)</span>
<span id="cb64-123"><a href="#cb64-123" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-124"><a href="#cb64-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-125"><a href="#cb64-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-126"><a href="#cb64-126" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply)</span>
<span id="cb64-127"><a href="#cb64-127" aria-hidden="true" tabindex="-1"></a>nCores <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb64-128"><a href="#cb64-128" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> nCores)  </span>
<span id="cb64-129"><a href="#cb64-129" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">future_lapply</span>(<span class="fu">unique</span>(air<span class="sc">$</span>Dest), fitFun)</span>
<span id="cb64-130"><a href="#cb64-130" aria-hidden="true" tabindex="-1"></a>out[[<span class="dv">1</span>]]</span>
<span id="cb64-131"><a href="#cb64-131" aria-hidden="true" tabindex="-1"></a>out[[<span class="dv">81</span>]]</span>
<span id="cb64-132"><a href="#cb64-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-133"><a href="#cb64-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-134"><a href="#cb64-134" aria-hidden="true" tabindex="-1"></a>Note that the <span class="in">`plan`</span> statement determines how the parallelization is done behind the scenes. As shown here, it will start up workers locally on your computer, but if you have access to a cluster, you can modify the plan to make use of multiple compute nodes in a cluster.</span>
<span id="cb64-135"><a href="#cb64-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-136"><a href="#cb64-136" aria-hidden="true" tabindex="-1"></a>One thing to keep in mind is whether the different tasks all take about the same amount of time or widely different times. In the latter case, one wants to sequentially dispatch tasks as earlier tasks finish, rather than dispatching a block of tasks to each core. See  the <span class="in">`future.scheduling`</span> argument for user control over how the allocation is done. </span>
<span id="cb64-137"><a href="#cb64-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-138"><a href="#cb64-138" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using multiple cores for EP problems: *foreach*</span></span>
<span id="cb64-139"><a href="#cb64-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-140"><a href="#cb64-140" aria-hidden="true" tabindex="-1"></a>First, make sure your iterations are independent and don't involve sequential calculations!</span>
<span id="cb64-141"><a href="#cb64-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-142"><a href="#cb64-142" aria-hidden="true" tabindex="-1"></a>The *foreach* package provides a way to do a for loop using multiple cores. It can use a variety of 'back-ends' that handle the nitty-gritty of the parallelization. Happily it integrates with the <span class="in">`future`</span> package nicely. </span>
<span id="cb64-143"><a href="#cb64-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-144"><a href="#cb64-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cache=TRUE}</span></span>
<span id="cb64-145"><a href="#cb64-145" aria-hidden="true" tabindex="-1"></a><span class="in">library(parallel)</span></span>
<span id="cb64-146"><a href="#cb64-146" aria-hidden="true" tabindex="-1"></a><span class="in">library(doFuture)</span></span>
<span id="cb64-147"><a href="#cb64-147" aria-hidden="true" tabindex="-1"></a><span class="in">library(foreach)</span></span>
<span id="cb64-148"><a href="#cb64-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-149"><a href="#cb64-149" aria-hidden="true" tabindex="-1"></a><span class="in">nCores &lt;- 4  # actually only 2 on my laptop, but appears hyperthreaded</span></span>
<span id="cb64-150"><a href="#cb64-150" aria-hidden="true" tabindex="-1"></a><span class="in">registerDoFuture()</span></span>
<span id="cb64-151"><a href="#cb64-151" aria-hidden="true" tabindex="-1"></a><span class="in">plan(multisession, workers = nCores)  </span></span>
<span id="cb64-152"><a href="#cb64-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-153"><a href="#cb64-153" aria-hidden="true" tabindex="-1"></a><span class="in">progress &lt;- FALSE</span></span>
<span id="cb64-154"><a href="#cb64-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-155"><a href="#cb64-155" aria-hidden="true" tabindex="-1"></a><span class="in">out &lt;- foreach(dest = unique(air$Dest)) %dopar% {</span></span>
<span id="cb64-156"><a href="#cb64-156" aria-hidden="true" tabindex="-1"></a><span class="in">    if(progress) cat("Starting job for ", dest, ".\n", sep = "")</span></span>
<span id="cb64-157"><a href="#cb64-157" aria-hidden="true" tabindex="-1"></a><span class="in">    outSub &lt;- fitFun(dest)</span></span>
<span id="cb64-158"><a href="#cb64-158" aria-hidden="true" tabindex="-1"></a><span class="in">    if(progress) cat("Finishing job for ", dest, ".\n", sep = "")</span></span>
<span id="cb64-159"><a href="#cb64-159" aria-hidden="true" tabindex="-1"></a><span class="in">    outSub # this will become part of the out objec</span></span>
<span id="cb64-160"><a href="#cb64-160" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb64-161"><a href="#cb64-161" aria-hidden="true" tabindex="-1"></a><span class="in">out[1:2]</span></span>
<span id="cb64-162"><a href="#cb64-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-163"><a href="#cb64-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-164"><a href="#cb64-164" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Question"}</span>
<span id="cb64-165"><a href="#cb64-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-166"><a href="#cb64-166" aria-hidden="true" tabindex="-1"></a>What do you think are the advantages and disadvantages of having many small tasks vs. a few large tasks?</span>
<span id="cb64-167"><a href="#cb64-167" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb64-168"><a href="#cb64-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-169"><a href="#cb64-169" aria-hidden="true" tabindex="-1"></a><span class="fu">## Other "plans"</span></span>
<span id="cb64-170"><a href="#cb64-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-171"><a href="#cb64-171" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`multisession`</span>: multiple R sessions on a single machine</span>
<span id="cb64-172"><a href="#cb64-172" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`multicore`</span>: multiple forked R sessions on a single machine (less copying)</span>
<span id="cb64-173"><a href="#cb64-173" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`cluster`</span>: multiple R sessions on one or more machines</span>
<span id="cb64-174"><a href="#cb64-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-175"><a href="#cb64-175" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parallelization and Random Number Generation</span></span>
<span id="cb64-176"><a href="#cb64-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-177"><a href="#cb64-177" aria-hidden="true" tabindex="-1"></a>A tale of the good, the bad, and the ugly</span>
<span id="cb64-178"><a href="#cb64-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-179"><a href="#cb64-179" aria-hidden="true" tabindex="-1"></a>Random numbers on a computer are <span class="co">[</span><span class="ot">not truly random</span><span class="co">](http://dilbert.com/strips/comic/2001-10-25)</span> but are generated as a sequence of pseudo-random numbers. The sequence is finite (but very, very, very, very long) and eventally repeats itself. </span>
<span id="cb64-180"><a href="#cb64-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-181"><a href="#cb64-181" aria-hidden="true" tabindex="-1"></a>A random number seed determines where in the sequence one starts when generating random numbers.</span>
<span id="cb64-182"><a href="#cb64-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-183"><a href="#cb64-183" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The ugly: Make sure you do not use the same seed for each task</span>
<span id="cb64-184"><a href="#cb64-184" aria-hidden="true" tabindex="-1"></a>  <span class="in">```{r}</span></span>
<span id="cb64-185"><a href="#cb64-185" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(1)</span></span>
<span id="cb64-186"><a href="#cb64-186" aria-hidden="true" tabindex="-1"></a><span class="in">  rnorm(5)</span></span>
<span id="cb64-187"><a href="#cb64-187" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(1)</span></span>
<span id="cb64-188"><a href="#cb64-188" aria-hidden="true" tabindex="-1"></a><span class="in">  rnorm(5)</span></span>
<span id="cb64-189"><a href="#cb64-189" aria-hidden="true" tabindex="-1"></a><span class="in">  ```</span></span>
<span id="cb64-190"><a href="#cb64-190" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The (not so) bad: Use a different seed for each task or each process. It's possible the subsequences will overlap but quite unlikely.</span>
<span id="cb64-191"><a href="#cb64-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-192"><a href="#cb64-192" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The good: Use the L'Ecuyer algorithm to ensure distinct subsequences in each worker, which <span class="in">`future`</span> makes easy:</span>
<span id="cb64-193"><a href="#cb64-193" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>with <span class="in">`future.apply`</span>, use <span class="in">`future.seed = TRUE`</span>.</span>
<span id="cb64-194"><a href="#cb64-194" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>with <span class="in">`foreach`</span> and <span class="in">`%dofuture%`</span>, include <span class="in">`.options.future = list(seed = TRUE)`</span>.</span>
<span id="cb64-195"><a href="#cb64-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-196"><a href="#cb64-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-197"><a href="#cb64-197" aria-hidden="true" tabindex="-1"></a><span class="fu"># Rcpp</span></span>
<span id="cb64-198"><a href="#cb64-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-199"><a href="#cb64-199" aria-hidden="true" tabindex="-1"></a>While R can interface with lots of other languages, the most fundamental is to interface with C/C++. In part this is because the R interpreter is a C program and under the hood, R data structures are C structs. In part this is because of the success of Rcpp as a wrapper that makes it easy to interface to C++ (including C) code.</span>
<span id="cb64-200"><a href="#cb64-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-201"><a href="#cb64-201" aria-hidden="true" tabindex="-1"></a>Some comments:</span>
<span id="cb64-202"><a href="#cb64-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-203"><a href="#cb64-203" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Rcpp has a nice interface that makes it easy to work with R data structures in C++ and use various functions similar to those provided in R.</span>
<span id="cb64-204"><a href="#cb64-204" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Loops and recursion in C++ are fast, unlike in R.</span>
<span id="cb64-205"><a href="#cb64-205" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Rcpp allows you to make use of various libraries available in C/C++, such as the standard template library (STL), Eigen (for linear algebra), and many others.</span>
<span id="cb64-206"><a href="#cb64-206" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>Often one will write most of one's code in R and off-load the core, slow computational parts to C++, managed from R.</span>
<span id="cb64-207"><a href="#cb64-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-208"><a href="#cb64-208" aria-hidden="true" tabindex="-1"></a>Some good overviews of Rcpp are:</span>
<span id="cb64-209"><a href="#cb64-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-210"><a href="#cb64-210" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span><span class="co">[</span><span class="ot">The Advanced R book by Hadley Wickham</span><span class="co">](https://adv-r.hadley.nz/rcpp.html)</span></span>
<span id="cb64-211"><a href="#cb64-211" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span><span class="co">[</span><span class="ot">The Rcpp vignette</span><span class="co">](https://cran.r-project.org/web/packages/Rcpp/vignettes/Rcpp-introduction.pdf)</span></span>
<span id="cb64-212"><a href="#cb64-212" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span><span class="co">[</span><span class="ot">Rcpp tutorial from 2019</span><span class="co">](https://dirk.eddelbuettel.com/papers/useR2019_rcpp_tutorial.pdf)</span></span>
<span id="cb64-213"><a href="#cb64-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-214"><a href="#cb64-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-215"><a href="#cb64-215" aria-hidden="true" tabindex="-1"></a><span class="fu">## Rcpp: compilation</span></span>
<span id="cb64-216"><a href="#cb64-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-217"><a href="#cb64-217" aria-hidden="true" tabindex="-1"></a>Behind the scenes, the first step in using a C++ function is that the C++ code is compiled to machine (binary) code that can be called from R.</span>
<span id="cb64-218"><a href="#cb64-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-219"><a href="#cb64-219" aria-hidden="true" tabindex="-1"></a>To use Rcpp, you'll need a C++ compiler:</span>
<span id="cb64-220"><a href="#cb64-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-221"><a href="#cb64-221" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>for Windows: install <span class="in">`rtools`</span></span>
<span id="cb64-222"><a href="#cb64-222" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>for MacOS: install <span class="in">`xcode`</span></span>
<span id="cb64-223"><a href="#cb64-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-224"><a href="#cb64-224" aria-hidden="true" tabindex="-1"></a>Here's a test that your compiler works from R:</span>
<span id="cb64-225"><a href="#cb64-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-228"><a href="#cb64-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-229"><a href="#cb64-229" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"Rcpp"</span>)</span>
<span id="cb64-230"><a href="#cb64-230" aria-hidden="true" tabindex="-1"></a><span class="fu">evalCpp</span>(<span class="st">"2 + 2"</span>)</span>
<span id="cb64-231"><a href="#cb64-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-232"><a href="#cb64-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-233"><a href="#cb64-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-234"><a href="#cb64-234" aria-hidden="true" tabindex="-1"></a><span class="fu">## Basic example</span></span>
<span id="cb64-235"><a href="#cb64-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-236"><a href="#cb64-236" aria-hidden="true" tabindex="-1"></a>Here's a basic example of using C++ code via Rcpp from the Advanced R book.</span>
<span id="cb64-237"><a href="#cb64-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-240"><a href="#cb64-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-241"><a href="#cb64-241" aria-hidden="true" tabindex="-1"></a><span class="fu">cppFunction</span>(<span class="st">'int add3(int x, int y, int z) {</span></span>
<span id="cb64-242"><a href="#cb64-242" aria-hidden="true" tabindex="-1"></a><span class="st">  int sum = x + y + z;</span></span>
<span id="cb64-243"><a href="#cb64-243" aria-hidden="true" tabindex="-1"></a><span class="st">  return sum;</span></span>
<span id="cb64-244"><a href="#cb64-244" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span>)</span>
<span id="cb64-245"><a href="#cb64-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-246"><a href="#cb64-246" aria-hidden="true" tabindex="-1"></a><span class="do">## The pause is because the C++ code has to be compiled.</span></span>
<span id="cb64-247"><a href="#cb64-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-248"><a href="#cb64-248" aria-hidden="true" tabindex="-1"></a>add3</span>
<span id="cb64-249"><a href="#cb64-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-250"><a href="#cb64-250" aria-hidden="true" tabindex="-1"></a><span class="fu">add3</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>)</span>
<span id="cb64-251"><a href="#cb64-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-252"><a href="#cb64-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-253"><a href="#cb64-253" aria-hidden="true" tabindex="-1"></a>Note that some casting/coercing of types by Rcpp must be happening:</span>
<span id="cb64-254"><a href="#cb64-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-257"><a href="#cb64-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-258"><a href="#cb64-258" aria-hidden="true" tabindex="-1"></a><span class="fu">add3</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb64-259"><a href="#cb64-259" aria-hidden="true" tabindex="-1"></a><span class="fu">add3</span>(<span class="dv">1</span>L, <span class="dv">2</span>L, <span class="dv">3</span>L)</span>
<span id="cb64-260"><a href="#cb64-260" aria-hidden="true" tabindex="-1"></a><span class="fu">add3</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="fl">3.7</span>)</span>
<span id="cb64-261"><a href="#cb64-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-262"><a href="#cb64-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-263"><a href="#cb64-263" aria-hidden="true" tabindex="-1"></a>Notice we need to include the types of variables, since C++ is statically typed (in large part this is why it is much faster than R).</span>
<span id="cb64-264"><a href="#cb64-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-265"><a href="#cb64-265" aria-hidden="true" tabindex="-1"></a><span class="fu">## A short but rich example: loop fusion</span></span>
<span id="cb64-266"><a href="#cb64-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-267"><a href="#cb64-267" aria-hidden="true" tabindex="-1"></a>Consider this vectorized code.</span>
<span id="cb64-268"><a href="#cb64-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-271"><a href="#cb64-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-272"><a href="#cb64-272" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb64-273"><a href="#cb64-273" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">exp</span>(x) <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">sin</span>(x)</span>
<span id="cb64-274"><a href="#cb64-274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-275"><a href="#cb64-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-276"><a href="#cb64-276" aria-hidden="true" tabindex="-1"></a>Because it's vectorized, it avoids the R overhead involved in looping, with the individual calculations (<span class="in">`exp`</span>, <span class="in">`+`</span>, <span class="in">`*`</span>, and <span class="in">`sin`</span>) done in for loops in compiled C code.</span>
<span id="cb64-277"><a href="#cb64-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-278"><a href="#cb64-278" aria-hidden="true" tabindex="-1"></a>However, it has a subtle disadvantage compared to this for loop version:</span>
<span id="cb64-279"><a href="#cb64-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-282"><a href="#cb64-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-283"><a href="#cb64-283" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb64-284"><a href="#cb64-284" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb64-285"><a href="#cb64-285" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb64-286"><a href="#cb64-286" aria-hidden="true" tabindex="-1"></a>   x[i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(x[i]) <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fu">sin</span>(x[i])</span>
<span id="cb64-287"><a href="#cb64-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-288"><a href="#cb64-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-289"><a href="#cb64-289" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Question"}</span>
<span id="cb64-290"><a href="#cb64-290" aria-hidden="true" tabindex="-1"></a>What has to happen in the vectorized code that doesn't happen in the for loop?</span>
<span id="cb64-291"><a href="#cb64-291" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb64-292"><a href="#cb64-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-293"><a href="#cb64-293" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Answer" collapse="true"}</span>
<span id="cb64-294"><a href="#cb64-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-295"><a href="#cb64-295" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The individual operations are done as separate vectorized calls to compiled C code.</span>
<span id="cb64-296"><a href="#cb64-296" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Temporary vectors must be allocated and filled to store the results of <span class="in">`exp`</span>, <span class="in">`sin`</span>, <span class="in">`*`</span> and <span class="in">`+`</span>.</span>
<span id="cb64-297"><a href="#cb64-297" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Extra memory needed.</span>
<span id="cb64-298"><a href="#cb64-298" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Time for allocation and moving values.</span>
<span id="cb64-299"><a href="#cb64-299" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The result <span class="in">`x`</span> and the input <span class="in">`x`</span> both need to exist at one time, briefly.</span>
<span id="cb64-300"><a href="#cb64-300" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb64-301"><a href="#cb64-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-302"><a href="#cb64-302" aria-hidden="true" tabindex="-1"></a>None of that needs to happen with the loop version.</span>
<span id="cb64-303"><a href="#cb64-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-304"><a href="#cb64-304" aria-hidden="true" tabindex="-1"></a><span class="fu">## Loop fusion using Rcpp</span></span>
<span id="cb64-305"><a href="#cb64-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-306"><a href="#cb64-306" aria-hidden="true" tabindex="-1"></a>We can write up the for loop version using Rcpp to get the benefits of loop fusion.</span>
<span id="cb64-307"><a href="#cb64-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-310"><a href="#cb64-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-311"><a href="#cb64-311" aria-hidden="true" tabindex="-1"></a><span class="fu">cppFunction</span>(<span class="st">'void fuse(Rcpp::NumericVector x) {</span></span>
<span id="cb64-312"><a href="#cb64-312" aria-hidden="true" tabindex="-1"></a><span class="st">  int n = x.size();</span></span>
<span id="cb64-313"><a href="#cb64-313" aria-hidden="true" tabindex="-1"></a><span class="st">  Rcpp::Rcout &lt;&lt; "Working with a vector of length " &lt;&lt; n &lt;&lt; "." &lt;&lt; std::endl;</span></span>
<span id="cb64-314"><a href="#cb64-314" aria-hidden="true" tabindex="-1"></a><span class="st">  for(int i = 0; i &lt; n; ++i) {</span></span>
<span id="cb64-315"><a href="#cb64-315" aria-hidden="true" tabindex="-1"></a><span class="st">    x[i] = exp(x[i]) + 3 * sin(x[i]);</span></span>
<span id="cb64-316"><a href="#cb64-316" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb64-317"><a href="#cb64-317" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span>)</span>
<span id="cb64-318"><a href="#cb64-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-319"><a href="#cb64-319" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e7</span></span>
<span id="cb64-320"><a href="#cb64-320" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb64-321"><a href="#cb64-321" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> x</span>
<span id="cb64-322"><a href="#cb64-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-323"><a href="#cb64-323" aria-hidden="true" tabindex="-1"></a>rbenchmark<span class="sc">::</span><span class="fu">benchmark</span>(</span>
<span id="cb64-324"><a href="#cb64-324" aria-hidden="true" tabindex="-1"></a> x <span class="ot">&lt;-</span> <span class="fu">exp</span>(x) <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span><span class="fu">sin</span>(x),</span>
<span id="cb64-325"><a href="#cb64-325" aria-hidden="true" tabindex="-1"></a> <span class="fu">fuse</span>(y),</span>
<span id="cb64-326"><a href="#cb64-326" aria-hidden="true" tabindex="-1"></a> <span class="at">replications =</span> <span class="dv">1</span>,  <span class="co"># 'x' could explode on repeated calls</span></span>
<span id="cb64-327"><a href="#cb64-327" aria-hidden="true" tabindex="-1"></a> <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">'test'</span>, <span class="st">'replications'</span>, <span class="st">'elapsed'</span>))</span>
<span id="cb64-328"><a href="#cb64-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-329"><a href="#cb64-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-330"><a href="#cb64-330" aria-hidden="true" tabindex="-1"></a>When using Rcpp's built-in vector types, Rcpp reuses R memory so no copies of the inputs are made.</span>
<span id="cb64-331"><a href="#cb64-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-332"><a href="#cb64-332" aria-hidden="true" tabindex="-1"></a>We could also have created a version that doesn't overwrite the input.</span>
<span id="cb64-333"><a href="#cb64-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-336"><a href="#cb64-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-337"><a href="#cb64-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb64-338"><a href="#cb64-338" aria-hidden="true" tabindex="-1"></a><span class="fu">cppFunction</span>(<span class="st">'NumericVector fuse(NumericVector x) {</span></span>
<span id="cb64-339"><a href="#cb64-339" aria-hidden="true" tabindex="-1"></a><span class="st">  int n = x.size();</span></span>
<span id="cb64-340"><a href="#cb64-340" aria-hidden="true" tabindex="-1"></a><span class="st">  NumericVector result(n);</span></span>
<span id="cb64-341"><a href="#cb64-341" aria-hidden="true" tabindex="-1"></a><span class="st">  for(int i = 0; i &lt; n; ++i) {</span></span>
<span id="cb64-342"><a href="#cb64-342" aria-hidden="true" tabindex="-1"></a><span class="st">    result[i] = exp(x[i]) + 3 * sin(x[i]);</span></span>
<span id="cb64-343"><a href="#cb64-343" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb64-344"><a href="#cb64-344" aria-hidden="true" tabindex="-1"></a><span class="st">  return result;</span></span>
<span id="cb64-345"><a href="#cb64-345" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span>)</span>
<span id="cb64-346"><a href="#cb64-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-347"><a href="#cb64-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-348"><a href="#cb64-348" aria-hidden="true" tabindex="-1"></a><span class="fu">## Rcpp source code files</span></span>
<span id="cb64-349"><a href="#cb64-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-350"><a href="#cb64-350" aria-hidden="true" tabindex="-1"></a>Except for quick-and-dirty work, we'd generally want the Rcpp C++ code in a code file that can be recognized by editors as C++ code rather than in quotations in R. This will also help with debugging.</span>
<span id="cb64-351"><a href="#cb64-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-352"><a href="#cb64-352" aria-hidden="true" tabindex="-1"></a>See <span class="co">[</span><span class="ot">fuse.cpp</span><span class="co">](fuse.cpp)</span> for the code for the version that does not overwrite the input.</span>
<span id="cb64-353"><a href="#cb64-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-356"><a href="#cb64-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb64-357"><a href="#cb64-357" aria-hidden="true" tabindex="-1"></a><span class="fu">sourceCpp</span>(<span class="st">'fuse.cpp'</span>)</span>
<span id="cb64-358"><a href="#cb64-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-359"><a href="#cb64-359" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb64-360"><a href="#cb64-360" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">fuse</span>(x)</span>
<span id="cb64-361"><a href="#cb64-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-362"><a href="#cb64-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-363"><a href="#cb64-363" aria-hidden="true" tabindex="-1"></a><span class="fu">## Some notes about memory and argument passing</span></span>
<span id="cb64-364"><a href="#cb64-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-365"><a href="#cb64-365" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Copy-on-change doesn't work with Rcpp functions. </span>
<span id="cb64-366"><a href="#cb64-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-367"><a href="#cb64-367" aria-hidden="true" tabindex="-1"></a>   <span class="in">```{r}</span></span>
<span id="cb64-368"><a href="#cb64-368" aria-hidden="true" tabindex="-1"></a><span class="in">   n &lt;- 5</span></span>
<span id="cb64-369"><a href="#cb64-369" aria-hidden="true" tabindex="-1"></a><span class="in">   x &lt;- rnorm(n)</span></span>
<span id="cb64-370"><a href="#cb64-370" aria-hidden="true" tabindex="-1"></a><span class="in">   y &lt;- x</span></span>
<span id="cb64-371"><a href="#cb64-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-372"><a href="#cb64-372" aria-hidden="true" tabindex="-1"></a><span class="in">   fuse(y)</span></span>
<span id="cb64-373"><a href="#cb64-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-374"><a href="#cb64-374" aria-hidden="true" tabindex="-1"></a><span class="in">   y</span></span>
<span id="cb64-375"><a href="#cb64-375" aria-hidden="true" tabindex="-1"></a><span class="in">   x</span></span>
<span id="cb64-376"><a href="#cb64-376" aria-hidden="true" tabindex="-1"></a><span class="in">   ```</span></span>
<span id="cb64-377"><a href="#cb64-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-378"><a href="#cb64-378" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Type conversion can prevent modification</span>
<span id="cb64-379"><a href="#cb64-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-380"><a href="#cb64-380" aria-hidden="true" tabindex="-1"></a>   <span class="in">```{r}</span></span>
<span id="cb64-381"><a href="#cb64-381" aria-hidden="true" tabindex="-1"></a><span class="in">   x &lt;- 1:5</span></span>
<span id="cb64-382"><a href="#cb64-382" aria-hidden="true" tabindex="-1"></a><span class="in">   typeof(x)</span></span>
<span id="cb64-383"><a href="#cb64-383" aria-hidden="true" tabindex="-1"></a><span class="in">   fuse(x)</span></span>
<span id="cb64-384"><a href="#cb64-384" aria-hidden="true" tabindex="-1"></a><span class="in">   x</span></span>
<span id="cb64-385"><a href="#cb64-385" aria-hidden="true" tabindex="-1"></a><span class="in">   ```</span></span>
<span id="cb64-386"><a href="#cb64-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-387"><a href="#cb64-387" aria-hidden="true" tabindex="-1"></a>The <span class="in">`NumericVector`</span> type can only make use of R memory for the input if the input R object is a numeric vector; above it is an integer vector, so a cast needs to be made with values copied to a new object in C++. </span>
<span id="cb64-388"><a href="#cb64-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-389"><a href="#cb64-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-390"><a href="#cb64-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-391"><a href="#cb64-391" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using R classes in C++</span></span>
<span id="cb64-392"><a href="#cb64-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-393"><a href="#cb64-393" aria-hidden="true" tabindex="-1"></a>Rcpp provides classes that correspond to most R data structures/classes. We've already seen the use of <span class="in">`NumericVector`</span> for R's numeric vector.</span>
<span id="cb64-394"><a href="#cb64-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-395"><a href="#cb64-395" aria-hidden="true" tabindex="-1"></a>Here's an example (from the Advanced R book) of working with a list (in this case an <span class="in">`lm`</span> S3 object) and manipulating its components in C++. We need to cast the vector components as <span class="in">`NumericVector`</span>s</span>
<span id="cb64-396"><a href="#cb64-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-399"><a href="#cb64-399" aria-hidden="true" tabindex="-1"></a><span class="in">```{cpp}</span></span>
<span id="cb64-400"><a href="#cb64-400" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb64-401"><a href="#cb64-401" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb64-402"><a href="#cb64-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-403"><a href="#cb64-403" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb64-404"><a href="#cb64-404" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> mpe<span class="op">(</span>List mod<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-405"><a href="#cb64-405" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>mod<span class="op">.</span>inherits<span class="op">(</span><span class="st">"lm"</span><span class="op">))</span> stop<span class="op">(</span><span class="st">"Input must be a linear model"</span><span class="op">);</span></span>
<span id="cb64-406"><a href="#cb64-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-407"><a href="#cb64-407" aria-hidden="true" tabindex="-1"></a>  NumericVector resid <span class="op">=</span> as<span class="op">&lt;</span>NumericVector<span class="op">&gt;(</span>mod<span class="op">[</span><span class="st">"residuals"</span><span class="op">]);</span></span>
<span id="cb64-408"><a href="#cb64-408" aria-hidden="true" tabindex="-1"></a>  NumericVector fitted <span class="op">=</span> as<span class="op">&lt;</span>NumericVector<span class="op">&gt;(</span>mod<span class="op">[</span><span class="st">"fitted.values"</span><span class="op">]);</span></span>
<span id="cb64-409"><a href="#cb64-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-410"><a href="#cb64-410" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> resid<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb64-411"><a href="#cb64-411" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> err <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb64-412"><a href="#cb64-412" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-413"><a href="#cb64-413" aria-hidden="true" tabindex="-1"></a>    err <span class="op">+=</span> resid<span class="op">[</span>i<span class="op">]</span> <span class="op">/</span> <span class="op">(</span>fitted<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> resid<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb64-414"><a href="#cb64-414" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb64-415"><a href="#cb64-415" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> err <span class="op">/</span> n<span class="op">;</span></span>
<span id="cb64-416"><a href="#cb64-416" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-417"><a href="#cb64-417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb64-418"><a href="#cb64-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-419"><a href="#cb64-419" aria-hidden="true" tabindex="-1"></a><span class="fu">## Rcpp "sugar"</span></span>
<span id="cb64-420"><a href="#cb64-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-421"><a href="#cb64-421" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">*Rcpp Sugar*</span><span class="co">](https://cran.r-project.org/web/packages/Rcpp/vignettes/Rcpp-sugar.pdf)</span> provides additional functionality to make it easier to write C++ code in an R-like way.</span>
<span id="cb64-422"><a href="#cb64-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-423"><a href="#cb64-423" aria-hidden="true" tabindex="-1"></a>This includes:</span>
<span id="cb64-424"><a href="#cb64-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-425"><a href="#cb64-425" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Calling functions from R's C math library, e.g., <span class="in">`Rcpp::rnorm(10, 3, 0.5)`</span></span>
<span id="cb64-426"><a href="#cb64-426" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Various functions that mimic standard R functions (e.g., <span class="in">`all`</span>, <span class="in">`is_na`</span>)</span>
<span id="cb64-427"><a href="#cb64-427" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Using R's random number generation</span>
<span id="cb64-428"><a href="#cb64-428" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Vectorized calls (for code clarity, not for speed!)</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>